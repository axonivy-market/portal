name: Portal Selenium Test
run-name: 🖼️ Portal Selenium Test
on:
  workflow_dispatch:
    inputs:
      testPatternToRun:
        description: 'Test pattern to run'
        type: string
        default: 'com.axonivy.portal.selenium.test.**.*Test'
        required: true
      engineDownloadURL:
        description: |
          url to download engine
          Where to download engine? e.g.
            -Divy.engine.download.url=https://developer.axonivy.com/permalink/nightly-12/axonivy-engine-windows.zip for nightly 12
            -Divy.engine.download.url=file:///C:/wawa/engine/AxonIvyEngineX.X.X.X_Windows_x64.zip for downloaded engine
            -Divy.engine.list.url=https://jenkins.ivyteam.io/job/core_product/job/release%252F9.4/lastSuccessfulBuild/artifact/workspace/ch.ivyteam.ivy.server.product/target/products/ -Divy.engine.os.arch=Windows_x64 for last successful build 9.4
        type: string
        default: 'https://developer.axonivy.com/permalink/nightly-12.0/axonivy-engine-windows.zip'
        required: true
  push:
    branches:
      - feature/IVYPORTAL-18260-Create-Github-workflow-for-selenium-test-12

env:
  ENGINE_DIR: $GITHUB_WORKSPACE/ivy/engine
  ENGINE_URL: https://developer.axonivy.com/permalink/nightly-12/axonivy-engine.zip
  TEST_PATTERN_TO_RUN: com.axonivy.portal.selenium.test.AnnouncementTest,com.axonivy.portal.selenium.test.dashboard.DashboardCaseWidgetFilterTest
  
jobs:

  workflow-runs-history :
    runs-on: ubuntu-latest
    steps:
      - name: Show workflow-runs-history
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref;
            const ONE_DAY_MS = 24 * 60 * 60 * 1000;
            const cutoffTime = new Date(Date.now() - ONE_DAY_MS);
            const prs = await github.paginate(
              github.rest.actions.listWorkflowRuns,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'portal-selenium-test.yml',
              }
            );

            console.log(prs);

  pull-request-merged:
    runs-on: ubuntu-latest
    steps:
      - name: Show PRs merged into this branch in the last 24 hours
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref;
            const ONE_DAY_MS = 24 * 60 * 60 * 1000;
            const cutoffTime = new Date(Date.now() - ONE_DAY_MS);
            const prs = await github.paginate(
              github.rest.pulls.list,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: branch,
                state: 'closed',
                pages: 1,
                per_page: 10,
              }
            );

            const mergedToday = prs.filter(pr =>
              pr.merged_at && new Date(pr.merged_at) > cutoffTime
            );

            if (mergedToday.length === 0) {
              await core.summary
                .addHeading(`🔀 No PRs merged into '${branch}' in the last 24 hours`)
                .write();
              return;
            }

            const list = mergedToday.map(pr =>
              `- [#${pr.number}](${pr.html_url}) ${pr.title} by @${pr.user.login}`
            ).join('\n');

            await core.summary
              .addHeading(`🔀 PRs merged into '${branch}' in the last 24 hours`)
              .addRaw(list, true)
              .write();

