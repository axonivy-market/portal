name: Portal Selenium Test
run-name: ðŸ”† Portal Selenium Test
permissions: read-all
on:
  workflow_dispatch:
    inputs:
      testPatternToRun:
        description: 'Test pattern to run'
        type: string
        default: 'com.axonivy.portal.selenium.test.**.*Test'
        required: true
      engineDownloadURL:
        description: |
          url to download engine, default is the nightly build.
        type: string
        default: 'https://developer.axonivy.com/permalink/nightly/axonivy-engine.zip'
        required: true

env:
  ENGINE_DIR: $GITHUB_WORKSPACE/ivy/engine
  ENGINE_URL: https://developer.axonivy.com/permalink/nightly/axonivy-engine.zip

jobs:
  show-branch-info:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 20  # Fetch more commits for history

      - name: Show commits since last successful build
        uses: actions/github-script@v8
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const workflowName = 'Portal Selenium Test';
            
            try {
              // Get the last successful workflow run for this branch
              const { data: workflowRuns } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'portal-selenium-test.yml',
                branch: branch,
                status: 'success',
                per_page: 1
              });

              let lastSuccessfulSha = null;
              let lastSuccessfulDate = null;
              
              if (workflowRuns.workflow_runs && workflowRuns.workflow_runs.length > 0) {
                const lastRun = workflowRuns.workflow_runs[0];
                lastSuccessfulSha = lastRun.head_sha;
                lastSuccessfulDate = lastRun.created_at;
              }

              let commits = [];
              let comparisonInfo = '';
              
              if (lastSuccessfulSha && lastSuccessfulSha !== context.sha) {
                // Compare commits between last successful build and current commit
                try {
                  const { data: comparison } = await github.rest.repos.compareCommits({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    base: lastSuccessfulSha,
                    head: context.sha
                  });
                  commits = comparison.commits || [];
                  
                  const lastSuccessfulDateFormatted = new Date(lastSuccessfulDate).toLocaleString('vi-VN', {
                    timeZone: 'Asia/Ho_Chi_Minh',
                    hour12: false
                  });
                  
                  comparisonInfo = `ðŸ“Š Comparing with last successful build: [${lastSuccessfulSha.substring(0, 7)}](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${lastSuccessfulSha}) (${lastSuccessfulDateFormatted})`;
                } catch (compareError) {
                  console.log('Could not compare with last successful build, showing recent commits instead');
                  const { data: recentCommits } = await github.rest.repos.listCommits({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    sha: context.sha,
                    per_page: 10
                  });
                  commits = recentCommits;
                  comparisonInfo = 'âš ï¸ Could not compare with last build, showing recent commits';
                }
              } else if (lastSuccessfulSha === context.sha) {
                comparisonInfo = 'âœ… This commit was the last successful build - no new changes';
              } else {
                // No previous successful build found, show recent commits
                const { data: recentCommits } = await github.rest.repos.listCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: context.sha,
                  per_page: 10
                });
                commits = recentCommits;
                comparisonInfo = 'ðŸ†• No previous successful build found - showing recent commits';
              }

              // Build the summary
              if (!commits || commits.length === 0) {
                await core.summary
                  .addHeading(`ðŸ“ Changes since last successful build on '${branch}'`)
                  .addRaw(comparisonInfo)
                  .addRaw('\n\n*No new commits found*')
                  .write();
                return;
              }

              const commitCount = commits.length;
              const maxDisplay = Math.min(commitCount, 15);
              
              await core.summary
                .addHeading(`ðŸ“ Changes since last successful build on '${branch}' (${commitCount} commit${commitCount !== 1 ? 's' : ''})`)
                .addRaw(comparisonInfo)
                .addTable([
                  [
                    { data: 'Commit', header: true },
                    { data: 'Message', header: true },
                    { data: 'Author', header: true },
                    { data: 'Date', header: true }
                  ],
                  ...commits.slice(0, maxDisplay).map(commit => [
                    `[${commit.sha.substring(0, 7)}](${commit.html_url})`,
                    commit.commit.message.split('\n')[0].replace(/\|/g, '\\|'),
                    `@${commit.author?.login || commit.commit.author.name}`,
                    new Date(commit.commit.author.date).toLocaleString('vi-VN', {
                      timeZone: 'Asia/Ho_Chi_Minh',
                      hour12: false
                    })
                  ])
                ])
                .write();
                
              if (commitCount > maxDisplay) {
                await core.summary
                  .addRaw(`\n*... and ${commitCount - maxDisplay} more commit${commitCount - maxDisplay !== 1 ? 's' : ''}*`)
                  .write();
              }
              
            } catch (error) {
              console.error('Error fetching commits since last build:', error);
              await core.summary
                .addHeading(`ðŸ“ Error fetching commits for branch '${branch}'`)
                .addRaw(`Could not retrieve commit information: ${error.message}`)
                .write();
            }

      - name: Show PRs merged into this branch
        uses: actions/github-script@v8
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: branch,
              state: 'closed',
              per_page: 50,
              page: 1
            });

            const mergedPrs = prs
              .filter(pr => pr.merged_at !== null)
              .sort((a, b) => new Date(b.merged_at) - new Date(a.merged_at))
              .slice(0, 10);

            if (!prs || prs.length === 0) {
              await core.summary
                .addHeading(`ðŸ”— No PRs merged into '${branch}'`)
                .write();
              return;
            }

            await core.summary
              .addHeading(`ðŸ”— PRs merged into '${branch}' (maximum: 10)`)
              .addTable([
                [
                  { data: 'PR Number', header: true },
                  { data: 'Title', header: true },
                  { data: 'Author', header: true },
                  { data: 'Merged At', header: true }
                ],
                ...mergedPrs.map(pr => [
                  `[${pr.number}](${pr.html_url})`,
                  pr.title.replace(/\|/g, '\\|'),
                  `@${pr.user.login}`,
                  new Date(pr.merged_at).toLocaleString('vi-VN', {
                    timeZone: 'Asia/Ho_Chi_Minh',
                    hour12: false
                  })
                ])
              ])
              .write();


  portal-selenium-test:
      runs-on: ubuntu-latest
      needs: show-branch-info
      steps:
        - name: Checkout code
          uses: actions/checkout@v5

        - name: Set up Java
          uses: actions/setup-java@v5
          with:
            distribution: 'temurin'
            java-version: '21'

        - name: Set up Maven
          uses: stCarolas/setup-maven@v5
          with:
            maven-version: 3.9.8
      
        - name: Export environment variables
          run: |
            echo "export IVY_JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
            echo "export JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
            echo "export PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
            
        - name: Set up and verify directories
          run: |
            ENGINE_DIR="${GITHUB_WORKSPACE}/ivy/engine/nightly"
            mkdir -p $ENGINE_DIR
            sudo chown -R $USER:$USER $ENGINE_DIR
            echo "ENGINE_DIR=$ENGINE_DIR" >> $GITHUB_ENV

        - name: Download engine
          run: |
            cd $ENGINE_DIR
            wget $ENGINE_URL -O axonivy-engine.zip
            unzip -o axonivy-engine.zip -d .
            rm axonivy-engine.zip

        - name: Verify engine directory
          run: |
            if [ ! -d "$ENGINE_DIR" ]; then
              echo "Engine directory does not exist"
              exit 1
            fi

        - name: Build Portal modules
          run: |
            modules=(
              "AxonIvyPortal/portal-components"
              "AxonIvyPortal/portal"
              "AxonIvyPortal/PortalKitTestHelper"
              "Showcase/portal-user-examples"
              "Showcase/portal-developer-examples"
              "Showcase/InternalSupport"
              "Showcase/portal-components-examples"
              "AxonIvyPortal/PortalApp"
              "Showcase/portal-demo-app"
            )
            for module in "${modules[@]}"; do
              mvn clean install -f $module/pom.xml -Divy.engine.directory=$ENGINE_DIR
            done

        - name: Deploy Portal Modules
          run: |
            DEPLOYMENT=$ENGINE_DIR/system/demo-applications/demo-portal
            rm -rf $DEPLOYMENT/*
            cp Showcase/portal-demo-app/target/*.zip $DEPLOYMENT
            cp Showcase/portal-developer-examples/target/*.iar $DEPLOYMENT
            cp Showcase/portal-components-examples/target/*.iar $DEPLOYMENT
      
        - name: Run test
          id: run-test        
          run: |
            mvn clean test -f AxonIvyPortal/portal-selenium-test/customized_pom.xml -Divy.engine.download.url=${{ inputs.engineDownloadURL }} -Dtest=${{ inputs.testPatternToRun }} -DbrowserType=FIREFOX -DtrimStackTrace=false -Divy.engine.directory=$ENGINE_DIR -Divy.deploy.timeout.seconds=60 -Divy.engine.start.timeout.seconds=500 -Dsurefire.rerunFailingTestsCount=2
          continue-on-error: true

        - name: Log out on failures
          if: steps.run-test.outcome == 'failure'
          run: |
            cat AxonIvyPortal/portal-selenium-test/target/testEngineOut.log 

        - name: Archive screenshot image
          uses: actions/upload-artifact@v4
          with:
            name: screenshots
            retention-days: 5
            path: |
              AxonIvyPortal/portal-selenium-test/target/selenide/reports/*

        - name: Archive test reports
          uses: actions/upload-artifact@v4
          with:
            name: selenium-test-reports
            retention-days: 5
            path: |
              AxonIvyPortal/portal-selenium-test/target/surefire-reports/*

        - name: Show inputs
          run: |
            echo "## Inputs" >> $GITHUB_STEP_SUMMARY
            echo "- Test pattern: ${{inputs.testPatternToRun}}" >> $GITHUB_STEP_SUMMARY
            echo "- Engine download url: ${{inputs.engineDownloadURL}}" >> $GITHUB_STEP_SUMMARY
        
        - name: Report
          uses: dorny/test-reporter@v2.1.1
          with:
            artifact: selenium-test-reports
            name: Selenium tests
            path: '*.xml'
            reporter: java-junit
            only-summary: 'false'
