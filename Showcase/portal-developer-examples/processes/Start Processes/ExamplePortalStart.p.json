{
  "format" : "10.0.0",
  "id" : "164211E97C598DAA",
  "config" : {
    "data" : "ch.ivy.addon.portal.generic.PortalStartData"
  },
  "elements" : [ {
      "id" : "f144",
      "type" : "RequestStart",
      "name" : "showCaseNoteHistory.ivp",
      "config" : {
        "callSignature" : "showCaseNoteHistory",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" }
          ],
          "map" : {
            "out.caseId" : "param.caseId"
          }
        },
        "outLink" : "showCaseNoteHistory.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 896, "y" : 1728 }
      },
      "connect" : { "id" : "f145", "to" : "f143" }
    }, {
      "id" : "f134",
      "type" : "DialogCall",
      "name" : "ProcessInformation",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.component.ProcessInformation",
        "startMethod" : "start(String)",
        "call" : {
          "params" : [
            { "name" : "processId", "type" : "String" }
          ],
          "map" : {
            "param.processId" : "in.processId"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 248, "y" : 2304 }
      },
      "connect" : { "id" : "f136", "to" : "f133" }
    }, {
      "id" : "f10",
      "type" : "RequestStart",
      "name" : "DefaultEndPage.ivp",
      "config" : {
        "callSignature" : "DefaultEndPage",
        "input" : {
          "params" : [
            { "name" : "endedTaskId", "type" : "Number" }
          ],
          "map" : {
            "out.endedTaskId" : "param.endedTaskId"
          }
        },
        "outLink" : "DefaultEndPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 305 },
        "labelOffset" : { "x" : 16, "y" : 37 }
      },
      "connect" : { "id" : "f7", "to" : "f4" }
    }, {
      "id" : "f62",
      "type" : "RequestStart",
      "name" : "TaskDetailsPage.ivp",
      "config" : {
        "callSignature" : "TaskDetailsPage",
        "input" : {
          "params" : [
            { "name" : "selectedTaskId", "type" : "Long" }
          ],
          "map" : {
            "out.selectedTaskId" : "param.selectedTaskId"
          }
        },
        "outLink" : "TaskDetailsPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1056 },
        "labelOffset" : { "x" : 7, "y" : 37 }
      },
      "connect" : { "id" : "f66", "to" : "f65" }
    }, {
      "id" : "f80",
      "type" : "Script",
      "name" : " Redirect to task start",
      "config" : {
        "output" : {
          "code" : "ch.ivy.addon.portalkit.util.RequestUtils.redirect(in.callbackUrl);"
        }
      },
      "visual" : {
        "at" : { "x" : 680, "y" : 1632 },
        "size" : { "width" : 128, "height" : 60 }
      }
    }, {
      "id" : "f84",
      "type" : "DialogCall",
      "name" : "TaskTemplateIFrame",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.iframe.TaskTemplateIFrame",
        "startMethod" : "start(String,Number)",
        "call" : {
          "params" : [
            { "name" : "url", "type" : "String" },
            { "name" : "taskId", "type" : "Number" }
          ],
          "map" : {
            "param.url" : "in.callbackUrl",
            "param.taskId" : "in.endedTaskId"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 680, "y" : 1536 },
        "size" : { "width" : 128, "height" : 60 }
      }
    }, {
      "id" : "f83",
      "type" : "Script",
      "name" : "Check if url is valid",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivyteam.ivy.workflow.ITask;",
            "import ch.ivyteam.ivy.bpm.error.BpmError;",
            "",
            "ITask task = ivy.wf.findTask(Long.valueOf(in.endedTaskId));",
            "if (!in.callbackUrl.startsWith(task.getApplication().getContextPath())) {",
            "  BpmError.create(\"frame:unsupported:url\").withMessage(\"only relative urls are supported (security reasons)\").throwError();",
            "}"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 248, "y" : 1536 }
      },
      "connect" : { "id" : "f88", "to" : "f86" }
    }, {
      "id" : "f5",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 1072, "y" : 304 }
      },
      "connect" : [
        { "id" : "f20", "to" : "f0", "condition" : "java.util.Objects.equals(ch.ivy.addon.portalkit.enums.PortalPage.HOME_PAGE, in.#portalPage) && org.apache.commons.lang3.StringUtils.isBlank(in.#callbackUrl)" },
        { "id" : "f18", "to" : "S10" }
      ]
    }, {
      "id" : "f32",
      "type" : "DialogCall",
      "name" : "Statistic",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.admin.PortalDashBoard",
        "startMethod" : "start()"
      },
      "visual" : {
        "at" : { "x" : 248, "y" : 769 }
      },
      "connect" : { "id" : "f35", "to" : "f34" }
    }, {
      "id" : "f72",
      "type" : "RequestStart",
      "name" : "Error500Page.ivp",
      "config" : {
        "callSignature" : "Error500Page",
        "outLink" : "Error500Page.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1344 },
        "labelOffset" : { "x" : 11, "y" : 37 }
      },
      "connect" : { "id" : "f77", "to" : "f74" }
    }, {
      "id" : "S10",
      "type" : "UserBpmnElement",
      "name" : [
        "Open previous",
        "page before finish task"
      ],
      "elements" : [ {
          "id" : "S10-f17",
          "type" : "Script",
          "name" : "Find case",
          "config" : {
            "security" : "system",
            "output" : {
              "code" : [
                "import ch.ivyteam.ivy.workflow.ITask;",
                "import ch.ivyteam.ivy.workflow.ICase;",
                "import ch.ivyteam.ivy.workflow.query.CaseQuery;",
                "",
                "long caseId = -1;",
                "if (in.endedTaskId is initialized) {",
                "  ITask task = ivy.wf.findTask(Long.valueOf(in.endedTaskId));",
                "  caseId = task.getCase().getId();",
                "}",
                "out.caseSelected = ivy.wf.getGlobalContext().getCaseQueryExecutor().getFirstResult(CaseQuery.create().where().caseId().isEqual(caseId)) as ICase;"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 408, "y" : 288 }
          },
          "connect" : { "id" : "S10-f26", "to" : "S10-f23" }
        }, {
          "id" : "S10-f68",
          "type" : "Script",
          "name" : "find task by id",
          "config" : {
            "security" : "system",
            "output" : {
              "code" : "out.taskSelected = ivy.wf.findTask(Long.valueOf(in.endedTaskId));"
            }
          },
          "visual" : {
            "at" : { "x" : 408, "y" : 192 }
          },
          "connect" : { "id" : "S10-f42", "to" : "S10-f6" }
        }, {
          "id" : "S10-f52",
          "type" : "Script",
          "name" : "build data model",
          "config" : {
            "security" : "system",
            "output" : {
              "code" : [
                "import ch.ivy.addon.portalkit.datamodel.CaseLazyDataModel;",
                "import ch.ivy.addon.portalkit.datamodel.SearchResultsDataModel;",
                "",
                "in.searchResultsDataModel = new SearchResultsDataModel();",
                "in.searchResultsDataModel.taskDataModel = in.dataModel;",
                "in.searchResultsDataModel.keyword = in.searchResultsDataModel.taskDataModel.criteria.keyword;",
                "in.searchResultsDataModel.caseDataModel.notKeepFilter = true;",
                "in.searchResultsDataModel.caseDataModel.getCriteria().keyword = in.searchResultsDataModel.taskDataModel.criteria.keyword;"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 408, "y" : 480 }
          },
          "connect" : { "id" : "S10-f49", "to" : "S10-f37" }
        }, {
          "id" : "S10-f19",
          "type" : "Script",
          "name" : [
            "build data model,",
            " task "
          ],
          "config" : {
            "security" : "system",
            "output" : {
              "code" : [
                "import ch.ivy.addon.portal.generic.view.TaskView;",
                "",
                "boolean canLinkBackToCaseDetail = in.#dataModel.#criteria.#caseId is initialized; ",
                "in.taskView = TaskView.create().dataModel(in.dataModel).canLinkBackCaseDetail(canLinkBackToCaseDetail).showHeaderToolbar(false).createNewTaskView();"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 416, "y" : 384 },
            "size" : { "width" : 128, "height" : 56 }
          },
          "connect" : { "id" : "S10-f39", "to" : "S10-f12" }
        }, {
          "id" : "S10-f37",
          "type" : "SubProcessCall",
          "name" : "OpenPortalSearch",
          "config" : {
            "processCall" : "Functional Processes/OpenPortalSearch:call(ch.ivy.addon.portalkit.datamodel.SearchResultsDataModel,Number)",
            "call" : {
              "params" : [
                { "name" : "searchResultsDataModel", "type" : "ch.ivy.addon.portalkit.datamodel.SearchResultsDataModel" },
                { "name" : "activeTabIndex", "type" : "Number" }
              ],
              "map" : {
                "param.searchResultsDataModel" : "in.searchResultsDataModel",
                "param.activeTabIndex" : "1"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 616, "y" : 480 }
          }
        }, {
          "id" : "S10-f0",
          "type" : "Alternative",
          "visual" : {
            "at" : { "x" : 224, "y" : 96 }
          },
          "connect" : [
            { "id" : "S10-f8", "to" : "S10-f7", "label" : {
                "name" : "Express end page",
                "segment" : 0.47,
                "offset" : { "x" : 0, "y" : -11 }
              }, "condition" : "org.apache.commons.lang3.StringUtils.isNotBlank(in.#callbackUrl)" },
            { "id" : "S10-f2", "to" : "S10-f68", "via" : [ { "x" : 288, "y" : 192 } ], "condition" : "in.isTaskStartedInDetails && !in.isTaskFinished && !in.backFromTaskDetails" },
            { "id" : "S10-f3", "to" : "S10-f17", "via" : [ { "x" : 288, "y" : 288 } ], "condition" : "java.util.Objects.equals(ch.ivy.addon.portalkit.enums.PortalPage.CASE_DETAIL_FROM_TASK, in.#portalPage)" },
            { "id" : "S10-f4", "to" : "S10-f19", "via" : [ { "x" : 256, "y" : 384 } ], "condition" : "java.util.Objects.equals(ch.ivy.addon.portalkit.enums.PortalPage.TASK_LIST, in.#portalPage)" },
            { "id" : "S10-f5", "to" : "S10-f52", "via" : [ { "x" : 224, "y" : 480 } ] }
          ]
        }, {
          "id" : "S10-g0",
          "type" : "EmbeddedStart",
          "name" : "in 1",
          "visual" : {
            "at" : { "x" : 96, "y" : 96 },
            "labelOffset" : { "x" : 18, "y" : 25 }
          },
          "parentConnector" : "f18",
          "connect" : { "id" : "S10-f1", "to" : "S10-f0" }
        }, {
          "id" : "S10-f23",
          "type" : "SubProcessCall",
          "name" : "OpenPortalCaseDetailHook",
          "config" : {
            "processCall" : "Functional Processes/OpenPortalCaseDetailsHook:call(ch.ivyteam.ivy.workflow.ICase,Boolean)",
            "call" : {
              "params" : [
                { "name" : "caseData", "type" : "ch.ivyteam.ivy.workflow.ICase" },
                { "name" : "isShowBackButton", "type" : "Boolean" }
              ],
              "map" : {
                "param.caseData" : "in.caseSelected",
                "param.isShowBackButton" : "true"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 624, "y" : 288 },
            "size" : { "width" : 160, "height" : 60 }
          }
        }, {
          "id" : "S10-f6",
          "type" : "SubProcessCall",
          "name" : "OpenPortalTaskDetailsHook",
          "config" : {
            "processCall" : "Functional Processes/OpenPortalTaskDetailsHook:call(ch.ivyteam.ivy.workflow.ITask,ch.ivy.addon.portalkit.datamodel.TaskLazyDataModel,ch.ivy.addon.portalkit.enums.PortalPage,Boolean)",
            "call" : {
              "params" : [
                { "name" : "task", "type" : "ch.ivyteam.ivy.workflow.ITask" },
                { "name" : "dataModel", "type" : "ch.ivy.addon.portalkit.datamodel.TaskLazyDataModel" },
                { "name" : "portalPage", "type" : "ch.ivy.addon.portalkit.enums.PortalPage" },
                { "name" : "isFromTaskList", "type" : "Boolean" }
              ],
              "map" : {
                "param.task" : "in.taskSelected",
                "param.dataModel" : "in.dataModel",
                "param.portalPage" : "in.portalPage",
                "param.isFromTaskList" : "false"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 600, "y" : 192 },
            "size" : { "width" : 176, "height" : 60 }
          }
        }, {
          "id" : "S10-f12",
          "type" : "SubProcessCall",
          "name" : "OpenPortalTasks",
          "config" : {
            "processCall" : "Functional Processes/OpenPortalTasks:useView(ch.ivy.addon.portal.generic.view.TaskView)",
            "call" : {
              "params" : [
                { "name" : "taskView", "type" : "ch.ivy.addon.portal.generic.view.TaskView" }
              ],
              "map" : {
                "param.taskView" : "in.taskView"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 624, "y" : 384 },
            "size" : { "width" : 104, "height" : 48 }
          }
        }, {
          "id" : "S10-f7",
          "type" : "DialogCall",
          "name" : "PortalUrlCallback",
          "config" : {
            "dialogId" : "ch.ivy.addon.portal.generic.PortalUrlCallback",
            "startMethod" : "start(String)",
            "call" : {
              "params" : [
                { "name" : "callbackUrl", "type" : "String" }
              ],
              "map" : {
                "param.callbackUrl" : "in.callbackUrl"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 504, "y" : 96 }
          }
        } ],
      "visual" : {
        "at" : { "x" : 1208, "y" : 304 },
        "size" : { "width" : 160, "height" : 48 }
      }
    }, {
      "id" : "f71",
      "type" : "DialogCall",
      "name" : "Processes",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.Processes",
        "startMethod" : "start()"
      },
      "visual" : {
        "at" : { "x" : 352, "y" : 1280 }
      }
    }, {
      "id" : "f209",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 224, "y" : 513 }
      },
      "connect" : [
        { "id" : "f24", "to" : "S30" }
      ]
    }, {
      "id" : "f107",
      "type" : "RequestStart",
      "name" : "ForgotPasswordPage.ivp",
      "config" : {
        "callSignature" : "ForgotPasswordPage",
        "outLink" : "ForgotPasswordPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 768, "y" : 864 },
        "labelOffset" : { "x" : 56, "y" : 37 }
      },
      "connect" : { "id" : "f126", "to" : "f125" }
    }, {
      "id" : "f34",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 384, "y" : 769 }
      }
    }, {
      "id" : "f234",
      "type" : "RequestStart",
      "name" : "ShowCaseDocument.ivp",
      "config" : {
        "callSignature" : "ShowCaseDocument",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" }
          ],
          "map" : {
            "out.caseId" : "param.caseId"
          }
        },
        "outLink" : "ShowCaseDocument.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 896, "y" : 2304 },
        "labelOffset" : { "x" : 27, "y" : 38 }
      },
      "connect" : { "id" : "f238", "to" : "f237" }
    }, {
      "id" : "f68",
      "type" : "RequestStart",
      "name" : "GlobalSearchPage.ivp",
      "config" : {
        "callSignature" : "GlobalSearchPage",
        "input" : {
          "params" : [
            { "name" : "keyword", "type" : "String" }
          ],
          "map" : {
            "out.keyword" : "param.keyword"
          }
        },
        "outLink" : "GlobalSearchPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1152 },
        "labelOffset" : { "x" : 12, "y" : 37 }
      },
      "connect" : { "id" : "f69", "to" : "f67" }
    }, {
      "id" : "f28",
      "type" : "RequestStart",
      "name" : "DefaultApplicationHomePage.ivp",
      "config" : {
        "callSignature" : "DefaultApplicationHomePage",
        "case" : {
          "name" : "<%=ivy.cms.co(\"/Processes/Cases/PortalCategory\")%>: <%=ivy.cms.co(\"/Processes/portalSettingSaved\")%>",
          "description" : "<%=ivy.cms.co(\"/Processes/Cases/PortalInternalProcess/PortalInternalProcessDescription\")%>",
          "category" : "<%=ivy.cms.co(\"/Processes/Cases/PortalCategory\")%>"
        },
        "outLink" : "DefaultApplicationHomePage.ivp",
        "startCustomFields" : [
          { "name" : "cssIcon", "value" : "si si-layout-dashboard" },
          { "name" : "embedInFrame", "value" : "false" }
        ],
        "task" : {
          "name" : "<%=ivy.cms.co(\"/Processes/Cases/PortalCategory\")%>: <%=ivy.cms.co(\"/Processes/portalSettingSaved\")%>",
          "description" : "<%=ivy.cms.co(\"/Processes/Cases/PortalInternalProcess/PortalInternalProcessDescription\")%>",
          "category" : "<%=ivy.cms.co(\"/Processes/Cases/PortalCategory\")%>"
        },
        "startName" : "<%=ivy.cms.co(\"/Processes/portalHome\")%>"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 144 },
        "labelOffset" : { "x" : 17, "y" : 39 }
      },
      "connect" : { "id" : "f204", "to" : "f203" }
    }, {
      "id" : "f207",
      "type" : "Script",
      "name" : "Init Teams attrs",
      "config" : {
        "output" : {
          "code" : [
            "import ch.addon.portal.generic.userprofile.homepage.HomepageType;",
            "import ch.ivy.addon.portalkit.enums.SessionAttribute;",
            "import ch.ivy.addon.portalkit.util.SecurityServiceUtils;",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.PORTAL_IN_TEAMS.toString(), true);",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.DEFAULT_PAGE_IN_TEAMS.toString(), HomepageType.CASE.toString());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 224, "y" : 448 }
      },
      "connect" : { "id" : "f211", "to" : "f209" }
    }, {
      "id" : "f12",
      "type" : "RequestStart",
      "name" : "CaseDetailsInIFrame.ivp",
      "config" : {
        "callSignature" : "CaseDetailsInIFrame",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" }
          ],
          "map" : {
            "out.caseId" : "param.caseId"
          }
        },
        "outLink" : "CaseDetailsInIFrame.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1824 },
        "labelOffset" : { "x" : 36, "y" : 38 }
      },
      "connect" : { "id" : "f53", "to" : "f52" }
    }, {
      "id" : "f56",
      "type" : "SubProcessCall",
      "name" : "Functional Processes/Navigator",
      "config" : {
        "processCall" : "Functional Processes/Navigator:viewTaskInFrame(Long,ch.ivy.addon.portalkit.dto.GlobalCaseId,String)",
        "call" : {
          "params" : [
            { "name" : "taskId", "type" : "Long" },
            { "name" : "caseId", "type" : "ch.ivy.addon.portalkit.dto.GlobalCaseId" },
            { "name" : "caseName", "type" : "String" }
          ],
          "map" : {
            "param.caseId" : "ch.ivy.addon.portalkit.dto.GlobalCaseId.caseId(in.caseId).isBusinessCase(in.isBusinessCase).build()",
            "param.caseName" : "in.caseName"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 288, "y" : 1920 },
        "size" : { "width" : 192, "height" : 60 }
      }
    }, {
      "id" : "f226",
      "type" : "RequestStart",
      "name" : "PortalProcessViewer.ivp",
      "config" : {
        "callSignature" : "PortalProcessViewer",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" },
            { "name" : "processKey", "type" : "String" }
          ],
          "map" : {
            "out.caseId" : "param.caseId",
            "out.processId" : "param.processKey"
          }
        },
        "outLink" : "PortalProcessViewer.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 896, "y" : 2112 },
        "labelOffset" : { "x" : 24, "y" : 38 }
      },
      "connect" : { "id" : "f227", "to" : "f225" }
    }, {
      "id" : "f232",
      "type" : "DialogCall",
      "name" : "TaskDocuments",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.TaskDocuments",
        "startMethod" : "start(Long)",
        "call" : {
          "params" : [
            { "name" : "taskId", "type" : "Long" }
          ],
          "map" : {
            "param.taskId" : "in.taskId"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 1048, "y" : 2208 }
      },
      "connect" : { "id" : "f231", "to" : "f230" }
    }, {
      "id" : "f203",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 224, "y" : 144 }
      },
      "connect" : [
        { "id" : "f43", "to" : "f21" }
      ]
    }, {
      "id" : "f11",
      "type" : "Script",
      "name" : "Handle end page",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.constant.CustomFields;",
            "import ch.ivy.addon.portalkit.dto.TaskEndInfo;",
            "import ch.ivy.addon.portalkit.service.StickyTaskListService;",
            "import ch.ivy.addon.portalkit.enums.SessionAttribute;",
            "import ch.ivy.addon.portalkit.util.SecurityServiceUtils;",
            "import ch.ivy.addon.portalkit.enums.PortalPage;",
            "import org.apache.commons.lang3.StringUtils;",
            "import ch.ivyteam.ivy.workflow.ITask;",
            "",
            "ITask task = ivy.wf.findTask(Long.valueOf(in.endedTaskId));",
            "in.isFirstTask = true;",
            "in.portalPage = PortalPage.HOME_PAGE;",
            "",
            "if (#task is initialized) {",
            "  in.isTaskFinished = task.getEndTimestamp() is initialized;",
            "  ",
            "  ITask taskWithTaskEndInfo = null;",
            "  if (task.getStartSwitchEvent() is initialized) {",
            "    taskWithTaskEndInfo = StickyTaskListService.service().getPreviousTaskWithTaskEndInfo(task);",
            "  }",
            "",
            "  if (#taskWithTaskEndInfo is initialized) {",
            "    in.isFirstTask = false;",
            "    String taskEndInfoSessionAttributeKey = StickyTaskListService.service().getTaskEndInfoSessionAttributeKey(taskWithTaskEndInfo.getId());",
            "    TaskEndInfo taskEndInfo = SecurityServiceUtils.getSessionAttribute(taskEndInfoSessionAttributeKey) as TaskEndInfo;",
            "      ",
            "    in.dataModel = taskEndInfo.dataModel;",
            "    in.isTaskStartedInDetails = taskEndInfo.isStartedInTaskDetails;",
            "    in.portalPage = taskEndInfo.portalPage;",
            "    if (!in.isTaskStartedInDetails || in.backFromTaskDetails) {",
            "      SecurityServiceUtils.removeSessionAttribute(taskEndInfoSessionAttributeKey);",
            "    }",
            "    ",
            "    if (in.isTaskFinished) {",
            "      in.callbackUrl = taskWithTaskEndInfo.customFields().stringField(CustomFields.EXPRESS_END_PAGE_URL.toString()).getOrDefault(\"\");",
            "    }",
            "  }",
            "  in.caseSelected = task.getCase();",
            "} else {",
            "  Boolean isTaskFinished = SecurityServiceUtils.getSessionAttribute(SessionAttribute.IS_TASK_FINISHED.toString()).toBoolean();",
            "  in.isTaskFinished = #isTaskFinished is initialized ? isTaskFinished : true;",
            "}",
            "",
            "SecurityServiceUtils.removeSessionAttribute(SessionAttribute.IS_TASK_FINISHED.toString());",
            "ivy.session.setAttribute(SessionAttribute.IS_TASK_STARTED_IN_DETAILS.toString(), in.isTaskStartedInDetails);"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 640, "y" : 304 }
      },
      "connect" : { "id" : "f2", "to" : "f1" }
    }, {
      "id" : "f130",
      "type" : "RequestStart",
      "name" : "CaseDetailsPageInFrame.ivp",
      "config" : {
        "callSignature" : "CaseDetailsPageInFrame",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" },
            { "name" : "isBusinessCase", "type" : "Boolean" }
          ],
          "map" : {
            "out.caseId" : "param.caseId",
            "out.isBusinessCase" : "param.isBusinessCase"
          }
        },
        "outLink" : "CaseDetailsPageInFrame.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 2208 },
        "labelOffset" : { "x" : 21, "y" : 41 }
      },
      "connect" : { "id" : "f131", "to" : "f122" }
    }, {
      "id" : "f85",
      "type" : "ProcessAnnotation",
      "name" : [
        "If open a process/start in \"embedInFrame\" mode (add to url embedInFrame parameter), ",
        "DefaultFramePage process will run"
      ],
      "visual" : {
        "at" : { "x" : 296, "y" : 1616 },
        "size" : { "width" : 464, "height" : 44 }
      }
    }, {
      "id" : "f120",
      "type" : "RequestStart",
      "name" : "DefaultDashboardPage.ivp",
      "config" : {
        "callSignature" : "DefaultDashboardPage",
        "input" : {
          "params" : [
            { "name" : "isShowDashboard", "type" : "Boolean" }
          ],
          "map" : {
            "out.isShowDashboard" : "param.isShowDashboard"
          }
        },
        "outLink" : "DefaultDashboardPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 64 },
        "labelOffset" : { "x" : 17, "y" : 37 }
      },
      "connect" : { "id" : "f47", "to" : "f21", "via" : [ { "x" : 488, "y" : 64 } ] }
    }, {
      "id" : "f115",
      "type" : "Alternative",
      "name" : "isIvySecuritySystem?",
      "visual" : {
        "at" : { "x" : 1040, "y" : 1040 },
        "labelOffset" : { "x" : 20, "y" : 34 }
      },
      "connect" : [
        { "id" : "f124", "to" : "f109", "condition" : "ch.ivy.addon.portalkit.util.SecuritySystemUtils.isIvySecuritySystem()" },
        { "id" : "f123", "to" : "f118" }
      ]
    }, {
      "id" : "f4",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 488, "y" : 304 }
      },
      "connect" : [
        { "id" : "f29", "to" : "f31", "condition" : "ivy.session.isSessionUserUnknown()" },
        { "id" : "f48", "to" : "f11", "label" : {
            "name" : "logged in",
            "segment" : 0.46,
            "offset" : { "x" : 0, "y" : -10 }
          } }
      ]
    }, {
      "id" : "f82",
      "type" : "RequestStart",
      "name" : "DefaultFramePage.ivp",
      "config" : {
        "callSignature" : "DefaultFramePage",
        "input" : {
          "params" : [
            { "name" : "relativeUrl", "type" : "String" },
            { "name" : "runningTaskId", "type" : "Number" }
          ],
          "map" : {
            "out.callbackUrl" : "param.relativeUrl",
            "out.endedTaskId" : "param.runningTaskId"
          }
        },
        "outLink" : "DefaultFramePage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1536 },
        "labelOffset" : { "x" : 25, "y" : 37 }
      },
      "connect" : { "id" : "f89", "to" : "f83" }
    }, {
      "id" : "f157",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 1504, "y" : 1920 }
      }
    }, {
      "id" : "f220",
      "type" : "RequestStart",
      "name" : "DefaultProcessStartListPageInTeams.ivp",
      "config" : {
        "callSignature" : "DefaultProcessStartListPageInTeams",
        "outLink" : "DefaultProcessStartListPageInTeams.ivp"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1216 },
        "labelOffset" : { "x" : 61, "y" : 37 }
      },
      "connect" : { "id" : "f222", "to" : "f221" }
    }, {
      "id" : "f70",
      "type" : "RequestStart",
      "name" : "StatisticPage.ivp",
      "config" : {
        "callSignature" : "StatisticPage",
        "outLink" : "StatisticPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 769 },
        "labelOffset" : { "x" : 7, "y" : 37 }
      },
      "connect" : { "id" : "f33", "to" : "f32" }
    }, {
      "id" : "f9",
      "type" : "SubProcessCall",
      "name" : "InitializeTaskDataModel",
      "config" : {
        "processCall" : "Functional Processes/InitializeTaskDataModel:call()",
        "output" : {
          "map" : {
            "out" : "in",
            "out.dataModel" : "result.dataModel",
            "out.dataModel.compactMode" : "true"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 936, "y" : 144 },
        "size" : { "width" : 144, "height" : 60 }
      },
      "connect" : { "id" : "f16", "to" : "f0" }
    }, {
      "id" : "f81",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 560, "y" : 1536 }
      },
      "connect" : [
        { "id" : "f87", "to" : "f84", "condition" : "in.embedInIFrame" },
        { "id" : "f90", "to" : "f80", "via" : [ { "x" : 560, "y" : 1632 } ] }
      ]
    }, {
      "id" : "f65",
      "type" : "SubProcessCall",
      "name" : "Functional Processes/Navigator",
      "config" : {
        "processCall" : "Functional Processes/Navigator:viewRelatedTask(Long)",
        "call" : {
          "params" : [
            { "name" : "taskId", "type" : "Long" }
          ],
          "map" : {
            "param.taskId" : "in.selectedTaskId"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 280, "y" : 1056 },
        "size" : { "width" : 176, "height" : 60 }
      }
    }, {
      "id" : "f206",
      "type" : "RequestStart",
      "name" : "DefaultCaseListPageInTeams.ivp",
      "config" : {
        "callSignature" : "DefaultCaseListPageInTeams",
        "outLink" : "DefaultCaseListPageInTeams.ivp"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 448 },
        "labelOffset" : { "x" : 57, "y" : 38 }
      },
      "connect" : { "id" : "f208", "to" : "f207" }
    }, {
      "id" : "f58",
      "type" : "RequestStart",
      "name" : "CaseListPage.ivp",
      "config" : {
        "callSignature" : "CaseListPage",
        "outLink" : "CaseListPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 513 },
        "labelOffset" : { "x" : 12, "y" : 36 }
      },
      "connect" : { "id" : "f210", "to" : "f209" }
    }, {
      "id" : "f229",
      "type" : "RequestStart",
      "name" : "ShowTaskDocument.ivp",
      "config" : {
        "callSignature" : "ShowTaskDocument",
        "input" : {
          "params" : [
            { "name" : "selectedTaskId", "type" : "Long" }
          ],
          "map" : {
            "out.taskId" : "param.selectedTaskId"
          }
        },
        "outLink" : "ShowTaskDocument.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 896, "y" : 2208 },
        "labelOffset" : { "x" : 26, "y" : 36 }
      },
      "connect" : { "id" : "f233", "to" : "f232" }
    }, {
      "id" : "f94",
      "type" : "RequestStart",
      "name" : "RelatedTasksOfCasePageInFrame.ivp",
      "config" : {
        "callSignature" : "RelatedTasksOfCasePageInFrame",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" },
            { "name" : "isBusinessCase", "type" : "Boolean" },
            { "name" : "caseName", "type" : "String" }
          ],
          "map" : {
            "out.caseId" : "param.caseId",
            "out.caseName" : "param.caseName",
            "out.isBusinessCase" : "param.isBusinessCase"
          }
        },
        "outLink" : "RelatedTasksOfCasePageInFrame.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1920 },
        "labelOffset" : { "x" : 37, "y" : 37 }
      },
      "connect" : { "id" : "f96", "to" : "f56" }
    }, {
      "id" : "f52",
      "type" : "DialogCall",
      "name" : "CaseInformationInIFrame",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.component.iframe.CaseInformationInIFrame",
        "startMethod" : "start(Long,Boolean)",
        "call" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" },
            { "name" : "showBackButton", "type" : "Boolean" }
          ],
          "map" : {
            "param.caseId" : "in.caseId",
            "param.showBackButton" : "false"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 272, "y" : 1824 },
        "size" : { "width" : 160, "height" : 60 }
      },
      "connect" : { "id" : "f55", "to" : "f54" }
    }, {
      "id" : "f125",
      "type" : "Alternative",
      "name" : "logged in?",
      "visual" : {
        "at" : { "x" : 896, "y" : 864 },
        "labelOffset" : { "x" : 64, "y" : 17 }
      },
      "connect" : [
        { "id" : "f116", "to" : "f121", "via" : [ { "x" : 896, "y" : 816 } ], "condition" : "ivy.session.isSessionUserUnknown()" },
        { "id" : "f112", "to" : "f118", "via" : [ { "x" : 896, "y" : 928 } ] }
      ]
    }, {
      "id" : "f164",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 1504, "y" : 2016 }
      }
    }, {
      "id" : "f122",
      "type" : "SubProcessCall",
      "name" : "Functional Processes/Navigator",
      "config" : {
        "processCall" : "Functional Processes/Navigator:viewCaseItemDetailsInIFrame(ch.ivy.addon.portalkit.dto.GlobalCaseId)",
        "call" : {
          "params" : [
            { "name" : "caseId", "type" : "ch.ivy.addon.portalkit.dto.GlobalCaseId" }
          ],
          "map" : {
            "param.caseId" : "ch.ivy.addon.portalkit.dto.GlobalCaseId.caseId(in.caseId).isBusinessCase(in.isBusinessCase).build()"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 280, "y" : 2208 },
        "size" : { "width" : 176, "height" : 60 }
      }
    }, {
      "id" : "f158",
      "type" : "Script",
      "name" : "Find case by id",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : "out.caseSelected = ivy.wf.findCase(in.caseId);"
        }
      },
      "visual" : {
        "at" : { "x" : 1048, "y" : 1920 }
      },
      "connect" : { "id" : "f161", "to" : "f156" }
    }, {
      "id" : "f127",
      "type" : "Alternative",
      "name" : "logged in?",
      "visual" : {
        "at" : { "x" : 896, "y" : 992 },
        "labelOffset" : { "x" : 59, "y" : 18 }
      },
      "connect" : [
        { "id" : "f119", "to" : "f115", "via" : [ { "x" : 896, "y" : 1040 } ], "condition" : "ivy.session.isSessionUserUnknown()" },
        { "id" : "f114", "to" : "f118", "via" : [ { "x" : 896, "y" : 928 } ] }
      ]
    }, {
      "id" : "f159",
      "type" : "RequestStart",
      "name" : "showAdditionalCaseDetails.ivp",
      "config" : {
        "callSignature" : "showAdditionalCaseDetails",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" }
          ],
          "map" : {
            "out.caseId" : "param.caseId"
          }
        },
        "outLink" : "showAdditionalCaseDetails.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 896, "y" : 1920 }
      },
      "connect" : { "id" : "f160", "to" : "f158" }
    }, {
      "id" : "f54",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 448, "y" : 1824 }
      }
    }, {
      "id" : "f165",
      "type" : "Alternative",
      "name" : "has permission?",
      "visual" : {
        "at" : { "x" : 1216, "y" : 2016 }
      },
      "connect" : [
        { "id" : "f172", "to" : "f166", "label" : {
            "name" : "yes",
            "segment" : 0.42,
            "offset" : { "x" : 0, "y" : -10 }
          }, "condition" : "in.hasPermission" },
        { "id" : "f171", "to" : "f164", "via" : [ { "x" : 1216, "y" : 2064 }, { "x" : 1504, "y" : 2064 } ], "label" : {
            "name" : "no",
            "segment" : 1.24,
            "offset" : { "x" : 0, "y" : -10 }
          } }
      ]
    }, {
      "id" : "f237",
      "type" : "DialogCall",
      "name" : "CaseDocuments",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.CaseDocuments",
        "startMethod" : "start(Long)",
        "call" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" }
          ],
          "map" : {
            "param.caseId" : "in.caseId"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 1048, "y" : 2304 }
      },
      "connect" : { "id" : "f236", "to" : "f235" }
    }, {
      "id" : "f133",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 448, "y" : 2304 }
      }
    }, {
      "id" : "f215",
      "type" : "RequestStart",
      "name" : "DefaultTaskListPageInTeams.ivp",
      "config" : {
        "callSignature" : "DefaultTaskListPageInTeams",
        "outLink" : "DefaultTaskListPageInTeams.ivp"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 576 },
        "labelOffset" : { "x" : 48, "y" : 39 }
      },
      "connect" : { "id" : "f216", "to" : "f214" }
    }, {
      "id" : "f106",
      "type" : "RequestStart",
      "name" : "PasswordResetPage.ivp",
      "config" : {
        "callSignature" : "PasswordResetPage",
        "input" : {
          "params" : [
            { "name" : "token", "type" : "String" },
            { "name" : "username", "type" : "String" }
          ],
          "map" : {
            "out.passwordResetToken" : "param.token",
            "out.passwordResetUsername" : "param.username"
          }
        },
        "outLink" : "PasswordResetPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 768, "y" : 992 },
        "labelOffset" : { "x" : 55, "y" : 37 }
      },
      "connect" : { "id" : "f128", "to" : "f127" }
    }, {
      "id" : "f101",
      "type" : "DialogCall",
      "name" : "AbsenceManagement",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.setting.AbsenceManagement",
        "startMethod" : "start()"
      },
      "visual" : {
        "at" : { "x" : 256, "y" : 2112 },
        "size" : { "width" : 128, "height" : 60 }
      },
      "connect" : { "id" : "f102", "to" : "f100" }
    }, {
      "id" : "f100",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 448, "y" : 2112 }
      }
    }, {
      "id" : "f44",
      "type" : "DialogCall",
      "name" : "UserProfile",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.setting.UserProfile",
        "startMethod" : "start()"
      },
      "visual" : {
        "at" : { "x" : 248, "y" : 1728 }
      },
      "connect" : { "id" : "f46", "to" : "f45" }
    }, {
      "id" : "f39",
      "type" : "RequestStart",
      "name" : "DefaultLoginPage.ivp",
      "config" : {
        "callSignature" : "DefaultLoginPage",
        "input" : {
          "params" : [
            { "name" : "originalUrl", "type" : "String" }
          ],
          "map" : {
            "out.callbackUrl" : "param.#originalUrl is initialized ? param.originalUrl : null"
          }
        },
        "outLink" : "DefaultLoginPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 864 },
        "labelOffset" : { "x" : 21, "y" : 38 }
      },
      "connect" : { "id" : "f42", "to" : "f51" }
    }, {
      "id" : "f118",
      "type" : "Script",
      "name" : "Redirect to homepage",
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.publicapi.PortalNavigatorAPI;",
            "",
            "PortalNavigatorAPI.navigateToPortalHome();"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1040, "y" : 928 },
        "size" : { "width" : 128, "height" : 60 }
      }
    }, {
      "id" : "f152",
      "type" : "Script",
      "name" : "Find task notes",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivyteam.ivy.workflow.INote;",
            "import ch.ivyteam.ivy.workflow.query.TaskQuery;",
            "import ch.ivyteam.ivy.workflow.ITask;",
            "import ch.ivy.addon.portalkit.util.CaseUtils;",
            "import ch.ivyteam.ivy.workflow.ICase;",
            "import ch.ivy.addon.portalkit.service.GlobalSettingService;",
            "import ch.ivy.addon.portalkit.comparator.NoteComparator;",
            "",
            "in.taskSelected = ivy.wf.getGlobalContext().getTaskQueryExecutor().getFirstResult(TaskQuery.create().where().taskId().isEqual(in.taskId)) as ITask;",
            "ICase iCase = in.taskSelected.getCase().getBusinessCase();",
            "GlobalSettingService globalSettingService = new GlobalSettingService();",
            "boolean excludeSystemNotes = globalSettingService.findHideSystemNotesFromHistorySettingValue();",
            "in.notes = CaseUtils.findNotes(iCase, excludeSystemNotes);",
            "in.notes.sort(new NoteComparator());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1048, "y" : 1824 }
      },
      "connect" : { "id" : "f154", "to" : "f151" }
    }, {
      "id" : "f142",
      "type" : "DialogCall",
      "name" : "Case note history",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.CaseNoteHistory",
        "startMethod" : "start(java.util.List<ch.ivy.addon.portalkit.bo.History>,String,ch.ivyteam.ivy.workflow.ICase)",
        "call" : {
          "params" : [
            { "name" : "histories", "type" : "java.util.List<ch.ivy.addon.portalkit.bo.History>" },
            { "name" : "exportedFileName", "type" : "String" },
            { "name" : "ivyCase", "type" : "ch.ivyteam.ivy.workflow.ICase" }
          ],
          "map" : {
            "param.histories" : "in.histories",
            "param.exportedFileName" : "ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/noteHistory/caseExportedFileNamePrefix\", java.util.Arrays.asList(ch.ivy.addon.portalkit.util.PermissionUtils.getCaseName(in.caseSelected)))",
            "param.ivyCase" : "in.caseSelected"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 1368, "y" : 1728 }
      },
      "connect" : { "id" : "f146", "to" : "f138" }
    }, {
      "id" : "f73",
      "type" : "RequestStart",
      "name" : "Error404Page.ivp",
      "config" : {
        "callSignature" : "Error404Page",
        "outLink" : "Error404Page.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1440 },
        "labelOffset" : { "x" : 16, "y" : 37 }
      },
      "connect" : { "id" : "f78", "to" : "f75" }
    }, {
      "id" : "f38",
      "type" : "RequestStart",
      "name" : "UserProfile.ivp",
      "config" : {
        "callSignature" : "UserProfile",
        "case" : {
          "customFields" : [
            { "name" : "embedInFrame", "type" : "String", "value" : "\"false\"" }
          ]
        },
        "outLink" : "UserProfile.ivp",
        "showInStartList" : false,
        "wfuser" : "1"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1728 },
        "labelOffset" : { "x" : 27, "y" : 37 }
      },
      "connect" : { "id" : "f93", "to" : "f44" }
    }, {
      "id" : "f151",
      "type" : "DialogCall",
      "name" : "Task Note History",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.TaskNoteHistory",
        "startMethod" : "start(java.util.List<ch.ivyteam.ivy.workflow.INote>,String,ch.ivyteam.ivy.workflow.ITask)",
        "call" : {
          "params" : [
            { "name" : "notes", "type" : "java.util.List<ch.ivyteam.ivy.workflow.INote>" },
            { "name" : "exportedFileName", "type" : "String" },
            { "name" : "task", "type" : "ch.ivyteam.ivy.workflow.ITask" }
          ],
          "map" : {
            "param.notes" : "in.notes",
            "param.exportedFileName" : "ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/noteHistory/taskExportedFileNamePrefix\", java.util.Arrays.asList(ch.ivy.addon.portalkit.util.PermissionUtils.getTaskName(in.taskSelected)))",
            "param.task" : "in.taskSelected"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 1368, "y" : 1824 }
      },
      "connect" : { "id" : "f153", "to" : "f148" }
    }, {
      "id" : "f225",
      "type" : "DialogCall",
      "name" : "ProcessViewer",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.ProcessViewer",
        "startMethod" : "start(Long,String)",
        "call" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" },
            { "name" : "processId", "type" : "String" }
          ],
          "map" : {
            "param.caseId" : "in.caseId",
            "param.processId" : "in.processId"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 1048, "y" : 2112 },
        "size" : { "width" : 120, "height" : 48 }
      },
      "connect" : { "id" : "f228", "to" : "f224" }
    }, {
      "id" : "f109",
      "type" : "Script",
      "name" : "Load URL",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import java.util.Calendar;",
            "import javax.faces.application.FacesMessage;",
            "import javax.faces.context.FacesContext;",
            "import ch.ivy.addon.portalkit.constant.UserProperty;",
            "import ch.ivy.addon.portalkit.util.UserUtils;",
            "import ch.ivyteam.ivy.environment.Ivy;",
            "import org.apache.commons.lang.StringUtils;",
            "import ch.ivyteam.ivy.security.IUser;",
            "in.isValidResetUrl = false;",
            "// TODO check if the ivy Security System is used",
            "// find user by username",
            "IUser user = StringUtils.isNotBlank(in.passwordResetUsername) ? UserUtils.findUserByUsername(in.passwordResetUsername) : null;",
            "in.isValidResetUrl = UserUtils.isValidPasswordResetToken(in.passwordResetToken, user);",
            "if (!in.isValidResetUrl) {",
            "  in.passwordResetMessage = ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/forgotPassword/invalidResetUrl\");",
            "} else {",
            "  in.passwordResetMessage = \"\";",
            "}"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1200, "y" : 1040 }
      },
      "connect" : { "id" : "f111", "to" : "f110" }
    }, {
      "id" : "f95",
      "type" : "SubProcessCall",
      "name" : "Functional Processes/Navigator",
      "config" : {
        "processCall" : "Functional Processes/Navigator:viewRelatedTaskInFrame(Long)",
        "call" : {
          "params" : [
            { "name" : "taskId", "type" : "Long" }
          ],
          "map" : {
            "param.taskId" : "in.selectedTaskId"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 280, "y" : 2016 },
        "size" : { "width" : 176, "height" : 60 }
      }
    }, {
      "id" : "f31",
      "type" : "Script",
      "name" : [
        "Redirect to",
        "login page"
      ],
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portal.generic.navigation.PortalNavigator;",
            "PortalNavigator.navigateToPortalLoginPage();"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 488, "y" : 224 }
      }
    }, {
      "id" : "f67",
      "type" : "SubProcessCall",
      "name" : "Functional Processes/OpenPortalSearch",
      "config" : {
        "processCall" : "Functional Processes/OpenPortalSearch:call(String)",
        "call" : {
          "params" : [
            { "name" : "keyword", "type" : "String" }
          ],
          "map" : {
            "param.keyword" : "in.keyword"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 304, "y" : 1152 },
        "size" : { "width" : 224, "height" : 60 }
      }
    }, {
      "id" : "f97",
      "type" : "RequestStart",
      "name" : "TaskDetailsPageInFrame.ivp",
      "config" : {
        "callSignature" : "TaskDetailsPageInFrame",
        "input" : {
          "params" : [
            { "name" : "selectedTaskId", "type" : "Long" }
          ],
          "map" : {
            "out.selectedTaskId" : "param.selectedTaskId"
          }
        },
        "outLink" : "TaskDetailsPageInFrame.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 2016 },
        "labelOffset" : { "x" : 19, "y" : 41 }
      },
      "connect" : { "id" : "f98", "to" : "f95" }
    }, {
      "id" : "f57",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 488, "y" : 513 }
      }
    }, {
      "id" : "f132",
      "type" : "RequestStart",
      "name" : "ProcessInformation.ivp",
      "config" : {
        "callSignature" : "ProcessInformation",
        "input" : {
          "params" : [
            { "name" : "processKey", "type" : "String" }
          ],
          "map" : {
            "out.processId" : "param.processKey"
          }
        },
        "outLink" : "ProcessInformation.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 2304 },
        "labelOffset" : { "x" : 14, "y" : 36 }
      },
      "connect" : { "id" : "f135", "to" : "f134" }
    }, {
      "id" : "f108",
      "type" : "DialogCall",
      "name" : "ForgotPassword",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.ForgotPassword",
        "startMethod" : "start()"
      },
      "visual" : {
        "at" : { "x" : 1200, "y" : 816 }
      }
    }, {
      "id" : "f1",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 784, "y" : 304 }
      },
      "connect" : [
        { "id" : "f30", "to" : "f22", "condition" : "in.#portalPage == null" },
        { "id" : "f36", "to" : "S70", "condition" : "!in.backFromTaskDetails" },
        { "id" : "f19", "to" : "f5", "via" : [ { "x" : 784, "y" : 384 }, { "x" : 1072, "y" : 384 } ] }
      ]
    }, {
      "id" : "f200",
      "type" : "RequestStart",
      "name" : "DefaultApplicationHomePageInTeams.ivp",
      "config" : {
        "callSignature" : "DefaultApplicationHomePageInTeams",
        "outLink" : "DefaultApplicationHomePageInTeams.ivp"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 224 },
        "labelOffset" : { "x" : 42, "y" : 38 }
      },
      "connect" : { "id" : "f202", "to" : "f201" }
    }, {
      "id" : "f64",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 488, "y" : 640 }
      }
    }, {
      "id" : "f21",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 488, "y" : 144 }
      },
      "connect" : [
        { "id" : "f49", "to" : "f31", "condition" : "ivy.session.isSessionUserUnknown()" },
        { "id" : "f140", "to" : "f139", "label" : {
            "name" : "logged in",
            "offset" : { "x" : 0, "y" : -9 }
          } }
      ]
    }, {
      "id" : "f201",
      "type" : "Script",
      "name" : "Init Teams attrs",
      "config" : {
        "output" : {
          "code" : [
            "import ch.addon.portal.generic.userprofile.homepage.HomepageType;",
            "import ch.ivy.addon.portalkit.enums.SessionAttribute;",
            "import ch.ivy.addon.portalkit.util.SecurityServiceUtils;",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.PORTAL_IN_TEAMS.toString(), true);",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.DEFAULT_PAGE_IN_TEAMS.toString(), HomepageType.DASHBOARD.toString());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 224, "y" : 224 }
      },
      "connect" : { "id" : "f205", "to" : "f203" }
    }, {
      "id" : "f3",
      "type" : "ProcessAnnotation",
      "name" : [
        "Replace by customized ",
        "homepage if you have"
      ],
      "visual" : {
        "at" : { "x" : 1328, "y" : 144 },
        "size" : { "width" : 144, "height" : 44 }
      }
    }, {
      "id" : "S60",
      "type" : "UserBpmnElement",
      "name" : [
        "Open selected ",
        "homepage"
      ],
      "elements" : [ {
          "id" : "S60-f36",
          "type" : "DialogCall",
          "name" : "Portal Homepage",
          "config" : {
            "dialogId" : "com.axonivy.portal.developerexamples.customization.PortalHome",
            "startMethod" : "start(ch.ivy.addon.portal.generic.view.TaskView)",
            "call" : {
              "params" : [
                { "name" : "taskView", "type" : "ch.ivy.addon.portal.generic.view.TaskView" }
              ],
              "map" : {
                "param.taskView" : "in.taskView"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 660, "y" : 160 }
          }
        }, {
          "id" : "S60-f22",
          "type" : "Script",
          "name" : "Build task view",
          "config" : {
            "output" : {
              "code" : [
                "import ch.ivyteam.ivy.request.IHttpRequest;",
                "import ch.ivy.addon.portal.generic.view.TaskView;",
                "",
                "in.taskView = TaskView.create().dataModel(in.dataModel).showHeaderToolbar(true).noTaskFoundMessage(\"\").createNewTaskView();"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 508, "y" : 160 }
          },
          "connect" : { "id" : "S60-f43", "to" : "S60-f36" }
        }, {
          "id" : "S60-f54",
          "type" : "Alternative",
          "visual" : {
            "at" : { "x" : 284, "y" : 160 }
          },
          "connect" : [
            { "id" : "S60-f7", "to" : "S60-f2", "label" : {
                "name" : "dashboard",
                "segment" : 0.41,
                "offset" : { "x" : 0, "y" : -12 }
              }, "condition" : "ch.addon.portal.generic.userprofile.homepage.HomepageUtils.isShowDashboard(in.#homepage, in.#isShowDashboard)" },
            { "id" : "S60-f5", "to" : "S60-f4", "via" : [ { "x" : 284, "y" : 256 } ], "label" : {
                "name" : "others",
                "segment" : 1.43,
                "offset" : { "x" : 0, "y" : -10 }
              } }
          ]
        }, {
          "id" : "S60-f3",
          "type" : "ProcessAnnotation",
          "name" : [
            "Replace by customized ",
            "homepage if you have"
          ],
          "visual" : {
            "at" : { "x" : 832, "y" : 160 },
            "size" : { "width" : 144, "height" : 44 }
          },
          "connect" : { "id" : "S60-f8", "to" : "S60-f36" }
        }, {
          "id" : "S60-g0",
          "type" : "EmbeddedStart",
          "name" : "in 1",
          "visual" : {
            "at" : { "x" : 64, "y" : 160 },
            "labelOffset" : { "x" : 18, "y" : 25 }
          },
          "parentConnector" : "f92",
          "connect" : { "id" : "S60-f11", "to" : "S60-f1" }
        }, {
          "id" : "S60-f1",
          "type" : "Script",
          "name" : [
            "Get selected",
            "homepage"
          ],
          "config" : {
            "output" : {
              "code" : [
                "import ch.addon.portal.generic.userprofile.homepage.HomepageUtils;",
                "out.homepage = HomepageUtils.findHomepage();"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 180, "y" : 160 }
          },
          "connect" : { "id" : "S60-f0", "to" : "S60-f54" }
        }, {
          "id" : "S60-f4",
          "type" : "Script",
          "name" : [
            "Redirect to ",
            "selected homepage"
          ],
          "config" : {
            "output" : {
              "code" : "ch.ivy.addon.portalkit.util.RequestUtils.redirect(in.homepage.link);"
            }
          },
          "visual" : {
            "at" : { "x" : 404, "y" : 256 },
            "size" : { "width" : 128, "height" : 60 }
          }
        }, {
          "id" : "S60-f2",
          "type" : "Alternative",
          "visual" : {
            "at" : { "x" : 380, "y" : 160 }
          },
          "connect" : [
            { "id" : "S60-f6", "to" : "S60-f22", "condition" : "ch.addon.portal.generic.userprofile.homepage.HomepageUtils.isShowLegacyUI()" },
            { "id" : "S60-f10", "to" : "S60-f9", "via" : [ { "x" : 380, "y" : 80 } ], "label" : {
                "name" : "new dashboard",
                "segment" : 1.26,
                "offset" : { "x" : 0, "y" : -10 }
              } }
          ]
        }, {
          "id" : "S60-f9",
          "type" : "DialogCall",
          "name" : "PortalDashboard",
          "config" : {
            "dialogId" : "ch.ivy.addon.portal.generic.dashboard.PortalDashboard",
            "startMethod" : "start()"
          },
          "visual" : {
            "at" : { "x" : 656, "y" : 80 }
          }
        } ],
      "visual" : {
        "at" : { "x" : 1184, "y" : 144 }
      }
    }, {
      "id" : "f103",
      "type" : "RequestStart",
      "name" : "CaseDetailsPage.ivp",
      "config" : {
        "callSignature" : "CaseDetailsPage",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" }
          ],
          "map" : {
            "out.caseId" : "param.caseId"
          }
        },
        "outLink" : "CaseDetailsPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 704 },
        "labelOffset" : { "x" : 8, "y" : 39 }
      },
      "connect" : { "id" : "f26", "to" : "S40" }
    }, {
      "id" : "f75",
      "type" : "DialogCall",
      "name" : "ErrorPage",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.error.ErrorPage",
        "startMethod" : "start(String)",
        "call" : {
          "params" : [
            { "name" : "errorCode", "type" : "String" }
          ],
          "map" : {
            "param.errorCode" : "\"404\""
          }
        }
      },
      "visual" : {
        "at" : { "x" : 248, "y" : 1440 }
      }
    }, {
      "id" : "f148",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 1504, "y" : 1824 }
      }
    }, {
      "id" : "f45",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 448, "y" : 1728 }
      }
    }, {
      "id" : "f110",
      "type" : "DialogCall",
      "name" : "PasswordReset",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.PasswordReset",
        "startMethod" : "start(String,String,Boolean,String)",
        "call" : {
          "params" : [
            { "name" : "token", "type" : "String" },
            { "name" : "username", "type" : "String" },
            { "name" : "isValidResetUrl", "type" : "Boolean" },
            { "name" : "message", "type" : "String" }
          ],
          "map" : {
            "param.token" : "in.passwordResetToken",
            "param.username" : "in.passwordResetUsername",
            "param.isValidResetUrl" : "in.isValidResetUrl",
            "param.message" : "in.passwordResetMessage"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 1368, "y" : 1040 }
      }
    }, {
      "id" : "f224",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 1216, "y" : 2112 }
      }
    }, {
      "id" : "f59",
      "type" : "SubProcessCall",
      "name" : "Functional Processes/Navigator",
      "config" : {
        "processCall" : "Functional Processes/Navigator:viewTask(Long,ch.ivy.addon.portalkit.dto.GlobalCaseId,String)",
        "call" : {
          "params" : [
            { "name" : "taskId", "type" : "Long" },
            { "name" : "caseId", "type" : "ch.ivy.addon.portalkit.dto.GlobalCaseId" },
            { "name" : "caseName", "type" : "String" }
          ],
          "map" : {
            "param.caseId" : "ch.ivy.addon.portalkit.dto.GlobalCaseId.caseId(in.caseId).isBusinessCase(in.isBusinessCase).build()",
            "param.caseName" : "in.caseName"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 280, "y" : 960 },
        "size" : { "width" : 176, "height" : 60 }
      }
    }, {
      "id" : "f166",
      "type" : "DialogCall",
      "name" : "Task Analysis dialog",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.TaskAnalysis",
        "startMethod" : "start()"
      },
      "visual" : {
        "at" : { "x" : 1376, "y" : 2016 },
        "size" : { "width" : 128, "height" : 60 }
      },
      "connect" : { "id" : "f169", "to" : "f164" }
    }, {
      "id" : "f221",
      "type" : "Script",
      "name" : "Init Teams attrs",
      "config" : {
        "output" : {
          "code" : [
            "import ch.addon.portal.generic.userprofile.homepage.HomepageType;",
            "import ch.ivy.addon.portalkit.enums.SessionAttribute;",
            "import ch.ivy.addon.portalkit.util.SecurityServiceUtils;",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.PORTAL_IN_TEAMS.toString(), true);",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.DEFAULT_PAGE_IN_TEAMS.toString(), HomepageType.PROCESS.toString());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 224, "y" : 1216 }
      },
      "connect" : { "id" : "f223", "to" : "f218" }
    }, {
      "id" : "f214",
      "type" : "Script",
      "name" : "Init Teams attrs",
      "config" : {
        "output" : {
          "code" : [
            "import ch.addon.portal.generic.userprofile.homepage.HomepageType;",
            "import ch.ivy.addon.portalkit.enums.SessionAttribute;",
            "import ch.ivy.addon.portalkit.util.SecurityServiceUtils;",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.PORTAL_IN_TEAMS.toString(), true);",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.DEFAULT_PAGE_IN_TEAMS.toString(), HomepageType.TASK.toString());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 224, "y" : 576 }
      },
      "connect" : { "id" : "f217", "to" : "f212" }
    }, {
      "id" : "f218",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 224, "y" : 1280 }
      },
      "connect" : [
        { "id" : "f79", "to" : "f71" }
      ]
    }, {
      "id" : "f76",
      "type" : "RequestStart",
      "name" : "DefaultProcessStartListPage.ivp",
      "config" : {
        "callSignature" : "DefaultProcessStartListPage",
        "outLink" : "DefaultProcessStartListPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1280 },
        "labelOffset" : { "x" : 36, "y" : 37 }
      },
      "connect" : { "id" : "f219", "to" : "f218" }
    }, {
      "id" : "f212",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 224, "y" : 640 }
      },
      "connect" : [
        { "id" : "f15", "to" : "S20" }
      ]
    }, {
      "id" : "f121",
      "type" : "Alternative",
      "name" : "isIvySecuritySystem?",
      "visual" : {
        "at" : { "x" : 1040, "y" : 816 },
        "labelOffset" : { "x" : 24, "y" : -15 }
      },
      "connect" : [
        { "id" : "f113", "to" : "f108", "condition" : "ch.ivy.addon.portalkit.util.SecuritySystemUtils.isIvySecuritySystem()" },
        { "id" : "f117", "to" : "f118" }
      ]
    }, {
      "id" : "f138",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 1504, "y" : 1728 }
      }
    }, {
      "id" : "f60",
      "type" : "RequestStart",
      "name" : "RelatedTasksOfCasePage.ivp",
      "config" : {
        "callSignature" : "RelatedTasksOfCasePage",
        "input" : {
          "params" : [
            { "name" : "caseId", "type" : "Long" },
            { "name" : "isBusinessCase", "type" : "Boolean" },
            { "name" : "caseName", "type" : "String" }
          ],
          "map" : {
            "out.caseId" : "param.caseId",
            "out.caseName" : "param.caseName",
            "out.isBusinessCase" : "param.isBusinessCase"
          }
        },
        "outLink" : "RelatedTasksOfCasePage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 960 },
        "labelOffset" : { "x" : 34, "y" : 37 }
      },
      "connect" : { "id" : "f61", "to" : "f59" }
    }, {
      "id" : "f163",
      "type" : "RequestStart",
      "name" : "showTaskAnalysis.ivp",
      "config" : {
        "callSignature" : "showTaskAnalysis",
        "outLink" : "showTaskAnalysis.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 896, "y" : 2016 },
        "labelOffset" : { "x" : 20, "y" : 40 }
      },
      "connect" : { "id" : "f168", "to" : "f167" }
    }, {
      "id" : "f6",
      "type" : "DialogCall",
      "name" : "Login",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.Login",
        "startMethod" : "start(String)",
        "call" : {
          "params" : [
            { "name" : "callbackUrl", "type" : "String" }
          ],
          "map" : {
            "param.callbackUrl" : "in.callbackUrl"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 440, "y" : 864 }
      }
    }, {
      "id" : "f99",
      "type" : "RequestStart",
      "name" : "AbsenceManagement.ivp",
      "config" : {
        "callSignature" : "AbsenceManagement",
        "outLink" : "AbsenceManagement.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 2112 },
        "labelOffset" : { "x" : 16, "y" : 45 }
      },
      "connect" : { "id" : "f104", "to" : "f101" }
    }, {
      "id" : "f0",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 1072, "y" : 144 }
      },
      "connect" : [
        { "id" : "f92", "to" : "S60" }
      ]
    }, {
      "id" : "f14",
      "type" : "RequestStart",
      "name" : "BackFromTaskDetails.ivp",
      "config" : {
        "callSignature" : "BackFromTaskDetails",
        "input" : {
          "params" : [
            { "name" : "endedTaskId", "type" : "Number" }
          ],
          "map" : {
            "out.backFromTaskDetails" : "true",
            "out.endedTaskId" : "param.endedTaskId"
          }
        },
        "outLink" : "BackFromTaskDetails.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 384 },
        "labelOffset" : { "x" : 34, "y" : 36 }
      },
      "connect" : { "id" : "f13", "to" : "f4", "via" : [ { "x" : 488, "y" : 384 } ] }
    }, {
      "id" : "f156",
      "type" : "DialogCall",
      "name" : [
        "Show Additional",
        "Case Details"
      ],
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.AdditionalCaseDetails",
        "startMethod" : "start(ch.ivyteam.ivy.workflow.ICase)",
        "call" : {
          "params" : [
            { "name" : "iCase", "type" : "ch.ivyteam.ivy.workflow.ICase" }
          ],
          "map" : {
            "param.iCase" : "in.caseSelected"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 1376, "y" : 1920 },
        "size" : { "width" : 128, "height" : 60 }
      },
      "connect" : { "id" : "f162", "to" : "f157" }
    }, {
      "id" : "f63",
      "type" : "RequestStart",
      "name" : "DefaultTaskListPage.ivp",
      "config" : {
        "callSignature" : "DefaultTaskListPage",
        "outLink" : "DefaultTaskListPage.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 640 },
        "labelOffset" : { "x" : 24, "y" : 37 }
      },
      "connect" : { "id" : "f213", "to" : "f212" }
    }, {
      "id" : "f235",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 1216, "y" : 2304 }
      }
    }, {
      "id" : "S20",
      "type" : "UserBpmnElement",
      "name" : "Task List Page",
      "elements" : [ {
          "id" : "S20-f69",
          "type" : "Script",
          "name" : [
            "build data model ",
            "and task view"
          ],
          "config" : {
            "output" : {
              "code" : [
                "import ch.ivy.addon.portalkit.enums.TaskAssigneeType;",
                "import ch.ivy.addon.portal.generic.view.TaskView;",
                "import ch.ivy.addon.portalkit.util.PermissionUtils;",
                "",
                "boolean hasReadAllTasksPermisson = PermissionUtils.checkReadAllTasksPermission();",
                "in.dataModel.setAdminQuery(hasReadAllTasksPermisson);",
                "in.dataModel.setTaskAssigneeType(TaskAssigneeType.ALL);",
                "",
                "in.taskView = TaskView.create().dataModel(in.dataModel).noTaskFoundMessage(\"\").showHeaderToolbar(false).createNewTaskView();"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 352, "y" : 160 },
            "size" : { "width" : 112, "height" : 48 }
          },
          "connect" : { "id" : "S20-f67", "to" : "S20-f84" }
        }, {
          "id" : "S20-f84",
          "type" : "SubProcessCall",
          "name" : "OpenPortalTasks",
          "config" : {
            "processCall" : "Functional Processes/OpenPortalTasks:useView(ch.ivy.addon.portal.generic.view.TaskView)",
            "call" : {
              "params" : [
                { "name" : "taskView", "type" : "ch.ivy.addon.portal.generic.view.TaskView" }
              ],
              "map" : {
                "param.taskView" : "in.taskView"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 544, "y" : 160 },
            "size" : { "width" : 104, "height" : 40 }
          },
          "connect" : { "id" : "S20-f1", "to" : "S20-g1" }
        }, {
          "id" : "S20-f73",
          "type" : "SubProcessCall",
          "name" : "Init data model",
          "config" : {
            "processCall" : "Functional Processes/InitializeTaskDataModel:call()",
            "output" : {
              "map" : {
                "out" : "in",
                "out.dataModel" : "result.dataModel"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 192, "y" : 160 }
          },
          "connect" : { "id" : "S20-f118", "to" : "S20-f69" }
        }, {
          "id" : "S20-g0",
          "type" : "EmbeddedStart",
          "name" : "in 1",
          "visual" : {
            "at" : { "x" : 64, "y" : 160 },
            "labelOffset" : { "x" : 18, "y" : 25 }
          },
          "parentConnector" : "f15",
          "connect" : { "id" : "S20-f0", "to" : "S20-f73" }
        }, {
          "id" : "S20-g1",
          "type" : "EmbeddedEnd",
          "name" : "out 1",
          "visual" : {
            "at" : { "x" : 672, "y" : 160 },
            "labelOffset" : { "x" : 21, "y" : 25 }
          },
          "parentConnector" : "f17"
        } ],
      "visual" : {
        "at" : { "x" : 352, "y" : 640 }
      },
      "connect" : { "id" : "f17", "to" : "f64" }
    }, {
      "id" : "f139",
      "type" : "Script",
      "name" : [
        "Store portal start ",
        "pmv "
      ],
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.enums.SessionAttribute;",
            "import ch.ivy.addon.portalkit.util.SecurityServiceUtils;",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.PORTAL_START_PMV_ID.toString(), ivy.task.getProcessModelVersion().getId());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 648, "y" : 144 },
        "size" : { "width" : 128, "height" : 60 }
      },
      "connect" : { "id" : "f23", "to" : "f22" }
    }, {
      "id" : "S70",
      "type" : "ServiceBpmnElement",
      "name" : [
        "Init data and",
        "display growl msg",
        "after finish task"
      ],
      "elements" : [ {
          "id" : "S70-f47",
          "type" : "Alternative",
          "name" : "Is first task?",
          "visual" : {
            "at" : { "x" : 152, "y" : 160 },
            "labelOffset" : { "x" : 16, "y" : -23 }
          },
          "connect" : [
            { "id" : "S70-f49", "to" : "S70-f4", "label" : {
                "name" : "Yes",
                "segment" : 0.49,
                "offset" : { "x" : 0, "y" : -13 }
              }, "condition" : "in.isFirstTask" },
            { "id" : "S70-f55", "to" : "S70-f7", "via" : [ { "x" : 152, "y" : 224 }, { "x" : 504, "y" : 224 } ], "label" : {
                "name" : "No",
                "segment" : 1.45,
                "offset" : { "x" : 0, "y" : 10 }
              } }
          ]
        }, {
          "id" : "S70-f4",
          "type" : "SubProcessCall",
          "name" : "InitializeTaskDataModel",
          "config" : {
            "processCall" : "Functional Processes/InitializeTaskDataModel:call()",
            "output" : {
              "map" : {
                "out" : "in",
                "out.dataModel" : "result.dataModel"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 312, "y" : 160 },
            "size" : { "width" : 144, "height" : 60 }
          },
          "connect" : { "id" : "S70-f31", "to" : "S70-f7" }
        }, {
          "id" : "S70-f12",
          "type" : "DialogCall",
          "name" : [
            "Display growl message",
            "after finish task"
          ],
          "config" : {
            "dialogId" : "ch.ivy.addon.portal.generic.PortalFinishTaskHandle",
            "startMethod" : "start(Boolean,ch.ivyteam.ivy.workflow.ICase)",
            "call" : {
              "params" : [
                { "name" : "isTaskFinished", "type" : "Boolean" },
                { "name" : "iCase", "type" : "ch.ivyteam.ivy.workflow.ICase" }
              ],
              "map" : {
                "param.isTaskFinished" : "in.isTaskFinished",
                "param.iCase" : "in.caseSelected"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 680, "y" : 160 },
            "size" : { "width" : 144, "height" : 60 }
          },
          "connect" : { "id" : "S70-f1", "to" : "S70-g1" }
        }, {
          "id" : "S70-f7",
          "type" : "Script",
          "name" : [
            "Set compactMode",
            "DataModel"
          ],
          "config" : {
            "output" : {
              "code" : [
                "import ch.ivy.addon.portalkit.enums.PortalPage;",
                "import ch.ivy.addon.portalkit.datamodel.TaskLazyDataModel;",
                "",
                "if(in.#portalPage == PortalPage.HOME_PAGE) {",
                "  in.dataModel.compactMode = true;",
                "}"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 504, "y" : 160 },
            "size" : { "width" : 128, "height" : 60 }
          },
          "connect" : { "id" : "S70-f2", "to" : "S70-f12" }
        }, {
          "id" : "S70-g0",
          "type" : "EmbeddedStart",
          "name" : "in 1",
          "visual" : {
            "at" : { "x" : 64, "y" : 160 },
            "labelOffset" : { "x" : 18, "y" : 25 }
          },
          "parentConnector" : "f36",
          "connect" : { "id" : "S70-f0", "to" : "S70-f47" }
        }, {
          "id" : "S70-g1",
          "type" : "EmbeddedEnd",
          "name" : "out 1",
          "visual" : {
            "at" : { "x" : 832, "y" : 160 },
            "labelOffset" : { "x" : 21, "y" : 25 }
          },
          "parentConnector" : "f40"
        } ],
      "visual" : {
        "at" : { "x" : 936, "y" : 304 },
        "size" : { "width" : 144, "height" : 64 }
      },
      "connect" : { "id" : "f40", "to" : "f5" }
    }, {
      "id" : "f51",
      "type" : "Script",
      "name" : [
        "Store portal start ",
        "pmv "
      ],
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.enums.SessionAttribute;",
            "import ch.ivy.addon.portalkit.util.SecurityServiceUtils;",
            "",
            "SecurityServiceUtils.setSessionAttribute(SessionAttribute.PORTAL_START_PMV_ID.toString(), ivy.task.getProcessModelVersion().getId());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 256, "y" : 864 },
        "size" : { "width" : 128, "height" : 60 }
      },
      "connect" : { "id" : "f8", "to" : "f6" }
    }, {
      "id" : "f74",
      "type" : "DialogCall",
      "name" : "ErrorPage",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.error.ErrorPage",
        "startMethod" : "start(String)",
        "call" : {
          "params" : [
            { "name" : "errorCode", "type" : "String" }
          ],
          "map" : {
            "param.errorCode" : "\"500\""
          }
        }
      },
      "visual" : {
        "at" : { "x" : 248, "y" : 1344 }
      }
    }, {
      "id" : "f167",
      "type" : "Script",
      "name" : "Check permission",
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.PermissionUtils;",
            "import ch.ivy.addon.portalkit.enums.PortalPermission;",
            "",
            "in.hasPermission = PermissionUtils.hasPermission(PortalPermission.STATISTIC_ANALYZE_TASK.getPermission());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1048, "y" : 2016 }
      },
      "connect" : { "id" : "f170", "to" : "f165" }
    }, {
      "id" : "S40",
      "type" : "UserBpmnElement",
      "name" : "Case Details Page",
      "elements" : [ {
          "id" : "S40-f106",
          "type" : "Script",
          "name" : "Find Case",
          "config" : {
            "security" : "system",
            "output" : {
              "code" : [
                "import ch.ivyteam.ivy.workflow.ICase;",
                "import ch.ivyteam.ivy.workflow.query.CaseQuery;",
                "",
                "out.caseSelected = ivy.wf.getGlobalContext().getCaseQueryExecutor().getFirstResult(CaseQuery.create().where().caseId().isEqual(in.caseId)) as ICase;"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 192, "y" : 160 }
          },
          "connect" : { "id" : "S40-f107", "to" : "S40-f104" }
        }, {
          "id" : "S40-f104",
          "type" : "SubProcessCall",
          "name" : "OpenPortalCaseDetails",
          "config" : {
            "processCall" : "Functional Processes/OpenPortalCaseDetailsHook:call(ch.ivyteam.ivy.workflow.ICase,Boolean)",
            "call" : {
              "params" : [
                { "name" : "caseData", "type" : "ch.ivyteam.ivy.workflow.ICase" },
                { "name" : "isShowBackButton", "type" : "Boolean" }
              ],
              "map" : {
                "param.caseData" : "in.caseSelected",
                "param.isShowBackButton" : "true"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 360, "y" : 160 },
            "size" : { "width" : 144, "height" : 60 }
          },
          "connect" : { "id" : "S40-f1", "to" : "S40-g1" }
        }, {
          "id" : "S40-g0",
          "type" : "EmbeddedStart",
          "name" : "in 1",
          "visual" : {
            "at" : { "x" : 64, "y" : 160 },
            "labelOffset" : { "x" : 18, "y" : 25 }
          },
          "parentConnector" : "f26",
          "connect" : { "id" : "S40-f0", "to" : "S40-f106" }
        }, {
          "id" : "S40-g1",
          "type" : "EmbeddedEnd",
          "name" : "out 1",
          "visual" : {
            "at" : { "x" : 512, "y" : 160 },
            "labelOffset" : { "x" : 21, "y" : 25 }
          },
          "parentConnector" : "f27"
        } ],
      "visual" : {
        "at" : { "x" : 248, "y" : 704 }
      },
      "connect" : { "id" : "f27", "to" : "f105" }
    }, {
      "id" : "f230",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 1216, "y" : 2208 }
      }
    }, {
      "id" : "f105",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 384, "y" : 704 }
      }
    }, {
      "id" : "f149",
      "type" : "RequestStart",
      "name" : "showTaskNoteHistory.ivp",
      "config" : {
        "callSignature" : "showTaskNoteHistory",
        "input" : {
          "params" : [
            { "name" : "selectedTaskId", "type" : "Long" }
          ],
          "map" : {
            "out.taskId" : "param.selectedTaskId"
          }
        },
        "outLink" : "showTaskNoteHistory.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 896, "y" : 1824 }
      },
      "connect" : { "id" : "f155", "to" : "f152" }
    }, {
      "id" : "f143",
      "type" : "Script",
      "name" : "Find case histories",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.CaseUtils;",
            "import ch.ivyteam.ivy.workflow.ICase;",
            "import ch.ivyteam.ivy.workflow.query.CaseQuery;",
            "import ch.ivy.addon.portalkit.service.GlobalSettingService;",
            "import java.util.ArrayList;",
            "import ch.ivyteam.ivy.workflow.TaskState;",
            "import ch.ivyteam.ivy.workflow.ITask;",
            "import ch.ivy.addon.portalkit.service.HistoryService;",
            "",
            "List<ITask> finishedTasks = new ArrayList();",
            "in.caseSelected = CaseUtils.findCase(in.caseId);",
            "for(ITask task : in.caseSelected.tasks().all()) {",
            "  if(task.getState() == TaskState.DONE",
            "  || task.getState() == TaskState.CREATED ",
            "  || task.getState() == TaskState.DESTROYED ",
            "  || task.getState() == TaskState.ZOMBIE) {",
            "    finishedTasks.add(task);",
            "  }",
            "}",
            "GlobalSettingService globalSettingService = new GlobalSettingService();",
            "boolean excludeSystemTasks = globalSettingService.findHideSystemTasksFromHistorySettingValue();",
            "boolean excludeSystemNotes = globalSettingService.findHideSystemNotesFromHistorySettingValue();",
            "",
            "List<ICase> cases = new ArrayList();",
            "cases.add(in.caseSelected);",
            "cases.addAll(CaseUtils.findSubCasesByBusinessCaseId(in.caseId));",
            "",
            "HistoryService historyService = new HistoryService();",
            "in.histories = historyService.getCaseHistories(in.caseId, finishedTasks, cases, excludeSystemTasks, excludeSystemNotes);"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1048, "y" : 1728 }
      },
      "connect" : { "id" : "f147", "to" : "f142" }
    }, {
      "id" : "S30",
      "type" : "UserBpmnElement",
      "name" : "Case List Page",
      "elements" : [ {
          "id" : "S30-f62",
          "type" : "SubProcessCall",
          "name" : [
            "Initialize case ",
            "data model"
          ],
          "config" : {
            "processCall" : "Functional Processes/InitializeCaseDataModel:call()",
            "output" : {
              "map" : {
                "out" : "in",
                "out.caseDataModel" : "result.caseDataModel"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 192, "y" : 160 }
          },
          "connect" : { "id" : "S30-f61", "to" : "S30-f59" }
        }, {
          "id" : "S30-f59",
          "type" : "Script",
          "name" : [
            "build data model",
            "and case view"
          ],
          "config" : {
            "output" : {
              "code" : [
                "import ch.ivy.addon.portalkit.util.PermissionUtils;",
                "import ch.ivy.addon.portalkit.util.SecurityServiceUtils;",
                "import ch.ivy.addon.portal.generic.view.CaseView;",
                "",
                "boolean hasReadAllCasesPermission = PermissionUtils.checkReadAllCasesPermission();",
                "in.caseDataModel.setAdminQuery(hasReadAllCasesPermission);",
                "",
                "in.caseView = CaseView.create().dataModel(in.caseDataModel).buildNewView();"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 352, "y" : 160 },
            "size" : { "width" : 128, "height" : 60 }
          },
          "connect" : { "id" : "S30-f60", "to" : "S30-f55" }
        }, {
          "id" : "S30-f55",
          "type" : "SubProcessCall",
          "name" : "OpenPortalCases",
          "config" : {
            "processCall" : "Functional Processes/OpenPortalCases:useView(ch.ivy.addon.portal.generic.view.CaseView)",
            "call" : {
              "params" : [
                { "name" : "view", "type" : "ch.ivy.addon.portal.generic.view.CaseView" }
              ],
              "map" : {
                "param.view" : "in.caseView"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 544, "y" : 160 },
            "size" : { "width" : 112, "height" : 48 }
          },
          "connect" : { "id" : "S30-f1", "to" : "S30-g1" }
        }, {
          "id" : "S30-g0",
          "type" : "EmbeddedStart",
          "name" : "in 1",
          "visual" : {
            "at" : { "x" : 64, "y" : 160 },
            "labelOffset" : { "x" : 18, "y" : 25 }
          },
          "parentConnector" : "f24",
          "connect" : { "id" : "S30-f0", "to" : "S30-f62" }
        }, {
          "id" : "S30-g1",
          "type" : "EmbeddedEnd",
          "name" : "out 1",
          "visual" : {
            "at" : { "x" : 672, "y" : 160 },
            "labelOffset" : { "x" : 21, "y" : 25 }
          },
          "parentConnector" : "f25"
        } ],
      "visual" : {
        "at" : { "x" : 352, "y" : 513 }
      },
      "connect" : { "id" : "f25", "to" : "f57" }
    }, {
      "id" : "f22",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 784, "y" : 144 }
      },
      "connect" : [
        { "id" : "f50", "to" : "f9", "condition" : "ch.addon.portal.generic.userprofile.homepage.HomepageUtils.isShowLegacyUI()" },
        { "id" : "f141", "to" : "f0", "via" : [ { "x" : 784, "y" : 96 }, { "x" : 1072, "y" : 96 } ] }
      ]
    }, {
      "id" : "f86",
      "type" : "Script",
      "name" : "Get embedInIFrame setting",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.service.IFrameService;",
            "out.embedInIFrame = IFrameService.embedInFrame(in.endedTaskId);"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 424, "y" : 1536 },
        "size" : { "width" : 160, "height" : 60 }
      },
      "connect" : { "id" : "f91", "to" : "f81" }
    }, {
      "id" : "f37",
      "type" : "RequestStart",
      "name" : "PortalManagement.ivp",
      "config" : {
        "callSignature" : "PortalManagement",
        "outLink" : "PortalManagement.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 896, "y" : 2424 },
        "labelOffset" : { "x" : 17, "y" : 37 }
      },
      "connect" : { "id" : "f239", "to" : "f137" }
    }, {
      "id" : "f41",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 1216, "y" : 2424 }
      }
    }, {
      "id" : "f137",
      "type" : "DialogCall",
      "name" : "PortalManagement",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.setting.PortalManagement",
        "startMethod" : "start()"
      },
      "visual" : {
        "at" : { "x" : 1048, "y" : 2424 }
      },
      "connect" : { "id" : "f129", "to" : "f41" }
    }, {
      "id" : "f188",
      "type" : "RequestStart",
      "name" : "DashboardDetails.ivp",
      "config" : {
        "callSignature" : "DashboardDetails",
        "input" : {
          "params" : [
            { "name" : "dashboardId", "type" : "String" },
            { "name" : "isPublicDashboard", "type" : "Boolean" }
          ],
          "map" : {
            "out.dashboardId" : "param.dashboardId",
            "out.isPublicDashboard" : "param.isPublicDashboard"
          }
        },
        "outLink" : "DashboardDetails.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 2536 },
        "labelOffset" : { "x" : 22, "y" : 41 }
      },
      "connect" : { "id" : "f198", "to" : "f193" }
    }, {
      "id" : "f193",
      "type" : "DialogCall",
      "name" : "PortalDashboardDetailModification",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.dashboard.PortalDashboardDetailModification",
        "startMethod" : "start(String,Boolean)",
        "call" : {
          "params" : [
            { "name" : "dashboardId", "type" : "String" },
            { "name" : "isPublicDashboard", "type" : "Boolean" }
          ],
          "map" : {
            "param.dashboardId" : "in.dashboardId",
            "param.isPublicDashboard" : "in.isPublicDashboard"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 280, "y" : 2536 },
        "size" : { "width" : 208, "height" : 60 }
      },
      "connect" : { "id" : "f199", "to" : "f195" }
    }, {
      "id" : "f195",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 464, "y" : 2536 }
      }
    }, {
      "id" : "f241",
      "type" : "TaskEnd",
      "visual" : {
        "at" : { "x" : 464, "y" : 2424 }
      }
    }, {
      "id" : "f243",
      "type" : "DialogCall",
      "name" : "PortalDashboardConfiguration",
      "config" : {
        "dialogId" : "ch.ivy.addon.portal.generic.dashboard.PortalDashboardConfiguration",
        "startMethod" : "start()"
      },
      "visual" : {
        "at" : { "x" : 264, "y" : 2424 },
        "size" : { "width" : 176, "height" : 60 }
      },
      "connect" : { "id" : "f242", "to" : "f241" }
    }, {
      "id" : "f177",
      "type" : "RequestStart",
      "name" : "PortalDashboardConfiguration.ivp",
      "config" : {
        "callSignature" : "PortalDashboardConfiguration",
        "outLink" : "PortalDashboardConfiguration.ivp",
        "showInStartList" : false
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 2424 },
        "labelOffset" : { "x" : 17, "y" : 37 }
      },
      "connect" : { "id" : "f173", "to" : "f243" }
    } ]
}