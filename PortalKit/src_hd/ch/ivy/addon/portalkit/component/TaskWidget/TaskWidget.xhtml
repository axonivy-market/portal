<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:cc="http://java.sun.com/jsf/composite"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:pm="http://primefaces.org/modena" xmlns:jsf="http://xmlns.jcp.org/jsf"
  xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<cc:interface componentType="IvyComponent">
  <cc:attribute name="outerPanelId" default="main-area-panel" />
  <cc:attribute name="styleClass" />
  <cc:attribute name="dataModel" />
  <cc:attribute name="chunkSize" shortDescription="Number of items to fetch for each lazy load" default="20" />
  <cc:attribute name="title" default="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/title')}" />
  <cc:attribute name="compactMode" default="true" type="java.lang.Boolean" />
  <cc:attribute name="onSwitchToCompactModeCompletedCallback" />
  <cc:attribute name="onSwitchToExpandedModeCompletedCallback" />
  <cc:attribute name="hideTaskFilter" default="false" shortDescription="Task filter text field is hidden or not"
    type="java.lang.Boolean" />
  <cc:attribute name="componentToUpdateWhenInCompactMode" />
  <cc:attribute name="componentToUpdateWhenInExpandedMode" />
  <cc:attribute name="selectedTaskId" />
  <cc:attribute name="selectedTaskServerId" />
  <cc:attribute name="showHeaderToolbar" />
  <cc:attribute name="messageIfNoTasks"
    default="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/noTask')}" />
</cc:interface>

<cc:implementation>
  <c:set var="showHeaderToolbar" value="#{cc.attrs.showHeaderToolbar eq null ? 'true' : cc.attrs.showHeaderToolbar}" />
  <f:event listener="#{logic.init(cc.attrs.compactMode, cc.attrs.dataModel)}" type="preRenderComponent" />
  <h:outputScript library="primefaces" name="jquery/jquery.js" target="head" />
  <h:outputScript name="task-widget.js" library="js" />

  <div id="#{cc.clientId}" class="widget task-widget #{cc.attrs.styleClass} js-task-widget">
    <div class="task-widget-header-container js-task-widget-header-container">
      <h:panelGroup id="task-widget-header" styleClass="widget-header task-widget-header" layout="block">
        <div class="widget-header-main">
          <div class="widget-header-main-title task-widget-header-content-title"><h:outputText value="#{cc.attrs.title}" escape="false" /></div>
          <ul class="widget-header-main-menu js-widget-header-menu" jsf:rendered="#{showHeaderToolbar}">
            <ui:fragment rendered="#{cc.attrs.compactMode}">
              <li class="u-underline-from-center js-ignore-selected-state"><p:commandLink id="switch-mode-command"
                  actionListener="#{logic.switchMode}"
                  update="task-view switch-mode-command priority-sort filter-view expiry-sort #{data.compactMode ? cc.attrs.componentToUpdateWhenInExpandedMode : cc.attrs.componentToUpdateWhenInCompactMode}"
                  oncomplete="taskWidget.setupScrollbar(); #{data.compactMode ? cc.attrs.onSwitchToExpandedModeCompletedCallback : cc.attrs.onSwitchToCompactModeCompletedCallback}();prepareMainMenuCategory()">
                  <f:actionListener binding="#{logic.clearExpandedTask()}" />
                  <f:actionListener binding="#{logic.clearFilter()}" />
                  <span class="fa fa-chevron-right switch-mode-command-icon" />
                  <h:outputText id="switch-mode-command-value"
                    value="#{data.compactMode ? ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/showFullTaskList') : ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/backToOverview')}" />
                </p:commandLink></li>
            </ui:fragment>
            <li class="u-underline-from-center #{data.dataModel.criteria.sortByPriority ? 'is-selected' : ''}"><p:commandLink
                id="priority-sort"
                update="#{data.compactMode ? cc.attrs.componentToUpdateWhenInCompactMode : cc.attrs.componentToUpdateWhenInExpandedMode} task-view-container"
                oncomplete="taskWidget.setupScrollbar(); prepareMainMenuCategory()">
                <f:actionListener binding="#{logic.clearExpandedTask()}" />
                <f:actionListener binding="#{logic.sortByPriority()}" />
                <span class="fa fa-chevron-right switch-mode-command-icon" />
                <h:outputText id="priority-sort-name"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/sortByPriority')}" />
              </p:commandLink></li>
            <li class="u-underline-from-center #{data.dataModel.criteria.sortByExpiryDate ? 'is-selected' : ''}"><p:commandLink
                id="expiry-sort"
                update="#{data.compactMode ? cc.attrs.componentToUpdateWhenInCompactMode : cc.attrs.componentToUpdateWhenInExpandedMode} task-view-container"
                oncomplete="taskWidget.setupScrollbar(); prepareMainMenuCategory()">
                <f:actionListener binding="#{logic.clearExpandedTask()}" />
                <f:actionListener binding="#{logic.sortByExpiry()}" />
                <span class="fa fa-chevron-right switch-mode-command-icon" />
                <h:outputText id="expiry-sort-name"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/sortByExpiryTime')}" />
              </p:commandLink></li>
          </ul>
        </div>
        <h:panelGroup styleClass="task-widget-header-content-filter" id="filter-view">
          <h:form id="filter-form" onsubmit="return false;">
            <ic:ch.ivy.addon.portalkit.component.Filter listener="#{logic.filter()}" id="filter-container"
              updateComponent="#{p:component('task-view-container')}" keywordStoresIn="#{data.keyword}"
              onCompletedCallback="taskWidget.setupScrollbar()"
              rendered="#{!data.compactMode and !cc.attrs.hideTaskFilter}" />
          </h:form>
        </h:panelGroup>
      </h:panelGroup>
    </div>

    <h:panelGroup layout="block" id="task-view">
      <h:panelGroup styleClass="widget-content-scroll-button js-widget-content-scroll-button" layout="block">
        <p:outputLabel id="task-widget-scroll-up-command"
          styleClass="js-task-start-list-scroll-up fa fa-chevron-up Fs14 u-unselectable u-display-none" />
      </h:panelGroup>
      <h:panelGroup id="task-view-container" layout="block" styleClass="task-view-container">
        <p:dataScroller id="task-list-scroller" value="#{data.dataModel}" var="task" chunkSize="#{cc.attrs.chunkSize}" lazy="true"
          mode="inline" rowIndexVar="rowIndex" styleClass="js-task-start-list">
          <!-- Task Item -->
          <ui:param name="isSelected"
              value="#{cc.attrs.selectedTaskId eq task.id and cc.attrs.selectedTaskServerId eq task.getApplicationRegister().serverId}" />
		  <h:panelGroup>
		    <f:event listener="#{logic.findPreExpandedTask(task, isSelected, rowIndex)}" type="preRenderComponent" />
		  </h:panelGroup>
		  <h:panelGroup id="task-start" layout="block"
		    class="#{(!data.compactMode) ? 'mod-expanded-mode' : ''} task-start-list-item task-start-list-item-position u-shadow-effect js-task-start-list-item #{task eq data.expandedTask ? 'show-task-details-mode' : ''}">
		    <h:panelGroup id="task-start-container" layout="block" class="task-start-container u-unselectable u-hover-effect">
		      <div id="task-start-task-info" class="task-start-link">
		        <p:commandLink id="show-hide-task-details-command" delay="100" styleClass="task-start-button"
		          onclick="if('#{data.compactMode}'=='true') {$('#task-start-#{rowIndex}-task-action-container>a').click(); return false;}"
		          actionListener="#{logic.toggleTaskDetails(task)}" oncomplete="taskWidget.setupScrollbar()"
		          update="task-start @(.show-task-details-mode)">
		          <f:passThroughAttribute name="data-content"
		            value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskStart/showDetailsHint')}" />
		          <div class="task-start-priority">
		            <h:panelGroup rendered="#{task.priority == 'LOW'}"
		              styleClass="fa fa-circle task-start-priority-icon task-priority-low" />
		            <h:panelGroup rendered="#{task.priority == 'NORMAL'}"
		              styleClass="fa fa-circle task-start-priority-icon task-priority-normal" />
		            <h:panelGroup rendered="#{task.priority == 'HIGH' or task.priority == 'EXCEPTION'}"
		              styleClass="fa fa-circle task-start-priority-icon task-priority-high" />
		          </div>
		          <div class="task-start-info">
		            <div class="task-start-info-header">
		              <h:outputText value="##{task.id}" />
		              <h:outputText id="task-state" value=" #{taskBean.getStateByITask(task).toUpperCase()}" />
		            </div>
		            <div class="task-start-info-content">
		              <h:outputText value="#{task.name}" />
		            </div>
		            <h:panelGroup rendered="#{task ne data.expandedTask}" styleClass="task-start-info-footer">
		              <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskStart/create')}: " />
		              <h:outputText value="#{task.startTimestamp}">
		                <f:convertDateTime dateStyle="long" type="date" locale="#{ivy.session.getContentLocale()}" />
		              </h:outputText>
		              <h:outputText value=" / #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskStart/expired')}: "
		                rendered="#{task.expiryTimestamp ne null}" />
		              <h:outputText value="#{task.expiryTimestamp}">
		                <f:convertDateTime dateStyle="long" type="date" locale="#{ivy.session.getContentLocale()}" />
		              </h:outputText>
		            </h:panelGroup>
		          </div>
		        </p:commandLink>
		      </div>
		
		      <div id="task-start-#{rowIndex}-task-action-container"
		        class="task-start-action #{data.compactMode ? 'mod-compact-mode' : 'task-start-action-before'}">
		        <p:commandLink id="task-reset-command"
		          rendered="#{!data.compactMode and task.state ne 'SUSPENDED' and task.canReset}" styleClass="task-command"
		          actionListener="#{logic.resetTask(task)}" update="task-state task-start-container">
		          <span class="action-icon tmi-box-arrow-left" />
		          <p:outputLabel value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/reset')}" />
		        </p:commandLink>
		        <p:commandLink id="task-delegate-command" rendered="#{!data.compactMode and task.canDelegate}"
		          styleClass="task-command" actionListener="#{logic.initDataToDelegate(task)}"
		          oncomplete="PF('task-delegate-dialog').show()" update="#{p:component('task-delegate-dialog')}">
		          <span class="action-icon tmi-box-arrow-right" />
		          <p:outputLabel value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/delegate')}" />
		        </p:commandLink>
		        <p:commandLink id="task-reserve-command"
		          rendered="#{!data.compactMode and (task.canPark or task.state eq 'PARKED')}"
		          disabled="#{task.state eq 'PARKED'}"
		          styleClass="task-command #{task.state eq 'PARKED' ? 'disabled-task-command' : ''}"
		          actionListener="#{logic.parkTask(task)}" update="task-state task-start-container">
		          <span class="action-icon tmi-box-arrow-toinside" />
		          <p:outputLabel
		            value="#{task.state eq 'PARKED'? ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/reserved') :ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/reserveTask')}" />
		        </p:commandLink>
		        <p:tooltip for="task-reserve-command"
		          value="#{task.state eq 'PARKED'? ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/freeReservationTaskTooltip'): ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/reserveTaskTooltip')}"
		          styleClass="task-command-tooltip" />
		        <h:panelGroup>
		          <p:commandLink id="task-start-command" rendered="#{task.state != 'RESUMED' and task.canResume}"
		            styleClass="task-command" actionListener="#{logic.openTask(task)}">
		            <span class="action-icon tmi-chevorn-right #{data.compactMode ? 'icon-compact-mode' : ''}" />
		            <p:outputLabel value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/openRequest')}"
		              rendered="#{!data.compactMode}" />
		          </p:commandLink>
		          <p:commandLink id="task-reset-and-start-command" rendered="#{task.state == 'RESUMED' and task.canResume}"
		            styleClass="task-command" oncomplete="PF('reset-task-dialog').show()"
		            actionListener="#{data.setSelectedTask(task)}">
		            <span class="action-icon tmi-chevorn-right #{data.compactMode ? 'icon-compact-mode' : ''}" />
		            <p:outputLabel value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/openRequest')}"
		              rendered="#{!data.compactMode}" />
		          </p:commandLink>
		        </h:panelGroup>
		      </div>
		    </h:panelGroup>
		
		    <h:panelGroup layout="block" id="task-details-container" styleClass="task-details">
		      <h:panelGroup rendered="#{task eq data.expandedTask}">
		        <div class="u-line-separator"></div>
		        <ic:ch.ivy.addon.portalkit.component.TaskItem id="task-details" task="#{data.expandedTask}">
		         	<cc:insertChildren/>
		        </ic:ch.ivy.addon.portalkit.component.TaskItem>
		      </h:panelGroup>
		    </h:panelGroup>
		  </h:panelGroup>
          
          <!-- End Task Item -->
        </p:dataScroller>
        <p:outputLabel styleClass="no-task-message" value="#{cc.attrs.messageIfNoTasks}"
          rendered="#{data.dataModel.rowCount eq 0}" />
      </h:panelGroup>
      <h:panelGroup styleClass="widget-content-scroll-button" layout="block">
        <p:outputLabel id="task-widget-scroll-down-command"
          styleClass="js-task-start-list-scroll-down fa fa-chevron-down Fs14 u-unselectable u-display-none" />
      </h:panelGroup>
      <h:panelGroup>
        <f:event listener="#{data.setFindingPreExpandedTaskFinished(true)}" type="preRenderComponent" />
      </h:panelGroup>
    </h:panelGroup>
  </div>

  <ui:include src="TaskDelegateDialog.xhtml" />

  <p:confirmDialog id="reset-task-dialog" appendTo="@(body)" widgetVar="reset-task-dialog"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/warning')}">
    <f:facet name="message">
      <h:outputText escape="false" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/resetTaskWarning')}" />
    </f:facet>
    <h:panelGroup styleClass="Fs14">
      <h:form id="reset-task-form">
        <p:commandButton actionListener="#{logic.resetAndOpenTask}"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" />
        <p:commandButton onclick="PF('reset-task-dialog').hide()"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}" type="button" />
      </h:form>
    </h:panelGroup>
  </p:confirmDialog>

  <p:dialog id="is-another-user-working-dialog" closeOnEscape="true"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskStart/errorStartTask')}"
    widgetVar="is-another-user-working-dialog" dynamic="true" modal="true" showEffect="fade" hideEffect="fade"
    resizable="false" appendTo="@(body)">
    <h:outputText id="is-another-user-working-message" value="#{data.isAnotherUserWorkingMessage}" />
    <f:facet name="footer">
      <p:commandButton id="close-command" onclick="PF('is-another-user-working-dialog').hide();"
        value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" />
    </f:facet>
  </p:dialog>
  <script type="text/javascript">
    var taskWidget = new TaskWidget("#{cc.attrs.outerPanelId}");
    $(function(){     
      //restore widget mode on page load
      if("#{cc.attrs.compactMode}" === "true" &amp;&amp; "#{data.compactMode}" === "false" &amp;&amp; "#{cc.attrs.onSwitchToExpandedModeCompletedCallback}") {
        invokeMethod(#{cc.attrs.onSwitchToExpandedModeCompletedCallback});
      }
      taskWidget.setupScrollbar();
    });
    
    function invokeMethod(method){
      method();
    }
  </script>
</cc:implementation>
</html>
