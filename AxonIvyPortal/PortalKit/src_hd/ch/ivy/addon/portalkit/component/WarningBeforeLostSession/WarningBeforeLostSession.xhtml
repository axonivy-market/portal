<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:pm="http://primefaces.org/mobile">

<cc:interface componentType="IvyComponent">
  <cc:attribute name="clientSideTimeOut" />
</cc:interface>
<cc:implementation>

  <p:confirmDialog header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/warning')}"
    message="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/warningBeforeLostSession/warningMessage')}"
    widgetVar="timeout-warning-dialog" appendTo="@(body)" closable="false" width="auto">
    <p:commandButton value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/warningBeforeLostSession/extend')}"
      styleClass="portal-ok-button" oncomplete="PF('timeout-warning-dialog').hide()"
      actionListener="#{logic.extendSession}" />
    <p:commandButton value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/warningBeforeLostSession/logout')}"
      styleClass="portal-cancel-button" actionListener="#{logic.logout}" oncomplete="returnHomePage()" />
  </p:confirmDialog>

  <h:form>
    <p:remoteCommand id="logout-and-show-dialog" name="logoutAndShowDialog" actionListener="#{logic.logout}"
      onstart="PF('timeout-warning-dialog').hide()" oncomplete="PF('viewExpiredExceptionDialog').show()" />
  </h:form>
  <script type="text/javascript">
     $(function() {
        const
        oneMinuteInMilisecond = 60000;
        var timeout = "#{cc.attrs.clientSideTimeOut}";
        var timeoutMinusOneMinute = timeout - oneMinuteInMilisecond;
        var timerForShowWarning;
        var timerForLogout;
        window.onload = resetTimerForShowWarning;

        document.onkeypress = resetTimerForShowWarning;
        document.onclick = resetTimerForShowWarning;
        document.onmousedown = resetTimerForShowWarning;
        document.ontouchstart = resetTimerForShowWarning;
        

        function resetTimerForShowWarning() {
          clearTimeout(timerForShowWarning);
          timerForShowWarning = setTimeout(showWarningDialog, timeoutMinusOneMinute);
          clearTimeout(timerForLogout);
        }

        function resetTimerForLogout() {
          clearTimeout(timerForLogout);
          timerForLogout = setTimeout(logoutAndShowDialog, oneMinuteInMilisecond);
        }

        function showWarningDialog() {
          PF('timeout-warning-dialog').show();
          resetTimerForLogout();
        }

        function returnHomePage() {
          showConfirmDialogBeforeUnload = false;
          window.open('#{userMenuBean.logoutPage}', '_self');
        }

      });
   </script>

</cc:implementation>
</html>