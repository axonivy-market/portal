<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<cc:interface componentType="IvyComponent">
  <cc:attribute name="case" type="ch.ivyteam.ivy.workflow.ICase" required="true" />
  <cc:attribute name="showItemDetailsHeader" />
  <cc:attribute name="showItemDetailRelated" />
  <cc:attribute name="showItemDetailsHistories" />
  <cc:attribute name="showItemDetailDocuments" />
  <cc:attribute name="showItemBackButton" />
  <cc:attribute name="descriptionComponentToUpdate" />
  <cc:attribute name="isWorkingOnTask" />
  <cc:attribute name="isFromDoneTask" />
</cc:interface>

<cc:implementation>
  <c:set var="case" value="#{cc.attrs.case}" />
  <c:set var="showItemDetailsHeader" value="#{cc.attrs.showItemDetailsHeader == null ? true:cc.attrs.showItemDetailsHeader}" />
  <c:set var="showItemDetailRelated" value="#{cc.attrs.showItemDetailRelated == null ? true:cc.attrs.showItemDetailRelated}"/>
  <c:set var="showItemDetailsHistories" value="#{cc.attrs.showItemDetailsHistories == null ?  true:cc.attrs.showItemDetailsHistories}"/>
  <c:set var="showItemDetailDocuments" value="#{cc.attrs.showItemDetailDocuments == null ? true:cc.attrs.showItemDetailDocuments}"/>
  <c:set var="showItemBackButton" value="#{cc.attrs.showItemBackButton == null ? true:cc.attrs.showItemBackButton}"/>
  <div class="ui-g">

    <h:panelGroup styleClass="ui-g-12" rendered="#{showItemDetailsHeader}" layout="block">
      <h:form id="case-detail-title-form" styleClass="ui-g-12 case-detail-title-header-container">
        <h:panelGroup id="case-detail-name" styleClass="case-detail-header" layout="block">
          <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/searchResult/case')}: "
            styleClass="case-detail-name-prefix" />
          <p:inplace id="case-name-edit-inplace" editor="true"
            disabled="#{!caseActionBean.canChangeName(case) or case.state eq 'DONE'}"
            saveLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/save')}"
            cancelLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
            widgetVar="case-detail-name-edit-inplace"
            label="#{empty case.getName() ? ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/caseNameNotAvailable') : case.name}"
            styleClass="case-detail-name-inplace-edit u-truncate-text">
            <p:inputText id="case-detail-name-input" value="#{case.name}" maxlength="200"
              styleClass="case-detail-name-input"
              onkeypress="if(event.keyCode == 13) {PF('case-name-edit-inplace').save()}" />
            <p:ajax event="save" update="case-detail-title-form" />
            <f:passThroughAttribute name="onclick"
              value="#{caseActionBean.canChangeName(case) ? event.stopPropagation():''}" />
          </p:inplace>
        </h:panelGroup>

        <p:commandLink id="back-to-cases" rendered="#{showItemBackButton}" onclick="backToPrevPage('#{cc.attrs.isFromDoneTask}');" styleClass="case-details-back-btn">
          <i class="fa fa-reply-all" />
          <p:spacer width="3px"/>
          <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/back')}"/>
        </p:commandLink>
        <p:remoteCommand name="backToCasesList" actionListener="#{caseBean.backToCasesList()}" process="@this" immediate="true" />
      </h:form>
    </h:panelGroup>

    <div class="case-detail-body ui-g-12 u-padding-0">
      <div class="ui-g">
        <!-- Custom panel at top section -->
        <cc:renderFacet name="caseItemDetailCustomTop" />

        <!-- General & description box -->
        <div class="ui-g-6 ui-xl-6 ui-lg-6 ui-md-12 ui-sm-12">
          <div class="card card-w-title case-detail-card">
            <div class="ui-g-12 u-padding-0 case-detail-section-title-container">
              <div class="case-detail-section-title u-truncate-text u-padding-0">
                <i class="fa fa-user-circle" />
                #{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/CaseDetail/DataDescription')}
              </div>

              <h:panelGroup class="u-padding-0 case-history-button-container u-truncate-text" rendered="#{caseWidgetBean.showCaseDetails}" layout="block">
              	<p:commandLink id="destroy-case-link" rendered="#{caseActionBean.canDestroy(case) and case.state ne 'DONE'}" 
                  styleClass="additional-case-details-link" immediate="true"
                  onclick="PF('destroy-case-dialog').show()">
                  <span class="action-icon fa fa-remove" />
                  <span class="display-full-text">#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/CaseDetail/destroyCase')}</span>
                  <span class="display-short-text">#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/Destroy')}</span>
                </p:commandLink>
                <p:tooltip for="destroy-case-link"
                  value="#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/CaseDetail/destroyCase')}"
                  trackMouse="true" hideEvent="mouseleave click"/>
                  
                <p:link id="show-additional-case-details-link" styleClass="additional-case-details-link" target="_blank"
                  href="#{caseWidgetBean.getAdditionalCaseDetailsPageUri(case)}"
                  rendered="#{caseWidgetBean.showCaseDetails}">
                  <i class="fa fa-external-link-square" />
                  <span class="display-full-text">#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/showAdditionalPage')}</span>
                  <span class="display-short-text">#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}</span>
                </p:link>
                <p:tooltip for="show-additional-case-details-link"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/showAdditionalPage')}"
                  trackMouse="true" hideEvent="mouseleave click"/>
              </h:panelGroup>
            </div>
            <div class="Separator ui-g-12 u-padding-0" />
            <div class="ui-g-12 u-padding-0">
              <ic:ch.ivy.addon.portalkit.component.CaseItemGeneralInformation id="general-information" case="#{case}" />
            </div>
            <div class="ui-g-12 u-padding-0">
              <ic:ch.ivy.addon.portalkit.component.CaseItemDescription id="description" case="#{case}"
                descriptionComponentToUpdate="#{cc.attrs.descriptionComponentToUpdate}" />
            </div>
          </div>
        </div>

        <!-- Histories box -->
        <h:panelGroup id="history-container" rendered="#{showItemDetailsHistories}" layout="block"
          styleClass="ui-g-6 ui-xl-6 ui-lg-6 ui-md-12 ui-sm-12">
          <div class="card card-w-title case-detail-card case-history-component">
            <ic:ch.ivy.addon.portalkit.component.CaseItemHistory id="case-histories" case="#{case}" />
          </div>
        </h:panelGroup>

        <!-- Custom panel at middle section -->
        <cc:renderFacet name="caseItemDetailCustomMiddle" />

        <!-- Related running box -->
        <h:panelGroup rendered="#{showItemDetailRelated}" styleClass="ui-g-6 ui-xl-6 ui-lg-6 ui-md-12 ui-sm-12">
          <div class="card card-w-title case-detail-card case-related-task-component">
            <ic:ch.ivy.addon.portalkit.component.CaseItemRelatedTask id="related-tasks" case="#{case}" isWorkingOnTask="#{cc.attrs.isWorkingOnTask}"/>
          </div>
        </h:panelGroup>

        <!-- Documents box -->
        <h:panelGroup rendered="#{showItemDetailDocuments}"
          styleClass="ui-g-6 ui-xl-6 ui-lg-6 ui-md-12 ui-sm-12">
          <div class="card card-w-title case-detail-card case-document-component">
            <ic:ch.ivy.addon.portalkit.component.CaseItemDocument id="document" case="#{case}"
              componentToUpdate="#{p:component('history-container')}" />
          </div>
        </h:panelGroup>

        <!-- Custom panel at bottom section -->
        <cc:renderFacet name="caseItemDetailCustomBottom" />
      </div>
    </div>
  </div>
  
  <p:confirmDialog id="destroy-case-confirmation-dialog"
    message="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/destroyCaseMessage')}" closeOnEscape="true"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}" widgetVar="destroy-case-dialog"
    appendTo="@(body)" severity="alert" responsive="true">
    <p:commandButton id="confirm-destruction" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/yes')}"
      actionListener="#{caseWidgetBean.destroyCase(case)}"
      oncomplete="PF('destroy-case-dialog').hide();backToCasesList();" />
    <p:commandButton value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/no')}"
      onclick="PF('destroy-case-dialog').hide();" type="button" styleClass="portal-cancel-button" />
  </p:confirmDialog>

  <script type="text/javascript">
      function backToPrevPage(isFromDoneTask) {
        if (document.referrer &amp;&amp; !isFromDoneTask) {
          window.history.back();
        } else {
          backToCasesList();
        }
      }
    </script>
</cc:implementation>
</html>