<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions" xmlns:pm="http://primefaces.org/mobile"
  xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<ui:composition>
  <p:dialog id="task-delegate-dialog" closeOnEscape="true" rendered="#{rowIndex == 0}"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/delegateTask')}"
    widgetVar="task-delegate-dialog" dynamic="true" modal="true" showEffect="fade" hideEffect="fade" resizable="false"
    appendTo="@(body)" styleClass="task-delegate-dialog">
    <c:choose>
      <c:when test="#{data.canDelegateTask != null and data.canDelegateTask}">
        <h:form id="task-delegate-form">
          <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDelegate/delegateTaskHeaderLabel')}" />
          <h:panelGroup id="activator-panel" layout="block" styleClass="delegate-dialog-activator-panel"
            rendered="#{not empty data.securityMemberData.ivyRoles or not empty data.securityMemberData.ivyUsers}">
            <p:row>
              <p:column>
                <div class="delegate-type-container">
                  <p:selectOneRadio id="activator-type-select" value="#{data.isUserDelegated}">
                    <f:selectItem itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDelegate/toUser')}"
                      itemValue="true" itemDisabled="#{empty data.securityMemberData.ivyUsers}" />
                    <f:selectItem itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDelegate/toGroup')}"
                      itemValue="false" itemDisabled="#{empty data.securityMemberData.ivyRoles}" />
                    <p:ajax event="change" listener="#{logic.changeAssignType}"
                      update="activator-panel task-delegate-form" />
                  </p:selectOneRadio>
                </div>
              </p:column>
            </p:row>
          </h:panelGroup>

          <h:panelGroup id="select-delegate-panel" layout="block" styleClass="select-delegate-panel">
            <p:autoComplete id="user-activator-select" rendered="#{data.isUserDelegated}" scrollHeight="400" dropdown="true"
              value="#{data.selectedUser}" completeMethod="#{logic.autoCompleteForUserDelegate}" var="user" itemLabel="#{user.getDisplayName()}"
              itemValue="#{user}" converter="pojoConverter" cache="true" queryDelay="500" maxResults="100" panelStyleClass="delegation-select-panel"
              moreText="#{component.suggestions.size() - component.maxResults} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}...">
              <f:event listener="#{logic.autoCompleteForUserDelegate}" type="preRenderComponent" />
              <p:ajax event="query" global="false" />
              <p:ajax event="itemSelect" listener="#{logic.checkValue}" update="proceed-task-delegate-command" />
              <p:column>
					<h:outputText value="#{userFormatBean.formatWithTip(user.displayName, user.memberName)}" />
			  </p:column>
            </p:autoComplete>

            <p:autoComplete id="group-activator-select" rendered="#{!data.isUserDelegated}" scrollHeight="400" dropdown="true" 
              value="#{data.selectedRole}" completeMethod="#{logic.autoCompleteForRoleDelegate}" var="role" panelStyleClass="delegation-select-panel"
              itemLabel="#{role.getDisplayName() != '' ? role.getDisplayName() : role.getMemberName()}"
              itemValue="#{role}" converter="pojoConverter" cache="true" queryDelay="500" maxResults="100"
              moreText="#{component.suggestions.size() - component.maxResults} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}..."
              selectLimit="100">
              <f:event listener="#{logic.autoCompleteForUserDelegate}" type="preRenderComponent" />
              <p:ajax event="query" global="false" />
              <p:ajax event="itemSelect" listener="#{logic.checkValue}" update="proceed-task-delegate-command" />
            </p:autoComplete>
          </h:panelGroup>

          <h:panelGroup layout="block" styleClass="ui-dialog-footer u-dialog-footer">
            <p:commandButton id="proceed-task-delegate-command" styleClass=""
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/delegate')}"
              actionListener="#{logic.delegateTask}" process=":#{p:component('activator-panel')}"
              disabled="#{data.disabledDelegateButton}" update="@(.task-view-container)"
              onsuccess="PF('task-delegate-dialog').hide(); setCookie('delegated','#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDelegate/message/delegateSuccess')}');"
              oncomplete="taskListToolKit.responsive(); taskWidget.setupScrollbar(); taskWidget.setupHeader()" />
            <p:spacer width="5px" />
            <p:commandButton id="cancel-task-delegate-command" styleClass="portal-cancel-button" type="button"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
              onclick="PF('task-delegate-dialog').hide()" />
          </h:panelGroup>
        </h:form>
      </c:when>
      <c:otherwise>
        <h:outputText
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskStart/cannotDelegateTaskMessage')}" />
      </c:otherwise>
    </c:choose>
  </p:dialog>
</ui:composition>
</html>