<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:cc="http://xmlns.jcp.org/jsf/composite"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:pm="http://primefaces.org/modena" xmlns:jsf="http://xmlns.jcp.org/jsf"
  xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<cc:interface componentType="IvyComponent">
  <cc:attribute name="outerPanelId" default="main-area-panel" />
  <cc:attribute name="styleClass" />
  <cc:attribute name="chunkSize" shortDescription="Number of items to fetch for each lazy load" default="20" />
  <cc:attribute name="title" default="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/tasks')}" />
  <cc:attribute name="selectedTaskId" />
  <cc:attribute name="showHeaderToolbar" default="true" />
  <cc:attribute name="noTaskFoundMessage" />
  <cc:facet name="taskListHeader" shortDescription="Header of task list" />
</cc:interface>

<cc:implementation>
  <c:set var="showHeaderToolbar" value="#{empty cc.attrs.showHeaderToolbar ? 'true' : cc.attrs.showHeaderToolbar}" />
  <c:set var="noTaskFoundMessage"
    value="#{empty cc.attrs.noTaskFoundMessage ? ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/noTask') : cc.attrs.noTaskFoundMessage}" />
  <h:outputScript library="primefaces" name="jquery/jquery.js" target="head" />
  <h:outputScript name="task-widget.js" library="js" />

  <div id="#{cc.clientId}" class="widget task-widget #{cc.attrs.styleClass} js-task-widget analysis-task-widget">
        <h:panelGroup id="filter-selection-container" layout="block" styleClass="filter-selection-container">
          <h:form id="filter-selection-form" class="filter-selection-form">
            <p:outputPanel id="filter-selection-panel" styleClass="filter-selection-task-analysis"
              rendered="#{(not empty data.taskPrivateFilters or not empty data.taskPublicFilters)}">
              <h:outputLabel value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filter')}" for="filter-name" />
              <p:commandLink id="filter-name" styleClass="filter-name"
                value="#{data.dataModel.selectedTaskAnalysisFilterData == null ? ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/NoSelection') : data.dataModel.selectedTaskAnalysisFilterData.filterName}"
                global="false" />
              <p:overlayPanel id="filter-name-overlay-panel" styleClass="filter-name-overlay-panel" for="filter-name"
                hideEffect="fade" my="left top" at="left bottom">
                <h:panelGroup id="public-filters" rendered="#{not empty data.taskPublicFilters}">
                  <div class="filter-type-label">
                    <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/publicFilter')}" />
                  </div>
                  <ui:repeat var="taskFilterData" value="#{data.taskPublicFilters}">
                    <h:panelGroup layout="block" styleClass="user-definied-filter-container">
                      <p:commandLink id="user-definied-filter" styleClass="user-definied-filter"
                        value="#{taskFilterData.filterName}" global="false" actionListener="#{logic.applyFilter(taskFilterData)}"
                        update="#{cc.clientId}:task-filters-container #{cc.clientId}:filter-selection-container #{cc.clientId}:statistic-result-list
                                              #{cc.clientId}:case-filters-container #{cc.clientId}:case-filter-add-container" />
                      <p:tooltip id="user-definied-filter-tooltip" for="user-definied-filter" value="#{taskFilterData.filterName}"
                        trackMouse="true" />
                      <p:commandLink id="delete-user-definied-filter-command"
                        rendered="#{taskAnalysisWidgetBean.isDeleteFilterEnabledFor(taskFilterData)}"
                        styleClass="fa fa-times-circle delete-user-definied-filter-command"
                        actionListener="#{logic.setFilterToBeDeleted(taskFilterData)}"
                        oncomplete="PF('delete-filter-confirmation-dialog').show();" />
                    </h:panelGroup>
                  </ui:repeat>
                </h:panelGroup>
                <p:separator rendered="#{not empty data.taskPublicFilters and not empty data.taskPrivateFilters}"
                  styleClass="filter-separator" />
                <h:panelGroup id="private-filters" rendered="#{not empty data.taskPrivateFilters}">
                  <div class="filter-type-label">
                    <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/privateFilter')}" />
                  </div>
                  <ui:repeat var="taskFilterData" value="#{data.taskPrivateFilters}">
                    <h:panelGroup layout="block" styleClass="user-definied-filter-container">
                      <p:commandLink id="user-definied-filter" styleClass="user-definied-filter"
                        value="#{taskFilterData.filterName}" global="false" actionListener="#{logic.applyFilter(taskFilterData)}"
                        update="#{cc.clientId}:task-filters-container #{cc.clientId}:filter-selection-container #{cc.clientId}:statistic-result-list
                                              #{cc.clientId}:case-filters-container #{cc.clientId}:case-filter-add-container" />
                      <p:tooltip id="user-definied-filter-tooltip" for="user-definied-filter" value="#{taskFilterData.filterName}"
                        trackMouse="true" />
                      <p:commandLink id="delete-user-definied-filter-command"
                        rendered="#{taskAnalysisWidgetBean.isDeleteFilterEnabledFor(taskFilterData)}"
                        styleClass="fa fa-times-circle delete-user-definied-filter-command"
                        actionListener="#{logic.setFilterToBeDeleted(taskFilterData)}"
                        oncomplete="PF('delete-filter-confirmation-dialog').show();" />
                    </h:panelGroup>
                  </ui:repeat>
                </h:panelGroup>
              </p:overlayPanel>
            </p:outputPanel>
          </h:form>
        </h:panelGroup>

        <!-- TASK FILTERS -->
        <p:fieldset id="task-filters-fieldset" legend="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/statistic/taskAnalysis/taskFilter')}" toggleable="false" styleClass="filter-fieldset MarTop20">
          <h:panelGroup id="task-filters-container" layout="block" styleClass="advanced-filter-container">
            <h:panelGroup id="additional-task-filter" styleClass="additional-filter-container">
              <c:set var="filterContainer" value="#{data.dataModel.taskFilterContainer}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskPriorityFilter filter="#{filterContainer.priorityFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskStateFilter filter="#{filterContainer.stateFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskCreationDateFilter filter="#{filterContainer.creationDateFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskExpiredDateFilter filter="#{filterContainer.expiredDateFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskDescriptionFilter filter="#{filterContainer.descriptionFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskResponsibleFilter filter="#{filterContainer.responsibleFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskNameFilter filter="#{filterContainer.NameFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskWorkerFilter filter="#{filterContainer.workerFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />
              <ic:ch.ivy.addon.portalkit.component.task.filter.TaskCategoryFilter filter="#{filterContainer.categoryFilter}"
                dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedTaskFilters}" resultContainerUpdated="#{false}" />

              <h:panelGroup id="task-filter-add-container" styleClass="filter-add-container" style="order: #{data.dataModel.selectedTaskFilters.size()}">
                <f:event listener="#{data.dataModel.initFilters()}" type="preRenderComponent" />
                <p:commandButton id="task-filter-add-action" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}"
                  styleClass="filter-add-button" icon="fa fa-caret-down" iconPos="right" type="button" />
                <p:overlayPanel id="task-filter-add-panel" styleClass="filter-add-panel" for="task-filter-add-action" my="left top"
                  at="left bottom">
                  <h:form id="task-filter-add-form">
                    <p:scrollPanel styleClass="filter-selector-container" mode="native">
                      <p:selectManyCheckbox id="task-filter-selection" layout="pageDirection"
                        valueChangeListener="#{data.dataModel.onFilterChange}" value="#{data.dataModel.selectedTaskFilters}"
                        converter="pojoConverter">
                        <p:ajax update="#{cc.clientId}:task-filters-container" global="false" />
                        <f:selectItems value="#{data.dataModel.taskFilters}" var="filter" itemLabel="#{filter.label()}"
                          itemValue="#{filter}" />
                      </p:selectManyCheckbox>
                      <p:selectBooleanCheckbox id="task-in-progress-checkbox" styleClass="in-progress-task-checkbox"
                        rendered="#{!data.dataModel.hasReadAllTasksPermisson()}" value="#{data.dataModel.inProgressFilterDisplayed}"
                        itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskState/RESUMED')}">
                        <p:ajax global="false" update="#{cc.clientId}:task-filters-container #{cc.clientId}:statistic-result-list" />
                      </p:selectBooleanCheckbox>
                      <p:tooltip for="task-in-progress-checkbox" trackMouse="true"
                        value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/DisplayTaskStartedByOtherUsersTooltip')}" />
                    </p:scrollPanel>
                  </h:form>
                </p:overlayPanel>
              </h:panelGroup>
            </h:panelGroup>
          </h:panelGroup>
        </p:fieldset>

        <!-- CASE FILTERS -->
        <p:fieldset id="case-filters-fieldset" legend="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/statistic/taskAnalysis/caseFilter')}" toggleable="false" styleClass="MarTop20 filter-fieldset">
          <h:panelGroup id="case-filters-container" layout="block" styleClass="advanced-filter-container">
            <h:panelGroup id="additional-case-filter" styleClass="additional-filter-container">
              <c:set var="caseFilterContainer" value="#{data.dataModel.caseFilterContainer}" />
              <cc:attribute name="filterContainerId" default="#{p:component('task-filters-container')}" />
              <cc:attribute name="filterAddingContainerId" default="#{p:component('filter-add-container')}" />
              <cc:attribute name="caseListId" default="#{p:component('case-list')}" />
              <ic:ch.ivy.addon.portalkit.component.cases.filter.CaseCreationDateFilter filter="#{caseFilterContainer.caseCreationDateFilter}"
                   dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedCaseFilters}" resultContainerUpdated="#{false}"/>
              <ic:ch.ivy.addon.portalkit.component.cases.filter.CaseFinishedDateFilter filter="#{caseFilterContainer.caseFinishedDateFilter}"
                   dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedCaseFilters}" resultContainerUpdated="#{false}"/> 
               <ic:ch.ivy.addon.portalkit.component.cases.filter.CaseDescriptionFilter componentId="case-description-filter" filter="#{caseFilterContainer.caseDescriptionFilter}"
                   dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedCaseFilters}" resultContainerUpdated="#{false}"/>
              <ic:ch.ivy.addon.portalkit.component.cases.filter.CaseStateFilter filter="#{caseFilterContainer.stateFilter}"
                   dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedCaseFilters}" resultContainerUpdated="#{false}"/>
              <ic:ch.ivy.addon.portalkit.component.cases.filter.CaseCreatorFilter filter="#{caseFilterContainer.caseCreatorFilter}"
                   dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedCaseFilters}" resultContainerUpdated="#{false}"/>
              <ic:ch.ivy.addon.portalkit.component.cases.filter.CaseNameFilter filter="#{caseFilterContainer.caseNameFilter}"
                   dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedCaseFilters}" resultContainerUpdated="#{false}"/>
              <ic:ch.ivy.addon.portalkit.component.cases.filter.CaseCategoryFilter filter="#{caseFilterContainer.caseCategoryFilter}"
                   dataModel="#{data.dataModel}" selectedFilters="#{data.dataModel.selectedCaseFilters}" resultContainerUpdated="#{false}"/>

              <h:panelGroup id="case-filter-add-container" styleClass="filter-add-container" style="order: #{data.dataModel.selectedCaseFilters.size()}">
                <p:commandButton id="case-filter-add-action" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}"
                  styleClass="filter-add-button" icon="fa fa-caret-down" iconPos="right" type="button" />
                <p:overlayPanel id="case-filter-add-panel" styleClass="filter-add-panel" for="case-filter-add-action" my="left top"
                  at="left bottom">
                  <h:form id="case-filter-add-form">
                    <p:scrollPanel styleClass="filter-selector-container" mode="native">
                      <p:selectManyCheckbox id="case-filter-selection" layout="pageDirection"
                        valueChangeListener="#{data.dataModel.onCaseFilterChange}" value="#{data.dataModel.selectedCaseFilters}"
                        converter="pojoConverter">
                        <p:ajax update="#{cc.clientId}:case-filters-container" global="false" />
                        <f:selectItems value="#{data.dataModel.caseFilters}" var="filter" itemLabel="#{filter.label()}"
                          itemValue="#{filter}" />
                      </p:selectManyCheckbox>
                    </p:scrollPanel>
                  </h:form>
                </p:overlayPanel>
              </h:panelGroup>
            </h:panelGroup>
          </h:panelGroup>
        </p:fieldset>

        <!-- FILTER BUTTONS -->
        <div id="filter-buttons-container" class="MarTop20 filter-buttons-container">
          <p:commandButton id="apply-filter" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/statistic/taskAnalysis/applyFilter')}" process="@(.statistic-result-list)" update="@(.statistic-result-list)" />
          <p:commandButton id="filter-save-action" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/saveFilter')}"
            icon="fa fa-save" update="save-filter-set-dialog #{cc.clientId}:filter-selection-container" resetValues="true"
            oncomplete="PF('save-filter-set-dialog').show();" />
        </div>

        <!-- RESULT SECTION -->
        <ui:include src="StatisticResult.xhtml" />

        <!-- FOOTER -->
        <p:commandButton id="back-button" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/back')}" icon="fa fa-arrow-left"
          styleClass="buttonDelegate floatLeft MarTop50" actionListener="#{logic.redirectToStatisticPage}" update="@(form)"/>
        <p:spacer width="5" />
  </div>

  <p:dialog id="save-filter-set-dialog" widgetVar="save-filter-set-dialog" appendTo="@(body)"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/saveFilter')}" resizable="false"
    width="575" modal="true" closeOnEscape="true" styleClass="save-filter-set-dialog">
    <p:messages autoUpdate="true" />
    <h:form id="filter-save-form">
      <h:panelGrid columns="2" styleClass="save-filter-set-panel"
        columnClasses="save-filter-set-panel-column-1, save-filter-set-panel-column-2">
        <p:outputLabel id="save-filter-set-name-label" for="save-filter-set-name-input"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterName')}" />
        <p:inputText id="save-filter-set-name-input" value="#{data.filterSetName}" required="true" maxlength="20" />
        <p:outputLabel id="save-filter-type-label" for="save-filter-type-radio"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterVisibility')}" />
        <p:selectOneRadio id="save-filter-type-radio" value="#{data.filterType}">
          <f:selectItem id="only-me"
            itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterTypeOnlyMe')}"
            itemValue="ONLY_ME" />
          <f:selectItem id="all-users" itemDisabled="#{!permissionBean.hasAdminPermission()}"
            itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterTypeAllUsers')}"
            itemValue="ALL_USERS" />
        </p:selectOneRadio>
      </h:panelGrid>
      <h:panelGroup layout="block" class="u-dialog-footer ui-dialog-footer">
        <p:commandButton id="filter-save-command"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" process="@form"
          oncomplete="if (args &amp;&amp; !args.validationFailed) {PF('save-filter-set-dialog').hide();}"
          actionListener="#{logic.saveFilter}" update="#{cc.clientId}:filter-save-form #{cc.clientId}:filter-selection-container">
        </p:commandButton>
        <p:spacer width="5px" />
        <p:commandButton type="button" styleClass="portal-cancel-button"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
          actionListener="#{logic.clearSaveFilterDialog}" onclick="PF('save-filter-set-dialog').hide();">
        </p:commandButton>
      </h:panelGroup>
    </h:form>
  </p:dialog>

  <p:confirmDialog id="delete-filter-confirmation-dialog"
    message="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterDeletionConfirmation')}"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}"
    widgetVar="delete-filter-confirmation-dialog" appendTo="@(body)" severity="alert">
    <p:commandButton id="confirm-delete" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/yes')}"
      actionListener="#{logic.deleteFilter()}"
      oncomplete="PF('delete-filter-confirmation-dialog').hide();"
      update="task-filters-container filter-selection-form statistic-result-list task-filter-add-form
            case-filters-container case-filter-add-container" />
    <p:commandButton value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/no')}"
      onclick="PF('delete-filter-confirmation-dialog').hide();" type="button" styleClass="portal-cancel-button" />
  </p:confirmDialog>
</cc:implementation>
</html>