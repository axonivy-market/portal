<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:pm="http://primefaces.org/mobile" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
  xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions">

<cc:interface componentType="IvyComponent">
  <cc:attribute name="dataModel" type="ch.ivy.addon.portalkit.datamodel.TaskLazyDataModel"
    shortDescription="Used if filter can be removed" required="true" />
  <cc:attribute name="taskFilter" required="true" type="ch.ivy.addon.portalkit.taskfilter.TaskFilter" />
  <cc:attribute name="updateListener" />
  <cc:attribute name="removeListener" />
  <cc:attribute name="containerStyleClass" />
  <cc:attribute name="buttonStyleClass" />
  <cc:attribute name="removeIconStyleClass" />
  <cc:attribute name="displayFooterButtons" default="true" />
  <cc:attribute name="dismissableOverlayPanel" default="true"
    shortDescription="If there is a component with a popup like calendar, autocomplete placed inside the overlay panel, popup part might exceed the boundaries of panel and clicking the outside hides the panel. Set false in this case" />
  <cc:attribute name="forceRendered" type="java.lang.Boolean" />
  <cc:attribute name="position" type="java.lang.Integer" />
</cc:interface>

<cc:implementation>
  <c:set var="dataModel" value="#{cc.attrs.dataModel}" />
  <c:set var="selectedFilters" value="#{dataModel.selectedFilters}" />
  <c:set var="taskFilter" value="#{cc.attrs.taskFilter}" />
  <c:set var="widgetVarPanel" value="#{fn:replace(cc.clientId, ':', '-')}-panel" />
  <c:set var="taskContainerId" value="#{p:component('task-view-container')}" />
  <c:set var="renderedFilter" value="#{(not empty dataModel and selectedFilters.contains(taskFilter)) or cc.attrs.forceRendered}" />

  <h:panelGroup rendered="#{renderedFilter}"
    style="order: #{not empty cc.attrs.position ? cc.attrs.position : selectedFilters.indexOf(taskFilter)}">
    <h:form id="filter-open-form">
      <h:panelGroup id="advanced-filter-item-container" styleClass="advanced-filter #{cc.attrs.containerStyleClass}">
        <p:commandButton id="advanced-filter-command" type="button"
          value="#{cc.attrs.taskFilter.label()}: #{cc.attrs.taskFilter.value()}"
          styleClass="advanced-filter-command #{cc.attrs.buttonStyleClass} #{facesContext.validationFailed ? 'error-filter' : ''} #{cc.attrs.buttonStyleClass}" />
        <p:commandLink id="advanced-filter-remove-command"
          styleClass="fa fa-times-circle advanced-filter-icon #{cc.attrs.removeIconStyleClass}"
          actionListener="#{dataModel.removeFilter(taskFilter)}" global="false"
          update="#{p:component('advanced-filter-container')} #{p:component('filter-add-container')} #{p:component('task-view-container')}"
          oncomplete="taskWidget.setupScrollbar(); taskWidget.setupHeader()">
          <f:actionListener binding="#{cc.attrs.removeListener}" />
        </p:commandLink>
      </h:panelGroup>
    </h:form>

    <h:form id="filter-input-form">
      <p:overlayPanel id="advanced-filter-panel" widgetVar="#{widgetVarPanel}"
        dismissable="#{cc.attrs.dismissableOverlayPanel}" styleClass="advanced-filter-panel #{widgetVarPanel}"
        for="#{cc.clientId}:filter-open-form:advanced-filter-command" my="left top" at="left bottom"
        onHide="$(this.targetElement).parents('form').siblings('form').find('.portal-cancel-button').click();">
        <h:panelGroup id="advanced-filter-panel-content" layout="block" styleClass="ui-overlaypanel-filter-content">
          <p:messages id="filter-error-messages" />
          <cc:insertChildren />
        </h:panelGroup>

        <h:panelGroup id="advanced-filter-panel-footer" layout="block" styleClass="ui-overlaypanel-footer"
          rendered="#{cc.attrs.displayFooterButtons}">
          <p:commandButton id="update-command" styleClass="" global="false"
            value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/apply')}"
            actionListener="#{taskFilter.validate()}"
            update="#{cc.clientId}:filter-open-form @form"
            oncomplete="if (args &amp;&amp; args.validationFailed) PF('#{widgetVarPanel}').show(); taskWidget.setupScrollbar(); taskWidget.setupHeader()">
            <f:actionListener binding="#{logic.updateTasksByFilter(taskContainerId)}" />
            <f:actionListener binding="#{cc.attrs.updateListener}" />
          </p:commandButton>
          <p:spacer width="5" />
          <p:commandButton id="cancel-command" styleClass="portal-cancel-button" process="@this" global="false"
            value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
            actionListener="#{taskFilter.validate()}"
            update="#{cc.clientId}:filter-open-form @form" resetValues="true" oncomplete="PF('#{widgetVarPanel}').hide()">
          </p:commandButton>
        </h:panelGroup>
      </p:overlayPanel>
    </h:form>
  </h:panelGroup>
</cc:implementation>
</html>