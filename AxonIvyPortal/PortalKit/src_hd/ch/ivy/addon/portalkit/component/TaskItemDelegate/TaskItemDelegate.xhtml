<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<cc:interface componentType="IvyComponent">
  <cc:attribute name="task" shortDescription="Task" type="ch.ivyteam.ivy.workflow.ITask" />
  <cc:attribute name="onDelegateComplete" />
  <cc:attribute name="componentToUpdate" />
</cc:interface>

<cc:implementation>
  <p:remoteCommand id="init-data-to-delegate-rc" name="initDataToDelegate" global="false"
    actionListener="#{logic.initDataToDelegate(cc.attrs.task)}"
    oncomplete="PF('task-delegate-dialog').show()"
    update="#{cc.clientId}:task-delegate-dialog"
    process="@this"/>

  <p:dialog id="task-delegate-dialog" closeOnEscape="true" header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/delegateTask')}"
    widgetVar="task-delegate-dialog" dynamic="true" modal="true" showEffect="fade" hideEffect="fade" resizable="false" appendTo="@(body)"
    styleClass="task-delegate-dialog" responsive="true">

    <h:panelGroup rendered="#{data.canDelegateTask}" styleClass="ui-g" layout="block">
      <h:form id="task-delegate-form" styleClass="ui-g-12">
        <span>#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDelegate/delegateTaskHeaderLabel')}</span>
        <h:panelGroup id="activator-panel" layout="block" styleClass="delegate-dialog-activator-panel"
          rendered="#{not empty data.rolesToDelegate or not empty data.usersToDelegate}">
          <div class="delegate-type-container">
            <p:selectOneRadio id="activator-type-select" value="#{data.isUserDelegated}">
              <f:selectItem itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDelegate/toUser')}" itemValue="true"
                itemDisabled="#{data.isEmptyUsers}" />
              <f:selectItem itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDelegate/toGroup')}" itemValue="false"
                itemDisabled="#{data.isEmptyRoles}" />
              <p:ajax event="change" listener="#{logic.changeAssignType}" update="activator-panel select-delegate-panel delegate-action-panel" />
            </p:selectOneRadio>
          </div>
        </h:panelGroup>

        <h:panelGroup id="select-delegate-panel" layout="block" styleClass="select-delegate-panel">
          <ic:ch.ivy.addon.portalkit.component.UserSelection id="user-activator-component"
            componentId="user-activator-select" selectedUser="#{data.selectedUser}"
            rendered="#{data.isUserDelegated}" completeMethod="#{logic.autoCompleteForUserDelegate}"
            isRenderedMessage="false">
            <p:column>
              <h:outputText value="#{userFormatBean.formatWithTip(user.displayName, user.memberName)}" />
            </p:column>
            <f:facet name="event">
              <p:ajax event="itemSelect" listener="#{data.setDisabledDelegateButton(false)}"
                update="#{cc.clientId}:task-delegate-form:proceed-task-delegate-command" />
           </f:facet>
          </ic:ch.ivy.addon.portalkit.component.UserSelection>

          <ic:ch.ivy.addon.portalkit.component.RoleSelection id="group-activator-select-component" scrollHeight="400"
            componentId="group-activator-select" selectedRole="#{data.selectedRole}" rendered="#{!data.isUserDelegated}"
            cache="true" queryDelay="500" completeMethod="#{logic.autoCompleteForRoleDelegate}"
            moreText="#{component.suggestions.size() - component.maxResults} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}..."
            isRenderedMessage="false">
            <f:facet name="event">
              <p:ajax event="itemSelect" listener="#{data.setDisabledDelegateButton(false)}"
                update="#{cc.clientId}:task-delegate-form:proceed-task-delegate-command" />
            </f:facet>
          </ic:ch.ivy.addon.portalkit.component.RoleSelection>
        </h:panelGroup>

        <h:panelGroup id="delegate-comment-panel" layout="block" styleClass="delegate-comment-panel">
          <span>#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/comment')}</span>
          <div class="input-text-area-delegate-message-container">
            <p:inputTextarea id="input-text-area-delegate-message" styleClass="input-text-area-delegate-message" value="#{data.taskDelegationComment}"
              autoResize="false" rows="5" placeholder="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDetails/addNoteHelpText')}" />
          </div>
        </h:panelGroup>

        <h:panelGroup id="delegate-action-panel" layout="block" styleClass="ui-dialog-footer u-dialog-footer u-no-padding-right">
          <p:commandButton id="proceed-task-delegate-command" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/delegate')}"
            actionListener="#{logic.delegateTask}" process=":#{p:component('activator-panel')} delegate-comment-panel" disabled="#{data.disabledDelegateButton}"
            update="@(.task-view-container) #{cc.attrs.componentToUpdate}"
            oncomplete="#{cc.attrs.onDelegateComplete}"
            onsuccess="PF('task-delegate-dialog').hide();" />
          <p:spacer width="5px" />
          <p:commandButton id="cancel-task-delegate-command" styleClass="portal-cancel-button" type="button"
            value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}" onclick="PF('task-delegate-dialog').hide()" />
        </h:panelGroup>
      </h:form>
    </h:panelGroup>
    <h:panelGroup rendered="#{!data.canDelegateTask}" styleClass="ui-g" layout="block">
      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskStart/cannotDelegateTaskMessage')}"
        styleClass="ui-g-12"/>
    </h:panelGroup>
  </p:dialog>

</cc:implementation>
</html>