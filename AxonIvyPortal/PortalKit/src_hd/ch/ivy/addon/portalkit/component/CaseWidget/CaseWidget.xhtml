<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions" xmlns:jsf="http://xmlns.jcp.org/jsf"
  xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<cc:interface componentType="IvyComponent">
  <cc:attribute name="outerPanelId" default="main-area-panel" />
  <cc:attribute name="dataModel" shortDescription="List of cases to be displayed" />
  <cc:attribute name="chunkSize" shortDescription="Number of items to fetch for each lazy load" default="20" />
  <cc:attribute name="emptyMessage"
    default="#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/defaultEmptyMessage')}"
    shortDescription="A message when the cases are empty" />
  <cc:attribute name="hideCaseFilter" default="false" shortDescription="Case filter text field is hidden or not"
    type="java.lang.Boolean" />
  <cc:attribute name="title" default="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/cases')}" />
  <cc:attribute name="autoSelectCaseId" />
  <cc:attribute name="filterGroupId" />
  <cc:facet name="emptyMessage" />
</cc:interface>

<cc:implementation>
  <c:set var="outerPanelId" value="#{empty cc.attrs.outerPanelId ? 'main-area-panel' : cc.attrs.outerPanelId}" />

  <h:outputScript name="case-widget.js" library="js" />
  <h:outputScript name="datascroller.js" library="js" />
  <div id="#{cc.clientId}" class="widget case-widget-container">
    <h:panelGroup id="case-widget-header" styleClass="widget-header" layout="block">
      <div class="case-widget-top-header js-widget-header">
        <h:panelGroup id="case-widget-title" styleClass="case-widget-top-header-main-title-container">
          <h:outputText styleClass="case-widget-top-header-main-title" rendered="#{!data.dataModel.disableCaseCount}" 
            value="#{cc.attrs.title} (#{data.dataModel.rowCount})" />
          <h:outputText styleClass="case-widget-top-header-main-title" rendered="#{data.dataModel.disableCaseCount}" 
            value="#{cc.attrs.title}" />
        </h:panelGroup>

        <h:form id="filter-selection-form" class="filter-selection-form" rendered="#{!cc.attrs.hideCaseFilter}">
          <p:outputPanel id="filter-selection-panel"
            rendered="#{(not empty data.privateFilters or not empty data.publicFilters)}">
            <h:outputLabel value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filter')}"
              for="filter-name" />
            <p:commandLink id="filter-name" styleClass="filter-name"
              value="#{data.dataModel.selectedFilterData == null ? ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/NoSelection') : data.dataModel.selectedFilterData.filterName}"
              global="false" />
            <p:overlayPanel id="filter-name-overlay-panel" styleClass="filter-name-overlay-panel" for="filter-name"
              hideEffect="fade" my="left top" at="left bottom">
              <h:panelGroup id="private-filters" rendered="#{not empty data.publicFilters}">
                <div class="filter-type-label">
                  <h:outputText
                    value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/publicFilter')}" />
                </div>
                <ui:repeat var="filterData" value="#{data.publicFilters}">
                  <h:panelGroup layout="block" styleClass="user-definied-filter-container">
                    <p:commandLink id="user-definied-filter" styleClass="user-definied-filter"
                      value="#{filterData.filterName}" global="false" actionListener="#{logic.applyFilter(filterData)}"
                      update="#{cc.clientId}:advanced-filter-container #{cc.clientId}:case-widget-header #{cc.clientId}:case-list"
                      oncomplete="caseWidget.setUpScrollbar();caseWidget.setupHeader();" />
                    <p:tooltip id="user-definied-filter-tooltip" for="user-definied-filter"
                      value="#{filterData.filterName}" trackMouse="true" />
                    <p:commandLink id="delete-user-definied-filter-command"
                      rendered="#{caseWidgetBean.isDeleteFilterEnabledFor(filterData)}"
                      styleClass="fa fa-times-circle delete-user-definied-filter-command"
                      actionListener="#{logic.setFilterToBeDeleted(filterData)}"
                      oncomplete="PF('delete-filter-confirmation-dialog').show();" />
                  </h:panelGroup>
                </ui:repeat>
              </h:panelGroup>
              <p:separator rendered="#{not empty data.publicFilters and not empty data.privateFilters}"
                styleClass="filter-separator" />
              <h:panelGroup id="public-filters" rendered="#{not empty data.privateFilters}">
                <div class="filter-type-label">
                  <h:outputText
                    value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/privateFilter')}" />
                </div>
                <ui:repeat var="filterData" value="#{data.privateFilters}">
                  <h:panelGroup layout="block" styleClass="user-definied-filter-container">
                    <p:commandLink id="user-definied-filter" styleClass="user-definied-filter"
                      value="#{filterData.filterName}" global="false" actionListener="#{logic.applyFilter(filterData)}"
                      update="#{cc.clientId}:advanced-filter-container #{cc.clientId}:case-widget-header #{cc.clientId}:case-list"
                      oncomplete="caseWidget.setUpScrollbar(); caseWidget.setupHeader();" />
                    <p:tooltip id="user-definied-filter-tooltip" for="user-definied-filter"
                      value="#{filterData.filterName}" trackMouse="true" />
                    <p:commandLink id="delete-user-definied-filter-command"
                      rendered="#{caseWidgetBean.isDeleteFilterEnabledFor(filterData)}"
                      styleClass="fa fa-times-circle delete-user-definied-filter-command"
                      actionListener="#{logic.setFilterToBeDeleted(filterData)}"
                      oncomplete="PF('delete-filter-confirmation-dialog').show();" />
                  </h:panelGroup>
                </ui:repeat>
              </h:panelGroup>
            </p:overlayPanel>
          </p:outputPanel>
        </h:form>
      </div>
      <h:panelGroup styleClass="widget-header-content-filter mod-expanded-mode" id="expanded-mode-filter-view">
        <h:form id="case-basic-filter-form" onsubmit="return false;">
          <ic:ch.ivy.addon.portalkit.component.Filter keywordStoresIn="#{data.dataModel.queryCriteria.keyword}"
            updateComponent="#{cc.clientId}:case-list" icon="fa fa-filter" styleClass="widget-header-filter-input"
            placeholder="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/filterTextPlaceholder')}"
            onCompletedCallback="caseWidget.setUpScrollbar();caseWidget.setupHeader();" />
        </h:form>
      </h:panelGroup>
      <h:panelGroup id="filter-add-container" styleClass="filter-add-container" rendered="#{!cc.attrs.hideCaseFilter}">
        <f:event listener="#{data.dataModel.initFilters()}" type="preRenderComponent" />

        <p:commandButton id="filter-add-action" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}"
          styleClass="filter-add-button" icon="fa fa-caret-down" iconPos="right" type="button" />
        <p:overlayPanel id="filter-add-panel" styleClass="filter-add-panel" for="filter-add-action" my="left top"
          at="left bottom">
          <h:form id="filter-add-form">
            <p:scrollPanel styleClass="filter-selector-container" mode="native">
              <p:selectManyCheckbox id="filter-selection" layout="pageDirection"
                valueChangeListener="#{data.dataModel.onFilterChange}" value="#{data.dataModel.selectedFilters}"
                converter="pojoConverter">
                <p:ajax update="#{cc.clientId}:advanced-filter-container #{cc.clientId}:case-list" global="false"
                  oncomplete="caseWidget.setUpScrollbar();caseWidget.setupHeader();" />
                <f:selectItems value="#{data.dataModel.filters}" var="filter" itemLabel="#{filter.label()}"
                  itemValue="#{filter}" />
              </p:selectManyCheckbox>
            </p:scrollPanel>
          </h:form>
        </p:overlayPanel>
        <p:commandButton id="filter-save-action"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/saveFilter')}"
          styleClass="filter-add-button" icon="fa fa-save" iconPos="right" update="save-filter-set-dialog"
          resetValues="true"
          oncomplete="PF('save-filter-set-dialog').show();" />
      </h:panelGroup>
    </h:panelGroup>

    <h:panelGroup id="advanced-filter-container" layout="block" styleClass="advanced-filter-container">
      <h:panelGroup styleClass="additional-filter-container js-additional-filter-container"
        rendered="#{!cc.attrs.hideCaseFilter}">
        <cc:renderFacet name="caseFilter" />
      </h:panelGroup>
    </h:panelGroup>

    <h:panelGroup id="widget-column-header" class="widget-column-header js-case-widget-column-header">
      <ui:include src="ColumnHeader.xhtml">
        <ui:param name="id" value="name-desc-column-header" />
        <ui:param name="styleClass" value="case-list-header-cell case-list-name-desc-header-cell" />
        <ui:param name="componentToBeUpdated" value="" />
        <ui:param name="sortedField" value="NAME" />
        <ui:param name="sortable" value="true" />
        <ui:param name="value"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/NAME')}" />
      </ui:include>
      <ui:include src="ColumnHeader.xhtml">
        <ui:param name="id" value="id-column-header" />
        <ui:param name="styleClass" value="TexAlCenter case-list-header-cell" />
        <ui:param name="componentToBeUpdated" value="" />
        <ui:param name="sortedField" value="ID" />
        <ui:param name="sortable" value="true" />
        <ui:param name="value" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/caseId')}" />
      </ui:include>
      <ui:include src="ColumnHeader.xhtml">
        <ui:param name="id" value="creator-column-header" />
        <ui:param name="styleClass" value="case-list-header-cell" />
        <ui:param name="componentToBeUpdated" value="" />
        <ui:param name="sortedField" value="CREATOR" />
        <ui:param name="sortable" value="true" />
        <ui:param name="value" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/creator')}" />
      </ui:include>
      <ui:include src="ColumnHeader.xhtml">
        <ui:param name="id" value="created-date-column-header" />
        <ui:param name="styleClass" value="TexAlCenter case-list-header-cell" />
        <ui:param name="componentToBeUpdated" value="" />
        <ui:param name="sortedField" value="START_TIME" />
        <ui:param name="value" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/create')}" />
        <ui:param name="sortable" value="true" />
      </ui:include>
      <ui:include src="ColumnHeader.xhtml">
        <ui:param name="id" value="mofified-date-column-header" />
        <ui:param name="styleClass" value="TexAlCenter case-list-header-cell" />
        <ui:param name="componentToBeUpdated" value="" />
        <ui:param name="sortedField" value="END_TIME" />
        <ui:param name="sortable" value="true" />
        <ui:param name="value" value="#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/Finished')}" />
      </ui:include>
      <ui:include src="ColumnHeader.xhtml">
        <ui:param name="id" value="pm-column-header" />
        <ui:param name="styleClass" value="case-list-header-cell hidden-sm" />
        <ui:param name="componentToBeUpdated" value="" />
        <ui:param name="value" value="#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/Pm')}" />
      </ui:include>
      <ui:include src="ColumnHeader.xhtml">
        <ui:param name="id" value="state-column-header" />
        <ui:param name="styleClass" value="case-list-header-cell TexAlCenter" />
        <ui:param name="componentToBeUpdated" value="" />
        <ui:param name="sortedField" value="STATE" />
        <ui:param name="sortable" value="true" />
        <ui:param name="value" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/STATE')}" />
      </ui:include>
    </h:panelGroup>
    <div class="widget-content">
      <h:panelGroup id="case-list" layout="block" styleClass="case-list">
        <p:dataScroller id="case-list-scroller" value="#{data.dataModel}" var="case" chunkSize="#{cc.attrs.chunkSize}"
          lazy="true" mode="inline" rowIndexVar="rowIndex" styleClass="js-case-list" widgetVar="case-list-scroller">
          <ic:ch.ivy.addon.portalkit.component.CaseItem caseItem="#{case}" id="case-item"
            initialActive="#{case.id eq cc.attrs.autoSelectCaseId.id() and case.server.id eq cc.attrs.autoSelectCaseId.serverId()}"
            onDestroyComplete="PF('destroy-case-dialog').show()" expandCallback="caseWidget.setUpScrollbar();caseWidget.setupHeader();"
            itemStyleClass="#{rowIndex % 2 == 0 ? 'case-even-row' : 'case-odd-row'}">
            <cc:insertFacet name="caseHeader" />
            <cc:insertFacet name="caseBody" />
          </ic:ch.ivy.addon.portalkit.component.CaseItem>
        </p:dataScroller>
        <div jsf:rendered="#{data.dataModel.rowCount eq 0}" class="case-widget-empty-message">
          <p:outputLabel rendered="#{empty cc.facets.emptyMessage}" value="#{cc.attrs.emptyMessage}" />
          <cc:renderFacet name="emptyMessage" />
        </div>
      </h:panelGroup>
    </div>
  </div>

  <p:dialog id="save-filter-set-dialog" widgetVar="save-filter-set-dialog"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskView/saveFilter')}" resizable="false"
    width="420" modal="true" closeOnEscape="true" styleClass="save-filter-set-dialog">
    <p:ajax event="close" resetValues="true" listener="#{logic.clearSaveFilterDialog}" />
    <p:messages autoUpdate="true" />
    <h:form id="filter-save-form">
      <h:panelGrid columns="2" styleClass="save-filter-set-panel"
        columnClasses="save-filter-set-panel-column-1, save-filter-set-panel-column-2">
        <p:outputLabel id="save-filter-set-name-label" for="save-filter-set-name-input"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterName')}" />
        <p:inputText id="save-filter-set-name-input" value="#{data.filterSetName}" required="true" maxlength="20" />
        <p:outputLabel id="save-filter-type-label" for="save-filter-type-radio"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterVisibility')}" />
        <p:selectOneRadio id="save-filter-type-radio" value="#{data.filterType}">
          <f:selectItem id="only-me"
            itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterTypeOnlyMe')}"
            itemValue="ONLY_ME" />
          <f:selectItem id="all-users" itemDisabled="#{!permissionBean.hasAdminPermission()}"
            itemLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterTypeAllUsers')}"
            itemValue="ALL_USERS" />
        </p:selectOneRadio>
      </h:panelGrid>
      <h:panelGroup layout="block" class="u-dialog-footer ui-dialog-footer">
        <p:commandButton styleClass="" id="filter-save-command"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" process="@form"
          oncomplete="if (args &amp;&amp; !args.validationFailed) {PF('save-filter-set-dialog').hide();}"
          actionListener="#{logic.saveFilter}" update="#{cc.clientId}:case-widget-header case-widget:filter-save-form">
        </p:commandButton>
        <p:spacer width="5px" />
        <p:commandButton type="button" styleClass="portal-cancel-button" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
          onclick="PF('save-filter-set-dialog').hide();">
        </p:commandButton>
      </h:panelGroup>
    </h:form>
  </p:dialog>

  <p:confirmDialog id="delete-filter-confirmation-dialog"
    message="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/components/taskView/filterDeletionConfirmation')}"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}"
    widgetVar="delete-filter-confirmation-dialog" appendTo="@(body)" severity="alert">
    <p:commandButton id="confirm-delete" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/yes')}"
      actionListener="#{logic.deleteFilter()}" styleClass=""
      oncomplete="PF('delete-filter-confirmation-dialog').hide(); caseWidget.setUpScrollbar(); caseWidget.setupHeader();"
      update="case-basic-filter-form advanced-filter-container filter-selection-form case-list filter-add-form" />
    <p:commandButton value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/no')}"
      onclick="PF('delete-filter-confirmation-dialog').hide();" type="button" styleClass="portal-cancel-button" />
  </p:confirmDialog>

  <script type="text/javascript">
      var caseWidget = new CaseWidget("#{outerPanelId}");
      var caseListToolkit = CaseListToolKit();
      $(function() {
        caseWidget.setUpScrollbar();
        caseWidget.setupHeader();
      });
    </script>
  <p:confirmDialog id="destroy-case-confirmation-dialog"
    message="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/destroyCaseMessage')}" closeOnEscape="true"
    header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}" widgetVar="destroy-case-dialog"
    appendTo="@(body)" severity="alert">
    <p:commandButton id="confirm-destruction" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/yes')}"
      actionListener="#{logic.destroyCase(caseWidgetBean.deletingCase)}" styleClass=""
      oncomplete="caseWidget.setUpScrollbar();caseWidget.setupHeader();PF('destroy-case-dialog').hide()"
      update="case-list" />
    <p:commandButton value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/no')}"
      onclick="PF('destroy-case-dialog').hide();" type="button" styleClass="portal-cancel-button" />
  </p:confirmDialog>
  
  <h:form>
    <p:remoteCommand name="updateCaseCount" update="#{cc.clientId}:case-widget-title" global="false" />
  </h:form>
</cc:implementation>
</html>