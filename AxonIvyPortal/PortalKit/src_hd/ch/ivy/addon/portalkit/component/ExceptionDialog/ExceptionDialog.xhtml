<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<cc:interface componentType="IvyComponent">
  <cc:attribute name="message" shortDescription="Message Of Exception" />
  <cc:attribute name="stackTrace" shortDescription="Stack trace Of Exception" />
  <cc:attribute name="widgetVar" shortDescription="Primefaces widget variable" />
  <cc:attribute name="pfException" required="true" shortDescription="Primeface Exception"/>
</cc:interface>

<cc:implementation>
  <c:set var="exception" value="#{cc.attrs.pfException}" />

  <p:dialog closeOnEscape="true" id="#{cc.id}" widgetVar="#{cc.attrs.widgetVar}" modal="true" resizable="false"
    header=" #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/detail')}" width="800px" fitViewport="true" responsive="true"
    onShow="#{portalExceptionBean.buildExceptionDialog(exception)}">
    <h:panelGroup id="portal-exception-detail-group" layout="block" styleClass="portal-exception-detail-group">
      <h:panelGrid columns="2" columnClasses="error-label, error-value" styleClass="Wid100 MarBot10">
        <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/errorDialog/errorType')}" />
        <h:outputText value="#{portalExceptionBean.exceptionInfo.type}" />

        <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/noteHistory/columnTimestamp')}" />
        <h:outputText value="#{portalExceptionBean.exceptionInfo.formattedTimestamp}" />

        <!-- Unique ID -->
        <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/exceptionDialog/errorId')}" />
        <h:outputText value="#{portalExceptionBean.uniqueId}" />

        <!-- Process Element ID -->
        <c:set var="processElementId" value="#{portalExceptionBean.processElement}"/>
        <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/exceptionDialog/processElementId')}" rendered="#{not empty processElementId}"/>
        <h:outputText rendered="#{not empty processElementId}" value="#{processElementId}"/>

        <!-- PMV -->
        <c:set var="pmv" value="#{portalExceptionBean.pmv}"/>
        <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/exceptionDialog/pmv')}" rendered="#{not empty pmv}"/>
        <h:outputText rendered="#{not empty pmv}" value="#{pmv}" />

        <!-- Message -->
        <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/exceptionDialog/message')}" />
        <h:outputText value="#{portalExceptionBean.exceptionInfo.message}" />
      </h:panelGrid>
      <h:panelGroup layout="block" rendered="#{portalExceptionBean.errorDetailToEndUser}">
        <h:outputText styleClass="error-label" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/exceptionDialog/stackTrace')}:" />
        <div class="exception-handler-stacktrace error-value">
          <h:outputText styleClass="exception-handler-stacktrace-text" value="#{portalExceptionBean.exceptionInfo.formattedStackTrace}" readonly="true" escape="false" />
        </div>
      </h:panelGroup>
    </h:panelGroup>
    <f:facet name="footer">
      <h:panelGroup id="exception-handler-command" styleClass="exception-handler-command" layout="block">
        <p:commandButton onclick="PF('#{cc.attrs.widgetVar}').hide()"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/close')}"
          type="button"
          styleClass="portal-cancel-button" />
        <p:spacer width="5px" />
        <p:commandButton id="copy-error-detail-button" 
          icon="fa fa-copy"
          value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/exceptionDialog/copyError')}"
          styleClass="portal-ok-button"
          onclick="copyToClipboard('exception-dialog:portal-exception-detail-group')"
          type="button"/>
      </h:panelGroup>
    </f:facet>
  </p:dialog>
    <script>
      function copyToClipboard(elementId) {
        var range, selection, element;
        element = document.getElementById(elementId);

        if (document.body.createTextRange) {
          range = document.body.createTextRange();
          range.moveToElementText(element);
          range.select();
        } else if (window.getSelection) {
          selection = window.getSelection();
          range = document.createRange();
          range.selectNodeContents(element);
          selection.removeAllRanges();
          selection.addRange(range);
        }

        try {
          document.execCommand('copy');
        } catch (err) {
          console.log('unable to copy text');
        }
        
        updateIconCopyErrorButton();
        setTimeout(function() {
          updateIconCopyErrorButton();
        }, 1000);
      };
      
      function updateIconCopyErrorButton() {
        var errorDetailButton = $("button[id$='exception-dialog:copy-error-detail-button']").find("span[class^='ui-button-icon-left']");
        $(errorDetailButton).toggleClass('fa-check');
        $(errorDetailButton).toggleClass('fa-copy');
      };
    </script>
</cc:implementation>
</html>