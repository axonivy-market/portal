<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions">
<ui:composition>

  <h:panelGroup id="username-deputy" class="substitution-user-selection-container ui-g-12" layout="block"
    rendered="#{absenceBean.substitutionManagementCapable and !data.isLoadDeputy}">
    <h:outputText styleClass="substituted-user-text" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/substitutedUser')}:" />
    <p:spacer styleClass="u-buttons-spacer" />
    <p:autoComplete id="substituted-user" scrollHeight="200" dropdown="true" size="35" value="#{data.selectedUser}"
      required="true" completeMethod="#{logic.autoCompleteForUser}" var="user" itemLabel="#{user.name}"
      itemValue="#{user}" converter="pojoConverter" maxResults="100"
      requiredMessage="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/Messages/userNameRequired')}"
      moreText="#{component.suggestions.size() - component.maxResults} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}...">
      <f:event listener="#{logic.loadUsers}" type="preRenderComponent" />
      <p:ajax event="itemSelect" listener="#{logic.changeUserSubstitute}" update="substitute-container" />
    </p:autoComplete>
  </h:panelGroup>

  <h:panelGroup layout="block" styleClass="substitute-container">
    <p:treeTable id="substitute-container" widgetVar="substituteTable" value="#{data.substituteRoot}" styleClass="substitute-container-table"
      var="substituteNode" emptyMessage="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/noRecordsFound')}">
      <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/role')}"
        styleClass="substitute-role">
        <h:outputText value="#{substituteNode.name}" />
      </p:column>
      <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/deputy')}"
        styleClass="substitute-deputy">
        <p:autoComplete id="subsitute-username" value="#{substituteNode.substituteUser}"
          rendered="#{substituteNode.isLeaf()}" completeMethod="#{substituteNode.autoCompleteUser}" var="user"
          converter="pojoConverter" cache="true" dropdown="true" scrollHeight="200" maxResults="100"
          itemLabel="#{not empty user ? user.displayName : ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/noDeputy')}" itemValue="#{user}"
          onfocus="clearSubtitute(this, '#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/noDeputy')}');"
          onblur="updateSubtitute(this);"
          onchange="updateSubtitute(this);"
          moreText="#{component.suggestions.size() - component.maxResults} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}...">
          <p:column>
            <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/noDeputy')}" rendered="#{empty user}" />
            <h:outputText value="#{userFormatBean.formatWithTip(user.displayName, user.name)}" rendered="#{not empty user}" />
          </p:column>
        </p:autoComplete>
      </p:column>
      <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/comment')}"
        styleClass="substitute-comment">
        <p:inputText id="subtitute-comment" value="#{substituteNode.getSubstitute().description}"
          rendered="#{substituteNode.isLeaf()}" />
      </p:column>
    </p:treeTable>
  </h:panelGroup>
  <script type="text/javascript">
    var defaultSubtituteName = "";
    var selectedSubtituteName = "";
    function clearSubtitute(target, defaultValue) {
      selectedSubtituteName = target.value;
      defaultSubtituteName = defaultValue;
      if (target.defaultValue == defaultValue || target.value == defaultValue) { 
        target.defaultValue = "";
        target.value = "";
      }
    }

    function updateSubtitute(target) {
      if (target.value == "") {
        selectedSubtituteName == "" ? target.value = defaultSubtituteName : target.value = selectedSubtituteName;
      } 
    }
  </script>
</ui:composition>
</html>