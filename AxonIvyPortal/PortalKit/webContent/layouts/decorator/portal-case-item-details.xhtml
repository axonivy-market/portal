<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:c="http://xmlns.jcp.org/jsp/jstl/core" xmlns:jsf="http://xmlns.jcp.org/jsf">

<!-- THIS DECORATOR IS ONLY USED BY PORTAL. DON'T MODIFY IT -->

  <h:panelGroup styleClass="ui-g-12 case-detail-header-container u-truncate-text" rendered="#{showItemDetailsHeader}" layout="block">
    <h:panelGroup id="case-detail-name" styleClass="case-detail-header #{inFrame == true ? '' : 'u-hidden-md-up'}" layout="block">
      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/searchResult/case')}: "
        styleClass="case-detail-name-prefix" />
      <span class="u-truncate-text">#{case.name}</span>
    </h:panelGroup>

    <p:link id="back-to-cases" href="#" rendered="#{showItemBackButton}"
      onclick="backToPrevPage(#{!isTaskStartedInDetails})" styleClass="case-details-back-btn">
      <i class="si si-arrow-left-1" />
      <p:spacer width="3px" />
      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/back')}" />
    </p:link>
  </h:panelGroup>
  <h:panelGroup id="case-details-actions" rendered="#{not isWorkingOnTask}"
    styleClass="switch-and-reset-buttons-area ui-g-12">
    <p:commandButton id="switch-to-view-mode-button" rendered="#{not caseDetailsBean.readOnlyMode}"
      value="#{ivy.cms.co('/Dialogs/Tasks/TaskDetail/switchToViewMode')}" actionListener="#{caseDetailsBean.save()}"
      icon="#{visibilityBean.generateButtonIcon('si si-floppy-disk')}" onclick="saveCaseDetailsGrid()"
      update="case-detail-body case-details-actions" oncomplete="loadCaseDetailsGrid()" />
    <p:commandButton id="switch-to-edit-mode-button" rendered="#{caseDetailsBean.readOnlyMode}"
      value="#{ivy.cms.co('/Dialogs/Tasks/TaskDetail/switchToEditMode')}" actionListener="#{caseDetailsBean.switchToEditMode()}"
      icon="#{visibilityBean.generateButtonIcon('si si-pencil')}"
      update="case-detail-body case-details-actions" oncomplete="loadCaseDetailsGrid()" />
    <p:commandButton id="reset-details-settings-button" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/reset')}"
      rendered="#{caseDetailsBean.configuration.changed and not caseDetailsBean.readOnlyMode}" onclick="PF('reset-to-default-case-dialog').show()"
      icon="#{visibilityBean.generateButtonIcon('si si-button-refresh-arrows')}" styleClass="reset-details-settings-button" immediate="true" />
  </h:panelGroup>
  
  <h:panelGroup layout="block" styleClass="case-detail-body portal-card-container ui-g-12" id="case-detail-body">
    <h:panelGroup class="task-item-body-container task-details-widgets u-padding-0 grid-stack" id="task-details-widgets"
      rendered="#{not empty caseDetailsBean.widgets}">
      <ui:repeat var="widget" value="#{caseDetailsBean.widgets}" id="widgets">
        <div id="case-details-#{widget.id}-panel" class="#{widget.styleClass} grid-stack-item" style="#{widget.style}" widget-type="#{widget.class.simpleName}"
          data-gs-x="#{widget.axisX}" data-gs-y="#{widget.axisY}" data-gs-width="#{widget.width}" data-gs-height="#{widget.height}" data-gs-id="#{widget.id}"
          data-gs-no-resize="#{caseDetailsBean.readOnlyMode}" data-gs-no-move="#{caseDetailsBean.readOnlyMode}"
          jsf:rendered="#{not (widget.class.simpleName eq 'CaseDetailsTechnicalCaseWidget' and not caseDetailsBean.hasTechnicalCases(case))}">
          <!-- General & description box -->
          <h:panelGroup id="case-detail-general-container" layout="block" rendered="#{widget.class.simpleName eq 'CaseDetailsInformationWidget'}"
            styleClass="card custom-general-panel grid-stack-item-content #{caseDetailsBean.readOnlyMode ? '' : 'moveable-area'}">
            <div class="task-detail-section-title u-truncate-text ui-g-12 ui-xl-12 ui-lg-12 ui-md-12 ui-sm-12 u-padding-0">
              <div class="ui-g-4 u-truncate-text u-padding-0 task-details-panel-title">
                <i class="si si-single-neutral-actions" /> #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/general')}
              </div>
              
              <h:panelGroup class="case-history-button-container u-truncate-text ui-g-8"
                rendered="#{caseDetailsBean.showCaseDetails}" layout="block">

                <p:link id="show-process-overview-link" styleClass="additional-case-details-link ui-md-hidden ui-sm-hidden"
                  rendered="#{caseWidgetBean.showProcessOverviewLink(case)}"
                  href="#{caseWidgetBean.getProcessOverviewPageUri(case)}"
                  disabled="#{inFrame}">
                  <i class="si si-cog-double-2" />
                  <span class="display-full-text">#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/showProcessOverview')}</span>
                </p:link>

                <p:tooltip for="show-process-overview-link"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/showProcessOverview')}" trackMouse="true"
                  hideEvent="mouseleave click" />

                <p:commandLink id="destroy-case-link"
                  rendered="#{caseActionBean.canDestroy(case) and case.state ne 'DONE' and case.state ne 'DESTROYED'}"
                  styleClass="additional-case-details-link" immediate="true" onclick="PF('destroy-case-dialog').show()" disabled="#{readOnly}">
                  <span class="action-icon si si-remove" />
                  <span class="display-full-text">#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/CaseDetail/destroyCase')}</span>
                  <span class="display-short-text">#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/destroy')}</span>
                </p:commandLink>
                <p:tooltip for="destroy-case-link"
                  value="#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/CaseDetail/destroyCase')}"
                  trackMouse="true" hideEvent="mouseleave click" />

                <p:link id="show-additional-case-details-link" styleClass="additional-case-details-link" target="_blank"
                  href="#{caseWidgetBean.getAdditionalCaseDetailsPageUri(case)}">
                  <i class="si si-business-contract-handshake-sign" />
                  <span class="display-full-text">#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/showAdditionalPage')}</span>
                  <span class="display-short-text">#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}</span>
                </p:link>
                
                <p:tooltip for="show-additional-case-details-link"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/showAdditionalPage')}" trackMouse="true"
                  hideEvent="mouseleave click" />
              </h:panelGroup>
            </div>

            <h:panelGroup id="case-detail-data-description-container" styleClass="ui-g-12 u-padding-0 grid-stack-item-content">
              <ic:ch.ivy.addon.portalkit.component.CaseItemGeneralInformation id="general-information" case="#{case}" inFrame="#{inFrame}" />
            </h:panelGroup>
          </h:panelGroup>
          
          <!-- Documents box -->
          <h:panelGroup id="case-details-document-card" layout="block" styleClass="card case-document-component grid-stack-item-content" 
            rendered="#{widget.class.simpleName eq 'CaseDetailsDocumentWidget'}">
            <ic:ch.ivy.addon.portalkit.component.CaseItemDocument id="document" case="#{case}" />
          </h:panelGroup>
          
          <!-- Related cases box -->
          <h:panelGroup id="case-details-technical-case-card" styleClass="card case-related-task-component grid-stack-item-content"
            rendered="#{widget.class.simpleName eq 'CaseDetailsTechnicalCaseWidget'}">
            <ic:ch.ivy.addon.portalkit.component.CaseItemRelatedCases id="related-cases-widget" case="#{case}"
              isWorkingOnTask="#{isWorkingOnTask}" inFrame="#{inFrame}" readOnly="#{readOnly}" />
          </h:panelGroup>
          
          <!-- Related running tasks box -->
          <h:panelGroup id="case-details-related-running-tasks-card" styleClass="card case-related-task-component grid-stack-item-content"
            rendered="#{widget.class.simpleName eq 'CaseDetailsRelatedTaskWidget'}">
            <ic:ch.ivy.addon.portalkit.component.CaseItemRelatedTasks id="task-widget" case="#{case}"
              isWorkingOnTask="#{isWorkingOnTask}" inFrame="#{inFrame}" readOnly="#{readOnly}"/>
          </h:panelGroup>
          
          <!-- Histories box -->
          <h:panelGroup id="history-container" layout="block" styleClass="card case-history-component grid-stack-item-content"
            rendered="#{widget.class.simpleName eq 'CaseDetailsHistoryWidget'}">
            <ic:ch.ivy.addon.portalkit.component.CaseItemHistory id="case-histories" case="#{case}" />
          </h:panelGroup>
          
          <!-- caseItemDetailCustomTop box -->
          <h:panelGroup id="caseItemDetailCustomTop"
            rendered="#{widget.class.simpleName eq 'CaseDetailsCustomWidget' and widget.id eq 'caseItemDetailCustomTop'}"
            styleClass="card task-detail-card grid-stack-item-content #{caseDetailsBean.readOnlyMode ? '' : 'moveable-area'}">
            <cc:renderFacet name="caseItemDetailCustomTop" />
          </h:panelGroup>
          
          <!-- caseItemDetailCustomMiddle box -->
          <h:panelGroup id="caseItemDetailCustomMiddle"
            rendered="#{widget.class.simpleName eq 'CaseDetailsCustomWidget' and widget.id eq 'caseItemDetailCustomMiddle'}"
            styleClass="card task-detail-card grid-stack-item-content #{caseDetailsBean.readOnlyMode ? '' : 'moveable-area'}">
            <cc:renderFacet name="caseItemDetailCustomMiddle" />
          </h:panelGroup>

          <!-- caseItemDetailCustomBottom box -->
          <h:panelGroup id="caseItemDetailCustomBottom"
            rendered="#{widget.class.simpleName eq 'CaseDetailsCustomWidget' and widget.id eq 'caseItemDetailCustomBottom'}"
            styleClass="card task-detail-card grid-stack-item-content #{caseDetailsBean.readOnlyMode ? '' : 'moveable-area'}">
            <cc:renderFacet name="caseItemDetailCustomBottom" />
          </h:panelGroup>
        </div>
      </ui:repeat>
    </h:panelGroup>
  </h:panelGroup>
    
  <h:form>
    <p:remoteCommand name="saveConfigurationCommand" update="#{cc.clientId}:case-details-actions" actionListener="#{caseDetailsBean.save()}"
      global="false" />
  </h:form>

  <ui:decorate template="/layouts/decorator/portal-dialog-with-icon.xhtml">
    <ui:param name="id" value="destroy-case-confirmation-dialog" />
    <ui:param name="widgetVar" value="destroy-case-dialog" />
    <ui:param name="appendTo" value="@(body)" />
    <ui:param name="iconClass" value="si si-delete-1" />
    <ui:param name="iconStyleClass" value="portal-dialog-error-icon" />
    <ui:param name="headerText" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/destroyCaseHeaderText')}" />
    <ui:param name="dialogContent" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/destroyCaseMessage')}" />
  
    <ui:define name="dialogFooter">
      <p:commandLink value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
        onclick="PF('destroy-case-dialog').hide();" styleClass="u-mar-right-15" />
      <p:commandButton id="confirm-destruction" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/destroy')}"
        icon="#{visibilityBean.generateButtonIcon('si si-remove')}"
        actionListener="#{caseWidgetBean.destroyCase(case)}"
        oncomplete="backToPrevPage(#{caseWidgetBean.willNavigateBack()});" />
    </ui:define>
  </ui:decorate>

  <ui:decorate template="/layouts/decorator/portal-dialog-with-icon.xhtml">
    <ui:param name="id" value="reset-to-default-case-confirmation-dialog" />
    <ui:param name="widgetVar" value="reset-to-default-case-dialog" />
    <ui:param name="appendTo" value="@(body)" />
    <ui:param name="iconClass" value="si si-button-refresh-arrows" />
    <ui:param name="iconStyleClass" value="portal-dialog-warning-icon" />
    <ui:param name="headerText" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ResetToDefaultHeaderText')}" />
    <ui:param name="dialogContent" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/resetToDefaultMessage')}" />

    <ui:define name="dialogFooter">
      <h:form id="reset-to-default-case-form">
        <p:commandLink value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
          onclick="PF('reset-to-default-case-dialog').hide();" styleClass="u-mar-right-15" />
        <p:commandButton id="confirm-destruction" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/reset')}"
          icon="#{visibilityBean.generateButtonIcon('si si-button-refresh-arrows')}"
          actionListener="#{caseDetailsBean.reset()}" update="case-item-details"
          oncomplete="PF('reset-to-default-case-dialog').hide(); loadCaseDetailsGrid()" />
      </h:form>
    </ui:define>
  </ui:decorate>

  <h:form>
    <p:remoteCommand name="backToCasesList" actionListener="#{caseBean.backToCasesList()}" process="@this"
      immediate="true" />
  </h:form>

  <script type="text/javascript">
    function backToPrevPage(isHistoryBack) {
      if (#{inFrame} == true) {
        window.parent.backToPrevPage(isHistoryBack);
        return;
      }
      if (document.referrer &amp;&amp; isHistoryBack) {
        window.history.back();
        event.preventDefault();
      } else {
        backToCasesList();
      }
    }
  </script>
  <h:outputScript name="case-details.js" library="js" />
</html>