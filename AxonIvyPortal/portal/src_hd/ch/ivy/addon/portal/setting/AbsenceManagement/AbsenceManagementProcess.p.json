{
  "format" : "10.0.0",
  "id" : "1756E0BE3BCBAD12",
  "kind" : "HTML_DIALOG",
  "config" : {
    "data" : "ch.ivy.addon.portal.setting.AbsenceManagement.AbsenceManagementData"
  },
  "elements" : [ {
      "id" : "S20",
      "type" : "EmbeddedProcess",
      "name" : "Find Substitutes/Substitutions",
      "elements" : [ {
          "id" : "S20-f105",
          "type" : "SubProcessCall",
          "name" : "find substitutions",
          "config" : {
            "processCall" : "Ivy Data Processes/SubstituteService:findSubstitutions(String)",
            "output" : {
              "map" : {
                "out" : "in",
                "out.substitutions" : "result.substitutes"
              }
            },
            "call" : {
              "params" : [
                { "name" : "username", "type" : "String" }
              ],
              "map" : {
                "param.username" : "in.selectedAbsenceUser.name"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 464, "y" : 160 }
          },
          "connect" : { "id" : "S20-f1", "to" : "S20-g1" }
        }, {
          "id" : "S20-f115",
          "type" : "SubProcessCall",
          "name" : "find substitutes",
          "config" : {
            "processCall" : "Ivy Data Processes/SubstituteService:findSubstitutes(String)",
            "output" : {
              "map" : {
                "out" : "in",
                "out.deputyRoles" : "ch.ivy.addon.portalkit.util.DeputyRoleUtils.getDeputyRolesFromSubstitutes(result.substitutes)",
                "out.substitutes" : "result.substitutes"
              }
            },
            "call" : {
              "params" : [
                { "name" : "username", "type" : "String" }
              ],
              "map" : {
                "param.username" : "in.selectedAbsenceUser.name"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 248, "y" : 160 }
          },
          "connect" : { "id" : "S20-f29", "to" : "S20-f105" }
        }, {
          "id" : "S20-g0",
          "type" : "EmbeddedStart",
          "name" : "in 1",
          "visual" : {
            "at" : { "x" : 64, "y" : 160 },
            "labelOffset" : { "x" : 1, "y" : 42 }
          },
          "parentConnector" : "f42",
          "connect" : { "id" : "S20-f0", "to" : "S20-f115" }
        }, {
          "id" : "S20-g1",
          "type" : "EmbeddedEnd",
          "name" : "out 1",
          "visual" : {
            "at" : { "x" : 640, "y" : 160 },
            "labelOffset" : { "x" : 21, "y" : 32 }
          },
          "parentConnector" : "f59"
        } ],
      "visual" : {
        "at" : { "x" : 704, "y" : 96 },
        "size" : { "width" : 176, "height" : 60 }
      },
      "connect" : { "id" : "f59", "to" : "f117" }
    }, {
      "id" : "S10",
      "type" : "EmbeddedProcess",
      "name" : "Find Absences",
      "elements" : [ {
          "id" : "S10-f71",
          "type" : "Script",
          "name" : [
            "Check if current user ",
            "can read other users' absences"
          ],
          "config" : {
            "output" : {
              "code" : [
                "import ch.ivy.addon.portalkit.util.PermissionUtils;",
                "import ch.ivyteam.ivy.security.IPermission;",
                "",
                "in.isSupervisor = PermissionUtils.hasPermission(IPermission.USER_READ_ABSENCES);"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 272, "y" : 160 },
            "size" : { "width" : 208, "height" : 60 }
          },
          "connect" : { "id" : "S10-f75", "to" : "S10-f67" }
        }, {
          "id" : "S10-f70",
          "type" : "Script",
          "name" : [
            "Get the absences",
            "of current user"
          ],
          "config" : {
            "output" : {
              "code" : [
                "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
                "import java.util.ArrayList;",
                "import java.util.Set;",
                "import ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence;",
                "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
                "",
                "if (in.#absencesByUser is initialized) {",
                "  Set<IvyAbsence> ivyAbsences = in.absencesByUser.get(in.selectedAbsenceUser.getName()) as Set;",
                "  if (!in.absenceInThePastShown) {",
                "    out.displayedAbsences.clear();",
                "    for (IvyAbsence absence : ivyAbsences) {",
                "        if (!AbsenceAndSubstituteUtils.isInThePast(absence)) {",
                "          out.displayedAbsences.add(absence);",
                "        }",
                "    }",
                "  } else {",
                "    out.displayedAbsences = new ArrayList(ivyAbsences);",
                "  }",
                "}",
                "AbsenceAndSubstituteUtils.sortAbsences(out.displayedAbsences);"
              ]
            }
          },
          "visual" : {
            "at" : { "x" : 752, "y" : 160 },
            "size" : { "width" : 128, "height" : 60 }
          },
          "connect" : { "id" : "S10-f1", "to" : "S10-g1" }
        }, {
          "id" : "S10-f67",
          "type" : "SubProcessCall",
          "name" : [
            "Find current ",
            "user's absences"
          ],
          "config" : {
            "processCall" : "Ivy Data Processes/AbsenceService:findAbsences(String)",
            "output" : {
              "map" : {
                "out" : "in",
                "out.absencesByUser" : "result.absencesByUser"
              }
            },
            "call" : {
              "params" : [
                { "name" : "username", "type" : "String" }
              ],
              "map" : {
                "param.username" : "in.selectedAbsenceUser.getName()"
              }
            }
          },
          "visual" : {
            "at" : { "x" : 536, "y" : 160 }
          },
          "connect" : { "id" : "S10-f77", "to" : "S10-f70" }
        }, {
          "id" : "S10-g0",
          "type" : "EmbeddedStart",
          "name" : "in 1",
          "visual" : {
            "at" : { "x" : 64, "y" : 160 },
            "labelOffset" : { "x" : -4, "y" : 38 }
          },
          "parentConnector" : "f25",
          "connect" : { "id" : "S10-f0", "to" : "S10-f71" }
        }, {
          "id" : "S10-g1",
          "type" : "EmbeddedEnd",
          "name" : "out 1",
          "visual" : {
            "at" : { "x" : 928, "y" : 160 },
            "labelOffset" : { "x" : 21, "y" : 25 }
          },
          "parentConnector" : "f42"
        }, {
          "id" : "S10-g2",
          "type" : "EmbeddedStart",
          "visual" : {
            "at" : { "x" : 72, "y" : 72 }
          },
          "parentConnector" : "f26",
          "connect" : { "id" : "S10-f3", "to" : "S10-f71", "via" : [ { "x" : 272, "y" : 72 } ] }
        } ],
      "visual" : {
        "at" : { "x" : 456, "y" : 96 }
      },
      "connect" : { "id" : "f42", "to" : "S20" }
    }, {
      "id" : "f86",
      "type" : "Script",
      "name" : "update data",
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
            "import java.util.Arrays;",
            "import ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence;",
            "import java.util.Set;",
            "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
            "",
            "boolean showNewAbsence = in.selectedAbsence.user.name.equals(in.selectedAbsenceUser.name);",
            "",
            "if (showNewAbsence && (!AbsenceAndSubstituteUtils.isInThePast(in.selectedAbsence) || in.absenceInThePastShown)){",
            "  in.displayedAbsences.add(in.selectedAbsence);",
            "  (in.absencesByUser.get(in.selectedAbsenceUser.getName()) as Set).add(in.selectedAbsence);",
            "  AbsenceAndSubstituteUtils.sortAbsences(in.displayedAbsences);",
            "}",
            "",
            "in.message = ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceManagement/Messages/addNewAbsence\", Arrays.asList(in.selectedAbsence.user.name));"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1144, "y" : 592 }
      },
      "connect" : { "id" : "f58", "to" : "f47", "via" : [ { "x" : 1376, "y" : 592 } ] }
    }, {
      "id" : "f98",
      "type" : "Alternative",
      "name" : "is create absence?",
      "visual" : {
        "at" : { "x" : 192, "y" : 584 },
        "labelOffset" : { "x" : 82, "y" : 5 }
      },
      "connect" : [
        { "id" : "f106", "to" : "f137", "via" : [ { "x" : 192, "y" : 640 } ], "label" : {
            "name" : "yes",
            "segment" : 1.25,
            "offset" : { "x" : 0, "y" : 10 }
          }, "condition" : "in.isCreateMode" },
        { "id" : "f107", "to" : "f111", "via" : [ { "x" : 192, "y" : 528 } ] }
      ]
    }, {
      "id" : "f37",
      "type" : "Script",
      "name" : "Backup absence",
      "config" : {
        "output" : {
          "code" : [
            "in.backupAbsence.setUser(in.selectedAbsence.getUser());",
            "in.backupAbsence.setFrom(in.selectedAbsence.getFrom());",
            "in.backupAbsence.setUntil(in.selectedAbsence.getUntil());",
            "in.backupAbsence.setComment(in.selectedAbsence.getComment());",
            "in.selectedUser = in.selectedAbsence.getUser();",
            "in.isCreateMode = false;"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 264, "y" : 864 }
      },
      "connect" : { "id" : "f132", "to" : "f130" }
    }, {
      "id" : "f117",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 904, "y" : 96 }
      }
    }, {
      "id" : "f55",
      "type" : "Script",
      "name" : "Reset",
      "config" : {
        "output" : {
          "code" : [
            "out.selectedAbsence.setUser(in.backupAbsence.getUser());",
            "out.selectedAbsence.setFrom(in.backupAbsence.getFrom());",
            "out.selectedAbsence.setUntil(in.backupAbsence.getUntil());",
            "out.selectedAbsence.setComment(in.backupAbsence.getComment());"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 264, "y" : 960 }
      },
      "connect" : { "id" : "f87", "to" : "f57" }
    }, {
      "id" : "f39",
      "type" : "SubProcessCall",
      "name" : "AbsenceService",
      "config" : {
        "processCall" : "Ivy Data Processes/AbsenceService:deleteAbsence(ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence)",
        "call" : {
          "params" : [
            { "name" : "ivyAbsence", "type" : "ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence" }
          ],
          "map" : {
            "param.ivyAbsence" : "in.selectedAbsence"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 528, "y" : 320 }
      },
      "connect" : { "id" : "f22", "to" : "f9" }
    }, {
      "id" : "f23",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 224, "y" : 320 }
      }
    }, {
      "id" : "f96",
      "type" : "HtmlDialogEventStart",
      "name" : "saveSubstitutes",
      "config" : {
        "guid" : "1756E446A9C4FC28"
      },
      "visual" : {
        "at" : { "x" : 104, "y" : 424 },
        "labelOffset" : { "x" : 5, "y" : 35 }
      },
      "connect" : { "id" : "f62", "to" : "f51" }
    }, {
      "id" : "f9",
      "type" : "Script",
      "name" : "Remove from list",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import java.util.Arrays;",
            "import javax.faces.application.FacesMessage;",
            "import org.primefaces.context.PrimeFacesContext;",
            "import ch.ivy.addon.portalkit.util.UserUtils;",
            "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
            "import ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence;",
            "import java.util.Set;",
            "",
            "out.displayedAbsences.remove(in.selectedAbsence);",
            "Set<IvyAbsence> ivyAbsences = out.absencesByUser.get(in.selectedAbsence.user.getName()) as Set;",
            "ivyAbsences.remove(in.selectedAbsence);",
            "",
            "in.message = ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceManagement/Messages/removedAbsences\", Arrays.asList(in.selectedAbsence.user.getName()));"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 716, "y" : 320 }
      },
      "connect" : { "id" : "f50", "to" : "f47", "via" : [ { "x" : 1376, "y" : 320 } ] }
    }, {
      "id" : "f19",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 1248, "y" : 768 }
      }
    }, {
      "id" : "f138",
      "type" : "Script",
      "name" : "Validation",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import java.util.Set;",
            "import javax.faces.application.FacesMessage;",
            "import javax.faces.context.FacesContext;",
            "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
            "",
            "in.validationError = false;",
            "String username = in.selectedUser.getName();",
            "boolean fromBiggerThanTill = AbsenceAndSubstituteUtils.checkFromBiggerThanTill(in.selectedAbsence);",
            "in.selectedAbsence.user = in.selectedUser;",
            "",
            "if (fromBiggerThanTill) {",
            "  in.validationError = true;",
            "}",
            "",
            "boolean doesNewAbsenceOverlap = AbsenceAndSubstituteUtils.doesNewAbsenceOverlap(in.absencesByUser.get(username) as Set, in.selectedAbsence);",
            "if (doesNewAbsenceOverlap) {",
            "  in.validationError = true;",
            "  FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR,ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/Messages/overlappingAbsence\"), \"\"));",
            "}",
            "",
            "if (in.validationError) {",
            "  FacesContext.getCurrentInstance().validationFailed();",
            "}"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 716, "y" : 640 }
      },
      "connect" : { "id" : "f155", "to" : "f140" }
    }, {
      "id" : "f17",
      "type" : "HtmlDialogMethodStart",
      "name" : "autoCompleteForSubstituteOnApp(String)",
      "config" : {
        "callSignature" : "autoCompleteForSubstituteOnApp",
        "result" : {
          "params" : [
            { "name" : "users", "type" : "java.util.List<com.axonivy.portal.components.dto.UserDTO>" }
          ],
          "code" : [
            "import com.axonivy.portal.components.dto.UserDTO;",
            "import ch.ivy.addon.portalkit.util.UserUtils;",
            "",
            "java.util.List<UserDTO> users = UserUtils.filterOut(in.users, in.selectedAbsenceUser);",
            "result.users.addAll(users);"
          ]
        },
        "input" : {
          "params" : [
            { "name" : "query", "type" : "String" }
          ],
          "map" : {
            "out.queryAutoComplete" : "param.query"
          }
        },
        "guid" : "1756E446A9CC288A"
      },
      "visual" : {
        "at" : { "x" : 704, "y" : 768 }
      },
      "connect" : { "id" : "f33", "to" : "f48" }
    }, {
      "id" : "f122",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 1248, "y" : 960 }
      }
    }, {
      "id" : "f130",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 384, "y" : 864 }
      }
    }, {
      "id" : "f54",
      "type" : "HtmlDialogEventStart",
      "name" : "cancel",
      "config" : {
        "guid" : "1756E446A9C95213"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 960 },
        "labelOffset" : { "x" : 7, "y" : 36 }
      },
      "connect" : { "id" : "f56", "to" : "f55" }
    }, {
      "id" : "f11",
      "type" : "HtmlDialogMethodStart",
      "name" : "editAbsence(IvyAbsence)",
      "config" : {
        "callSignature" : "editAbsence",
        "input" : {
          "params" : [
            { "name" : "selectedAbsence", "type" : "ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence" }
          ],
          "map" : {
            "out.selectedAbsence" : "param.selectedAbsence",
            "out.validationError" : "false"
          }
        },
        "guid" : "1756E446A9C6B05E"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 864 }
      },
      "connect" : { "id" : "f131", "to" : "f37" }
    }, {
      "id" : "f38",
      "type" : "HtmlDialogEventStart",
      "name" : "deleteAbsence",
      "config" : {
        "guid" : "1756E446A9D95FC1"
      },
      "visual" : {
        "at" : { "x" : 336, "y" : 320 },
        "labelOffset" : { "x" : 2, "y" : 35 }
      },
      "connect" : { "id" : "f63", "to" : "f39" }
    }, {
      "id" : "f6",
      "type" : "HtmlDialogEventStart",
      "name" : "dateChange",
      "config" : {
        "guid" : "1756E446A9DE09BB"
      },
      "visual" : {
        "at" : { "x" : 704, "y" : 960 },
        "labelOffset" : { "x" : 6, "y" : 35 }
      },
      "connect" : { "id" : "f91", "to" : "f90" }
    }, {
      "id" : "f7",
      "type" : "HtmlDialogStart",
      "name" : "start()",
      "config" : {
        "callSignature" : "start",
        "guid" : "1756E446A9DF005A"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 96 }
      },
      "connect" : { "id" : "f0", "to" : "f102" }
    }, {
      "id" : "f8",
      "type" : "Script",
      "name" : "Init",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import com.axonivy.portal.components.dto.UserDTO;",
            "import ch.ivyteam.ivy.security.IPermission;",
            "import ch.ivy.addon.portalkit.util.PermissionUtils;",
            "import ch.ivy.addon.portalkit.ivydata.utils.ServiceUtilities;",
            "import ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence;",
            "",
            "UserDTO currentUserDTO = in.canCreateAbsenceForOtherUsers ? ",
            "  new UserDTO(in.selectedAbsenceUser) : new UserDTO(ivy.session.getSessionUser());",
            "",
            "in.selectedAbsence = new IvyAbsence();",
            "in.selectedAbsence.from = new Date();",
            "in.selectedAbsence.until = new Date();",
            "in.selectedAbsence.user = currentUserDTO;",
            "",
            "in.selectedUser = currentUserDTO;",
            "",
            "in.validationError = false;",
            "in.isCreateMode = true;"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 264, "y" : 768 }
      },
      "connect" : { "id" : "f36", "to" : "f35" }
    }, {
      "id" : "f53",
      "type" : "HtmlDialogMethodStart",
      "name" : "autoCompleteForUserOnApp(String)",
      "config" : {
        "callSignature" : "autoCompleteForUserOnApp",
        "result" : {
          "params" : [
            { "name" : "users", "type" : "java.util.List<com.axonivy.portal.components.dto.UserDTO>" }
          ],
          "map" : {
            "result.users" : "in.users"
          }
        },
        "input" : {
          "params" : [
            { "name" : "query", "type" : "String" }
          ],
          "map" : {
            "out.queryAutoComplete" : "param.query"
          }
        },
        "guid" : "1756E446A9D252D7"
      },
      "visual" : {
        "at" : { "x" : 704, "y" : 864 },
        "labelOffset" : { "x" : 26, "y" : 42 }
      },
      "connect" : { "id" : "f46", "to" : "f45" }
    }, {
      "id" : "f90",
      "type" : "Alternative",
      "visual" : {
        "at" : { "x" : 808, "y" : 960 }
      },
      "connect" : [
        { "id" : "f128", "to" : "f14" }
      ]
    }, {
      "id" : "f157",
      "type" : "HtmlDialogEventStart",
      "name" : "userSelectInAbsence",
      "config" : {
        "guid" : "1756E446A9DB886F"
      },
      "visual" : {
        "at" : { "x" : 704, "y" : 1056 },
        "labelOffset" : { "x" : 18, "y" : 34 }
      },
      "connect" : { "id" : "f84", "to" : "f90", "via" : [ { "x" : 808, "y" : 1056 } ] }
    }, {
      "id" : "f136",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 1248, "y" : 680 }
      }
    }, {
      "id" : "f140",
      "type" : "Alternative",
      "name" : "no errors?",
      "visual" : {
        "at" : { "x" : 840, "y" : 640 },
        "labelOffset" : { "x" : 56, "y" : 7 }
      },
      "connect" : [
        { "id" : "f158", "to" : "f129", "via" : [ { "x" : 840, "y" : 592 } ], "condition" : "!in.validationError" },
        { "id" : "f61", "to" : "f136", "via" : [ { "x" : 840, "y" : 680 } ] }
      ]
    }, {
      "id" : "f31",
      "type" : "HtmlDialogEventStart",
      "name" : "add",
      "config" : {
        "guid" : "1756E446A9D175DA"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 768 }
      },
      "connect" : { "id" : "f20", "to" : "f8" }
    }, {
      "id" : "f12",
      "type" : "HtmlDialogMethodStart",
      "name" : "preDelete(IvyAbsence)",
      "config" : {
        "callSignature" : "preDelete",
        "input" : {
          "params" : [
            { "name" : "selectedAbsence", "type" : "ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence" }
          ],
          "map" : {
            "out.selectedAbsence" : "param.selectedAbsence"
          }
        },
        "guid" : "1756E446A9D3C830"
      },
      "visual" : {
        "at" : { "x" : 104, "y" : 320 }
      },
      "connect" : { "id" : "f30", "to" : "f23" }
    }, {
      "id" : "f57",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 384, "y" : 960 }
      }
    }, {
      "id" : "f111",
      "type" : "SubProcessCall",
      "name" : "AbsenceService",
      "config" : {
        "processCall" : "Ivy Data Processes/AbsenceService:updateAbsences(String,java.util.Set)",
        "call" : {
          "params" : [
            { "name" : "username", "type" : "String" },
            { "name" : "ivyAbsences", "type" : "java.util.Set" }
          ],
          "map" : {
            "param.username" : "in.selectedAbsenceUser.getName()",
            "param.ivyAbsences" : "in.absencesByUser.get(in.selectedAbsenceUser.getName()) as java.util.Set"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 336, "y" : 528 }
      },
      "connect" : { "id" : "f67", "to" : "f65" }
    }, {
      "id" : "f121",
      "type" : "Script",
      "name" : "update data",
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
            "import java.util.Set;",
            "",
            "Set<IvyAbsence> absencesFromUser = in.absencesByUser.get(in.selectedUser.getName()) as Set;",
            "absencesFromUser.add(in.selectedAbsence);",
            "AbsenceAndSubstituteUtils.sortAbsences(in.displayedAbsences);"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 656, "y" : 528 }
      },
      "connect" : { "id" : "f60", "to" : "f28" }
    }, {
      "id" : "f137",
      "type" : "Script",
      "name" : [
        "Set end date",
        "to selected absence"
      ],
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.Dates;",
            "",
            "java.util.Date endOfDate = Dates.toEndOfDate(in.selectedAbsence.getUntil());",
            "in.selectedAbsence.setUntil(endOfDate);",
            "",
            "in.isAbsenceBeingCreated = true;"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 336, "y" : 640 },
        "size" : { "width" : 144, "height" : 60 }
      },
      "connect" : { "id" : "f148", "to" : "f147" }
    }, {
      "id" : "f147",
      "type" : "SubProcessCall",
      "name" : [
        "Find current ",
        "user's absences"
      ],
      "config" : {
        "processCall" : "Ivy Data Processes/AbsenceService:findAbsences(String)",
        "output" : {
          "map" : {
            "out" : "in",
            "out.absencesByUser" : "result.absencesByUser"
          }
        },
        "call" : {
          "params" : [
            { "name" : "username", "type" : "String" }
          ],
          "map" : {
            "param.username" : "in.selectedAbsence.getUsername()"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 528, "y" : 640 }
      },
      "connect" : { "id" : "f149", "to" : "f138" }
    }, {
      "id" : "f100",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 1504, "y" : 424 }
      }
    }, {
      "id" : "f45",
      "type" : "SubProcessCall",
      "name" : "Ivy Data Processes/SecurityService",
      "config" : {
        "processCall" : "Ivy Data Processes/SecurityService:findUsers(String,Integer,Integer,java.util.List<String>,java.util.List<String>)",
        "output" : {
          "map" : {
            "out" : "in",
            "out.users" : "result.users"
          }
        },
        "call" : {
          "params" : [
            { "name" : "query", "type" : "String" },
            { "name" : "startIndex", "type" : "Integer" },
            { "name" : "count", "type" : "Integer" },
            { "name" : "fromRoles", "type" : "java.util.List<String>" },
            { "name" : "excludedUsernames", "type" : "java.util.List<String>" }
          ],
          "map" : {
            "param.query" : "in.queryAutoComplete",
            "param.startIndex" : "0",
            "param.count" : "ch.ivy.addon.portalkit.constant.PortalConstants.MAX_USERS_IN_AUTOCOMPLETE"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 960, "y" : 864 },
        "size" : { "width" : 192, "height" : 60 }
      },
      "connect" : { "id" : "f15", "to" : "f10" }
    }, {
      "id" : "f10",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 1248, "y" : 864 }
      }
    }, {
      "id" : "f13",
      "type" : "Script",
      "name" : "validation overlap",
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
            "import java.util.Set;",
            "import javax.faces.application.FacesMessage;",
            "import javax.faces.context.FacesContext;",
            "",
            "String username = in.selectedUser.getName();",
            "",
            "boolean doesNewAbsenceOverlap = AbsenceAndSubstituteUtils.doesNewAbsenceOverlap(in.absencesByUser.get(username) as Set, in.selectedAbsence);",
            "if (doesNewAbsenceOverlap) {",
            "  in.validationError = true;",
            "  FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR,ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/Messages/overlappingAbsence\"), \"\"));",
            "  FacesContext.getCurrentInstance().validationFailed();",
            "}"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1112, "y" : 960 }
      },
      "connect" : { "id" : "f134", "to" : "f122" }
    }, {
      "id" : "f14",
      "type" : "Script",
      "name" : "Validation date",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.AbsenceAndSubstituteUtils;",
            "import java.util.Set;",
            "import javax.faces.application.FacesMessage;",
            "import javax.faces.context.FacesContext;",
            "",
            "in.validationError = false;",
            "String username = in.selectedUser.getName();",
            "boolean fromBiggerThanTill = AbsenceAndSubstituteUtils.checkFromBiggerThanTill(in.selectedAbsence);",
            "in.selectedAbsence.user = in.selectedUser;",
            "",
            "if (fromBiggerThanTill) {",
            "  in.validationError = true;",
            "  FacesContext.getCurrentInstance().validationFailed();",
            "}"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 920, "y" : 960 }
      },
      "connect" : { "id" : "f40", "to" : "f13" }
    }, {
      "id" : "f52",
      "type" : "HtmlDialogMethodStart",
      "name" : "saveAbsence()",
      "config" : {
        "callSignature" : "saveAbsence",
        "guid" : "1756E446A9D22ECA"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 584 },
        "labelOffset" : { "x" : 24, "y" : 35 }
      },
      "connect" : { "id" : "f99", "to" : "f98" }
    }, {
      "id" : "f129",
      "type" : "SubProcessCall",
      "name" : "AbsenceService",
      "config" : {
        "processCall" : "Ivy Data Processes/AbsenceService:createAbsence(ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence)",
        "call" : {
          "params" : [
            { "name" : "absence", "type" : "ch.ivy.addon.portalkit.ivydata.bo.IvyAbsence" }
          ],
          "map" : {
            "param.absence" : "in.selectedAbsence"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 968, "y" : 592 }
      },
      "connect" : { "id" : "f16", "to" : "f86" }
    }, {
      "id" : "f101",
      "type" : "SubProcessCall",
      "name" : "save substitutes",
      "config" : {
        "processCall" : "Ivy Data Processes/SubstituteService:saveSubstitutes(com.axonivy.portal.components.dto.UserDTO,java.util.List<ch.ivy.addon.portalkit.ivydata.bo.IvySubstitute>)",
        "call" : {
          "params" : [
            { "name" : "userDTO", "type" : "com.axonivy.portal.components.dto.UserDTO" },
            { "name" : "substitutes", "type" : "java.util.List<ch.ivy.addon.portalkit.ivydata.bo.IvySubstitute>" }
          ],
          "map" : {
            "param.userDTO" : "in.selectedAbsenceUser",
            "param.substitutes" : "in.substitutes"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 528, "y" : 424 }
      },
      "connect" : { "id" : "f24", "to" : "f32" }
    }, {
      "id" : "f48",
      "type" : "SubProcessCall",
      "name" : "find Users",
      "config" : {
        "processCall" : "Ivy Data Processes/SecurityService:findUsers(String,Integer,Integer,java.util.List<String>,java.util.List<String>)",
        "output" : {
          "map" : {
            "out" : "in",
            "out.users" : "result.users"
          }
        },
        "call" : {
          "params" : [
            { "name" : "query", "type" : "String" },
            { "name" : "startIndex", "type" : "Integer" },
            { "name" : "count", "type" : "Integer" },
            { "name" : "fromRoles", "type" : "java.util.List<String>" },
            { "name" : "excludedUsernames", "type" : "java.util.List<String>" }
          ],
          "map" : {
            "param.query" : "in.queryAutoComplete",
            "param.startIndex" : "0",
            "param.count" : "ch.ivy.addon.portalkit.constant.PortalConstants.MAX_USERS_IN_AUTOCOMPLETE"
          }
        }
      },
      "visual" : {
        "at" : { "x" : 920, "y" : 768 }
      },
      "connect" : { "id" : "f43", "to" : "f19" }
    }, {
      "id" : "f102",
      "type" : "Script",
      "name" : "Set current user",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import com.axonivy.portal.components.dto.UserDTO;",
            "import ch.ivyteam.ivy.security.IPermission;",
            "import ch.ivy.addon.portalkit.util.PermissionUtils;",
            "import ch.ivy.addon.portalkit.ivydata.utils.ServiceUtilities;",
            "",
            "in.selectedAbsenceUser = new UserDTO(ivy.session.getSessionUser());",
            "in.canCreateAbsenceForOtherUsers = PermissionUtils.hasPermission(IPermission.USER_CREATE_ABSENCE);",
            "in.canCreateSubstituteForOtherUsers = PermissionUtils.hasPermission(IPermission.USER_CREATE_SUBSTITUTE);"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 276, "y" : 96 }
      },
      "connect" : { "id" : "f26", "to" : "S10" }
    }, {
      "id" : "f35",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 384, "y" : 768 }
      }
    }, {
      "id" : "f1",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 1608, "y" : 96 }
      }
    }, {
      "id" : "f2",
      "type" : "HtmlDialogMethodStart",
      "name" : "backToHome()",
      "config" : {
        "callSignature" : "backToHome",
        "guid" : "1756E4AF3567EC52"
      },
      "visual" : {
        "at" : { "x" : 1208, "y" : 96 },
        "labelOffset" : { "x" : 24, "y" : 35 }
      },
      "connect" : { "id" : "f5", "to" : "f3" }
    }, {
      "id" : "f3",
      "type" : "Script",
      "name" : "Navigate To Portal EndPage",
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.publicapi.PortalNavigatorAPI;",
            "import javax.faces.context.FacesContext;",
            "import javax.faces.context.Flash;",
            "",
            "",
            "// Turn off growl message",
            "Flash flash = FacesContext.getCurrentInstance().getExternalContext().getFlash();",
            "flash.put(\"overridePortalGrowl\", true);",
            "flash.setRedirect(true);",
            "",
            "PortalNavigatorAPI.navigateToPortalEndPage();"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1384, "y" : 96 },
        "size" : { "width" : 160, "height" : 60 }
      },
      "connect" : { "id" : "f4", "to" : "f1" }
    }, {
      "id" : "f47",
      "type" : "Script",
      "name" : "Show message",
      "config" : {
        "output" : {
          "code" : [
            "import org.primefaces.context.PrimeFacesContext;",
            "import javax.faces.application.FacesMessage;",
            "",
            "FacesMessage message = new javax.faces.application.FacesMessage(FacesMessage.SEVERITY_INFO, \"\", in.message);",
            "PrimeFacesContext.getCurrentInstance().addMessage(\"absences-management-message\", message);"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 1376, "y" : 424 }
      },
      "connect" : { "id" : "f18", "to" : "f100" }
    }, {
      "id" : "f32",
      "type" : "Script",
      "name" : "Add message",
      "config" : {
        "output" : {
          "code" : "in.message = ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceManagement/Messages/saveAbsenceSetting\");"
        }
      },
      "visual" : {
        "at" : { "x" : 716, "y" : 424 }
      },
      "connect" : { "id" : "f49", "to" : "f47" }
    }, {
      "id" : "f28",
      "type" : "Script",
      "name" : "Add message",
      "config" : {
        "output" : {
          "code" : "in.message = ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceManagement/Messages/updateAbsence\");"
        }
      },
      "visual" : {
        "at" : { "x" : 844, "y" : 528 }
      },
      "connect" : { "id" : "f27", "to" : "f47", "via" : [ { "x" : 1376, "y" : 528 } ] }
    }, {
      "id" : "f66",
      "type" : "HtmlDialogMethodStart",
      "name" : "findAbsencesAndSubstitutes()",
      "config" : {
        "callSignature" : "findAbsencesAndSubstitutes",
        "guid" : "175B525253D92382"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 216 },
        "labelOffset" : { "x" : 2, "y" : 40 }
      },
      "connect" : { "id" : "f25", "to" : "S10", "via" : [ { "x" : 456, "y" : 216 } ] }
    }, {
      "id" : "f34",
      "type" : "HtmlDialogMethodStart",
      "name" : "addDeputy()",
      "config" : {
        "callSignature" : "addDeputy",
        "guid" : "178C51E41C8D1372"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1152 },
        "labelOffset" : { "x" : 1, "y" : 35 }
      },
      "connect" : { "id" : "f68", "to" : "f44" }
    }, {
      "id" : "f41",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 672, "y" : 1152 }
      }
    }, {
      "id" : "f44",
      "type" : "Script",
      "name" : "Add deputy",
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivyteam.ivy.security.ISecurityContext;",
            "import java.util.Arrays;",
            "import ch.ivy.addon.portalkit.enums.DeputyRoleType;",
            "import ch.ivy.addon.portalkit.util.DeputyRoleUtils;",
            "import javax.faces.application.FacesMessage;",
            "import javax.faces.context.FacesContext;",
            "import ch.ivyteam.ivy.security.ISecurityMember;",
            "",
            "ISecurityMember selectedAssignee = in.#selectedDeputy is initialized ? ISecurityContext.current().members().find(in.selectedDeputy.getMemberName()) : null;",
            "if (!(#selectedAssignee is initialized) || in.selectedDeputies.contains(selectedAssignee)) {",
            "  FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR, \"\", ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/Messages/errorSelectInvalidDeputy\")));",
            "} else if (DeputyRoleType.PERSONAL_TASK_DURING_ABSENCE.equals(in.selectedDeputyRole.deputyRoleType) && DeputyRoleUtils.isSecurityMemberSelectedInDeputyRoleByType(in.deputyRoles, DeputyRoleType.PERSONAL_TASK_PERMANENT, selectedAssignee)) {",
            "  String errorMessage = ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/Messages/errorSelectedInPersonalTaskPermanentDeputies\", Arrays.asList(ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/personalTaskPermanentDeputies\")));",
            "  FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR, \"\", errorMessage));",
            "} else if (DeputyRoleType.PERSONAL_TASK_PERMANENT.equals(in.selectedDeputyRole.deputyRoleType) && DeputyRoleUtils.isSecurityMemberSelectedInDeputyRoleByType(in.deputyRoles, DeputyRoleType.PERSONAL_TASK_DURING_ABSENCE, selectedAssignee)) {",
            "  String errorMessage = ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/Messages/errorSelectedInPersonalTaskPermanentDeputies\", Arrays.asList(ivy.cms.co(\"/ch.ivy.addon.portalkit.ui.jsf/AbsenceAndDeputy/personalTaskDuringAbsenceDeputies\")));",
            "  FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR, \"\", errorMessage));",
            "} else {",
            "  in.selectedDeputies.add(selectedAssignee);",
            "}"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 256, "y" : 1152 }
      },
      "connect" : { "id" : "f29", "to" : "f41" }
    }, {
      "id" : "f69",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 672, "y" : 1248 }
      }
    }, {
      "id" : "f70",
      "type" : "HtmlDialogMethodStart",
      "name" : "removeDeputy(ISecurityMember)",
      "config" : {
        "callSignature" : "removeDeputy",
        "input" : {
          "params" : [
            { "name" : "assignee", "type" : "ch.ivyteam.ivy.security.ISecurityMember" }
          ],
          "code" : "out.selectedDeputies.remove(param.assignee);"
        },
        "guid" : "178C53ACFA8D53DD"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1248 },
        "labelOffset" : { "x" : 11, "y" : 36 }
      },
      "connect" : { "id" : "f71", "to" : "f69" }
    }, {
      "id" : "f72",
      "type" : "HtmlDialogEventStart",
      "name" : "closeDialog",
      "config" : {
        "guid" : "0178C5540F2D37A3"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1472 }
      },
      "connect" : { "id" : "f79", "to" : "f78", "via" : [ { "x" : 440, "y" : 1472 } ] }
    }, {
      "id" : "f73",
      "type" : "HtmlDialogMethodStart",
      "name" : "updateSelectedDeputies()",
      "config" : {
        "callSignature" : "updateSelectedDeputies",
        "guid" : "178C5540F2DA7BD2"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1408 },
        "labelOffset" : { "x" : 18, "y" : 35 }
      },
      "connect" : { "id" : "f85", "to" : "f75" }
    }, {
      "id" : "f74",
      "type" : "Script",
      "name" : "Initialize dialog",
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.DeputyRoleUtils;",
            "",
            "in.selectedDeputies = in.selectedDeputyRole.getDeputies();"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 248, "y" : 1312 }
      },
      "connect" : { "id" : "f82", "to" : "f76" }
    }, {
      "id" : "f75",
      "type" : "Script",
      "name" : "update selected deputies",
      "config" : {
        "output" : {
          "code" : "in.selectedDeputyRole.setDeputies(in.selectedDeputies);"
        }
      },
      "visual" : {
        "at" : { "x" : 256, "y" : 1408 },
        "size" : { "width" : 144, "height" : 60 }
      },
      "connect" : { "id" : "f80", "to" : "f78" }
    }, {
      "id" : "f76",
      "type" : "HtmlDialogEnd",
      "visual" : {
        "at" : { "x" : 672, "y" : 1312 }
      }
    }, {
      "id" : "f77",
      "type" : "HtmlDialogMethodStart",
      "name" : "initSelectedDeputies(DeputyRole)",
      "config" : {
        "callSignature" : "initSelectedDeputies",
        "input" : {
          "params" : [
            { "name" : "deputyRole", "type" : "ch.ivy.addon.portalkit.dto.DeputyRole" }
          ],
          "map" : {
            "out.selectedDeputyRole" : "param.deputyRole"
          },
          "code" : [
            "int indexOfSelectedDeputyRole = out.deputyRoles.indexOf(param.deputyRole);",
            "out.selectedDeputyRoleId = \"absences-management-form:substitute-table:\" + indexOfSelectedDeputyRole + \":selected-deputies-link\";"
          ]
        },
        "guid" : "178C5540F2DB1373"
      },
      "visual" : {
        "at" : { "x" : 96, "y" : 1312 },
        "labelOffset" : { "x" : 31, "y" : 35 }
      },
      "connect" : { "id" : "f83", "to" : "f74" }
    }, {
      "id" : "f78",
      "type" : "Script",
      "name" : "Reset dialog inputs",
      "config" : {
        "output" : {
          "code" : [
            "import java.util.ArrayList;",
            "",
            "out.selectedDeputies = new ArrayList();",
            "out.selectedDeputy = null;"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 440, "y" : 1408 }
      },
      "connect" : { "id" : "f81", "to" : "f76", "via" : [ { "x" : 672, "y" : 1408 } ] }
    }, {
      "id" : "f51",
      "type" : "Script",
      "name" : "update substitutes",
      "config" : {
        "security" : "system",
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.DeputyRoleUtils;",
            "",
            "in.substitutes = DeputyRoleUtils.getSubstitutesFromDeputyRoles(in.deputyRoles);"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 336, "y" : 424 }
      },
      "connect" : { "id" : "f64", "to" : "f101" }
    }, {
      "id" : "f65",
      "type" : "Script",
      "name" : [
        "Set end date",
        "to selected absence"
      ],
      "config" : {
        "output" : {
          "code" : [
            "import ch.ivy.addon.portalkit.util.Dates;",
            "",
            "java.util.Date endOfDate = Dates.toEndOfDate(in.selectedAbsence.getUntil());",
            "in.selectedAbsence.setUntil(endOfDate);"
          ]
        }
      },
      "visual" : {
        "at" : { "x" : 496, "y" : 528 },
        "size" : { "width" : 144, "height" : 60 }
      },
      "connect" : { "id" : "f21", "to" : "f121" }
    } ]
}