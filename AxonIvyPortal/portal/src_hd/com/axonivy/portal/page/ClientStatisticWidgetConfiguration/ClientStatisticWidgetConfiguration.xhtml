<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
  xmlns:pc="http://xmlns.jcp.org/jsf/composite/components">
<h:body>
  <ui:composition template="/layouts/BasicTemplate.xhtml">
    <ui:define name="head">
      <h:outputScript library="primefaces" name="chartjs/chartjs.js" />
      <h:outputScript name="client-statistic.js" library="js" />
    </ui:define>
    <ui:define name="title">Custom Statistic Widget Configuration</ui:define>
    <ui:define name="pageContent">

      <h:form id="config-form">

        <!-- Aggregates Field -->
        <h:panelGrid columns="2">
          <h:outputLabel for="aggregates" value="Aggregates" />
          <p:autoComplete id="aggregates" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.aggregates}"
            completeMethod="#{clientStatisticWidgetConfigurationBean.completeAggregates}" var="aggregate"
            itemLabel="#{aggregate}" itemValue="#{aggregate}" forceSelection="true" dropdown="true" />
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="filter" value="Filter" />
          <p:inputText id="filter" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.filter}" />
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="permissions" value="Permissions" />
          <p:autoComplete id="permissions" scrollHeight="210" dropdown="true"
            completeMethod="#{clientStatisticWidgetConfigurationBean.completePermissions}"
            styleClass="manage-dashboard__input" inputStyleClass="manage-dashboard__autocomplete-input"
            value="#{clientStatisticWidgetConfigurationBean.clientStatistic.permissionDTOs}" var="responsible"
            itemValue="#{responsible}" itemLabel="#{responsible.briefDisplayNameWithState}" converter="pojoConverter"
            cache="true" maxResults="100" multiple="true"
            moreText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/more')}..." dynamic="true"
            forceSelection="true">
            <p:ajax event="itemSelect"
              listener="#{clientStatisticWidgetConfigurationBean.onSelectPermissionForDashboard}" update="permissions"
              global="false" process="@this" immediate="true" />
            <p:ajax event="itemUnselect"
              listener="#{clientStatisticWidgetConfigurationBean.onUnSelectPermissionForDashboard}" global="false"
              process="@this" immediate="true" />
            <p:column>
              <pc:securityMemberNameAndAvatar displayName="#{dashboardTaskFilterBean.formatName(responsible)}"
                securityMember="#{responsible}">
                <f:facet name="alternativeAvatar">
                  <h:outputText rendered="#{not avatarBean.isShowAvatar()}"
                    styleClass="fa #{responsible.isUser() ? 'fa-user' : 'fa-users'} u-mar-right-5" />
                </f:facet>
              </pc:securityMemberNameAndAvatar>
            </p:column>
          </p:autoComplete>
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="target" value="Chart Target" />

          <p:selectOneMenu id="target"
            value="#{clientStatisticWidgetConfigurationBean.clientStatistic.chartTarget}">
            <f:selectItem itemLabel="Select a Chart Target" itemValue="#{null}" />
            <f:selectItems value="#{clientStatisticWidgetConfigurationBean.allChartTargets}" var="target"
              itemLabel="#{chartTarget}" itemValue="#{chartTarget}" />
          </p:selectOneMenu>
        </h:panelGrid>


        <h:panelGrid columns="2">
          <h:outputLabel for="type" value="Chart Type" />
          <p:selectOneMenu id="type" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.chartType}">
            <f:selectItem itemLabel="Select a Chart Type" itemValue="#{null}" />
            <f:selectItems value="#{clientStatisticWidgetConfigurationBean.allChartTypes}" var="type"
              itemLabel="#{chartType}" itemValue="#{chartType}" />
          </p:selectOneMenu>
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="refresh-interval" value="Refresh Interval (seconds)" />
          <p:inputText id="refresh-interval"
            value="#{clientStatisticWidgetConfigurationBean.clientStatistic.refreshInterval}" />
        </h:panelGrid>

        <h:panelGrid columns="3">
          <p:outputLabel value="Name" for="name" />
          <p:inputText id="name" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.name}" maxlength="200" />
          <p:commandButton id="add-name-language-button" icon="si si-chat-translate"
            actionListener="#{clientStatisticWidgetConfigurationBean.updateNameByLocale()}" process="name"
            update="name-language-config:multiple-languages-dialog" oncomplete="PF('multiple-languages-dialog').show();" />
        </h:panelGrid>

        <h:panelGrid columns="3">
          <p:outputLabel value="Description" for="description" />
          <p:inputText id="description" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.description}"
            maxlength="200" />
          <p:commandButton id="add-description-language-button" icon="si si-chat-translate"
            actionListener="#{clientStatisticWidgetConfigurationBean.updateDescriptionByLocale()}" process="description"
            update="description-language-config:multiple-languages-dialog"
            oncomplete="PF('multiple-languages-dialog').show();" />
        </h:panelGrid>

        <h:panelGrid columns="3">
          <p:outputLabel value="Category title" for="category-title" />
          <p:inputText id="category-title" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.barChartConfig.xTitle}" maxlength="200" />
          <p:commandButton id="category-title-add-language-button" icon="si si-chat-translate"
            actionListener="#{clientStatisticWidgetConfigurationBean.updateCategoryTitleByLocale()}" process="category-title"
            update="category-title-language-config:multiple-languages-dialog" oncomplete="PF('multiple-languages-dialog').show();" />
        </h:panelGrid>

        <h:panelGrid columns="3">
          <p:outputLabel value="Value title" for="value-title" />
          <p:inputText id="value-title" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.barChartConfig.yTitle}" maxlength="200" />
          <p:commandButton id="value-title-add-language-button" icon="si si-chat-translate"
            actionListener="#{clientStatisticWidgetConfigurationBean.updateValueTitleByLocale()}" process="value-title"
            update="value-title-language-config:multiple-languages-dialog" oncomplete="PF('multiple-languages-dialog').show();" />
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="icon" value="Icon" />
          <p:inputText id="icon" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.icon}" />
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="locale" value="Locale" />
          <p:inputText id="locale" value="#{clientStatisticWidgetConfigurationBean.clientStatistic.locale}"
            readonly="true" />
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="hide-label" value="Hide Label" />
          <p:selectBooleanCheckbox id="hide-label"
            value="#{clientStatisticWidgetConfigurationBean.clientStatistic.hideLabel}" />
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="manipulate-value-by" value="Manipulate Value By" />
          <p:inputText id="manipulate-value-by"
            value="#{clientStatisticWidgetConfigurationBean.clientStatistic.manipulateValueBy}" />
        </h:panelGrid>

        <h:panelGrid columns="2">
          <h:outputLabel for="background-color" value="Background Color" />
          <p:multiSelectListbox id="background-color"
            value="#{clientStatisticWidgetConfigurationBean.clientStatistic.backgroundColor}"
            listValue="#{clientStatisticWidgetConfigurationBean.clientStatistic.availableColors}" var="color"
            itemLabel="#{color}" itemValue="#{color}" />
        </h:panelGrid>
        <ic:ch.ivy.addon.portal.generic.dashboard.component.MultiLanguageConfiguration id="name-language-config"
          titles="#{clientStatisticWidgetConfigurationBean.getNames()}"
          managedBean="#{clientStatisticWidgetConfigurationBean}" dynamic="true"
          updateCurrentLanguage="#{clientStatisticWidgetConfigurationBean.updateNameForCurrentLanguage()}"
          componentToUpdateOnModify="config-form:name" componentToUpdateOnCreate="config-form:name"
          titleRequired="false" />
        <ic:ch.ivy.addon.portal.generic.dashboard.component.MultiLanguageConfiguration id="description-language-config"
          titles="#{clientStatisticWidgetConfigurationBean.getDescriptions()}"
          managedBean="#{clientStatisticWidgetConfigurationBean}" dynamic="true"
          updateCurrentLanguage="#{clientStatisticWidgetConfigurationBean.updateDescriptionForCurrentLanguage()}"
          componentToUpdateOnModify="config-form:description"
          componentToUpdateOnCreate="config-form:description" titleRequired="false" />
        <p:commandButton value="Save" action="#{clientStatisticWidgetConfigurationBean.save}" />
        <ic:ch.ivy.addon.portal.generic.dashboard.component.MultiLanguageConfiguration id="category-title-language-config"
          titles="#{clientStatisticWidgetConfigurationBean.getCategoryTitles()}"
          managedBean="#{clientStatisticWidgetConfigurationBean}" dynamic="true"
          updateCurrentLanguage="#{clientStatisticWidgetConfigurationBean.updateCategoryTitleForCurrentLanguage()}"
          componentToUpdateOnModify="config-form:category-title" componentToUpdateOnCreate="config-form:category-title"
          titleRequired="false" />
        <ic:ch.ivy.addon.portal.generic.dashboard.component.MultiLanguageConfiguration id="value-title-language-config"
          titles="#{clientStatisticWidgetConfigurationBean.getValueTitles()}"
          managedBean="#{clientStatisticWidgetConfigurationBean}" dynamic="true"
          updateCurrentLanguage="#{clientStatisticWidgetConfigurationBean.updateValueTitleForCurrentLanguage()}"
          componentToUpdateOnModify="config-form:value-title" componentToUpdateOnCreate="config-form:value-title"
          titleRequired="false" />

        <p:commandButton value="Preview" action="#{clientStatisticWidgetConfigurationBean.getPreviewData}"
          oncomplete="handlePreviewChart(xhr, status, args)" />
        <h:panelGroup layout="block" styleClass="card statistic-chart-widget__chart">
          <div style="height: 400px;" class="ui-chart js-client-statistic-chart statistic-chart-widget__canvas chart-options-config"
            data-chart-id="preview-statistic-chart"></div>
        </h:panelGroup>
        <script type="text/javascript">
          function handlePreviewChart(xhr, status, args) {
            if (args.jsonResponse) {
              const data = JSON.parse(args.jsonResponse);
              previewChart(data, "#{localeBean.locale}", "#{dateTimePatternBean.datePattern}");
            }
          }
        </script>
      </h:form>
    </ui:define>
  </ui:composition>
</h:body>

</html>
