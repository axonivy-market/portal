<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:p="http://primefaces.org/ui" 
  xmlns:fn="http://java.sun.com/jsp/jstl/functions" xmlns:jsf="http://xmlns.jcp.org/jsf"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:pc="http://xmlns.jcp.org/jsf/composite/components">

<h:body>
  <ui:composition template="/layouts/BasicTemplate.xhtml">
    <ui:define name="title">Portal Chat</ui:define>
    <ui:define name="head">
      <!-- Chatbot -->
      <h:outputScript library="js" name="chatbot-utils.js" />
      <h:outputScript library="js" name="ajax-utils.js" />
      <h:outputScript library="js" name="ai-assistant.js" />
      <h:outputStylesheet library="css" name="chatbot.css" />

      <!-- Highlight JS -->
      <h:outputScript library="js" name="highlightJS/highlight.min.js" />
      <h:outputStylesheet library="css" name="atom-one-dark.min.css" />

    </ui:define>
    <ui:define name="pageContent">
      <h:panelGroup id="assistant-main-panel" layout="block" styleClass="ui-g assistant-main-panel">
        <div class="ui-g-12 chat-container js-chat-container card">
          <h:form id="chat-form">
            <script type="text/javascript">

              var userName = "#{ivy.session.getSessionUserName()}";
              var contextPath = "#{ivy.task.getApplication().getContextPath()}";
              var resource = "#{managedBean.assistantEndPoint}";
              var ivyResource = new IvyUri().rest() + "/";
              var view = new ViewAI(resource);
              var chatbot = new Assistant(ivyResource, resource, view, `#{managedBean.getAssistantJson()}`, userName);

              $(document).ready(function(){
                hljs.configure({
                  ignoreUnescapedHTML: true
                });

                view.init();
                chatbot.bindEvents();
              });
            </script>
    
            <div id="chat-panel" class="chatbot-panel js-chatbot-panel">
              <div class="message-list js-message-list ui-g">
                <div class="ui-g-9 u-padding-0 assistant-header-wrapper">
                  <div class="assistant-header-panel">
                    <div class="assistant-name">
                      <h:outputText value="#{managedBean.assistant.name}" />
                    </div>
                    <div class="assistant-manage-button-container">
                      <p:commandButton id="manage-button" styleClass="manage-button" value="Manage"
                        onclick="PF('assistant-sidebar').show(); return false;" />
                      <p:sidebar id="assistant-sidebar" widgetVar="assistant-sidebar"
                        modal="false" showCloseIcon="false"
                        blockScroll="true" appendTo="@(body)" position="right" styleClass="manage-assistant-sidebar">
                        <div class="assistant-info-panel">
                          <ui:insert name="assistantManagementSection" />
                        </div>
                        <p:divider />
                        <div class="assistant-sidebar-footer">
                          <div>
                            <p:commandLink id="cancel-link" styleClass="u-mar-right-10" href="#"
                              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
                              actionListener="#{managedBean.onCancel()}"
                              oncomplete="PF('assistant-sidebar').hide()"
                              update="assistant-sidebar" global="false" />
                          </div>
                          <div>
                            <p:commandButton id="save-btn" icon="si si-floppy-disk"
                              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/save')}"
                              actionListener="#{managedBean.save()}" update="assistant-main-panel"
                              oncomplete="PF('assistant-sidebar').hide();" process="@this"/>
                          </div>
                        </div>
                      </p:sidebar>
                    </div>
                  </div>
                </div>

                <h:panelGroup id="chat-message-list" layout="block"
                  styleClass="chatbot-message-list js-chatbot-message-list ui-g-9 ui-sm-12">

                  <ui:insert name="welcomeSection" />

                </h:panelGroup>
                <p:scrollTop target="chat-message-list" styleClass="chatbot-message-list-scrolltop" />
              </div>
              <div class="ui-g">
                <h:panelGroup id="chat-send-form-container" layout="block"
                  styleClass="ui-g-9 ui-sm-10 ui-g chatbot-send-form js-chat-send-form">
                  <div class="chat-send-form-input-field">
                    <textarea id="message-input-field"
                      placeholder="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/typeMessage')}"
                      class="message-list-content-send-input js-chatbot-input-message ui-inputfield ui-inputtextarea ui-widget ui-state-default" />
                  </div>
                  <div class="chat-send-form-button">
                    <p:commandButton icon="si si-send-email" onclick="chatbot.onClickSendMessage()"
                      styleClass="rounded-button" global="false" type="button" />
                  </div>
                </h:panelGroup>
              </div>
            </div>
      
            <div class="js-message-template u-hidden chat-message-container ui-g-12 ui-g">
              <div class="chatbot-meta ui-g-9 ui-sm-12">
                <div class="message-block">
                  <div class="chat-message js-message" />
                </div>
              </div>

            </div>
            <div class="js-message-components u-hidden">
              <p:link styleClass="external-link js-external-link" href="" target="_blank" />
            </div>
          </h:form>
        </div>
      </h:panelGroup>
      <p:inputText type="hidden" styleClass="js-thread-id" />
    </ui:define>

  </ui:composition>
</h:body>
</html>