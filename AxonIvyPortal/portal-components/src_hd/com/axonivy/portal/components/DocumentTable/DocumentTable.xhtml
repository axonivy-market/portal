<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:cc="http://xmlns.jcp.org/jsf/composite"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
<cc:interface componentType="IvyComponent">
  <cc:attribute name="nameColumnRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the name column, when set to false name column will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="sizeColumnRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the size column, when set to false size column will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="typeColumnRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the type column, when set to false type column will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="functionColumnRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the function column, when set to false function column will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="previewRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the preview icon, when set to false preview icon will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="uploadRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the upload icon, when set to false upload icon will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="downloadRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the download icon, when set to false download icon will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="deleteRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the delete icon, when set to false delete icon will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="renameRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the edit filename icon, when set to false the icon will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="messageRendered" default="true" type="Boolean"
    shortDescription="Boolean value to specify the rendering of the message, when set to false message will not be rendered. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="renderChooseUploadIcon" default="true" type="Boolean"
    shortDescription="Defines if the button to upload document is displayed or not. Type: Boolean. Default value: true. Required: false." />
  <cc:attribute name="lazy" default="false" type="Boolean"
    shortDescription="Boolean value to specify whether the table should load data lazily and enable pagination. Type: Boolean. Default value: false. Required: false." />
  
  <cc:attribute name="fileLimit" type="Integer" shortDescription="Maximum number of files that can be uploaded. Type: Integer. Default value: -1 (unlimited). Required: false." default="-1" />
  <cc:attribute name="sizeLimit" type="Long" shortDescription="Maximum size of an individual file in bytes. Type: Long. Required: false." />
  <cc:attribute name="uploadText" default="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Upload')}" type="String"
    shortDescription="Label text displayed on the upload button. Type: String. Default value: 'Upload new file'. Required: false." />
  <cc:attribute name="updatedComponentAfterUploaded" type="String" shortDescription="Comma-separated clientIds (or EL expressions) of components to update after a successful upload. Example: 'document-table document-messages'. Required: false." />
  
  <cc:attribute name="previewTitle" default="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Preview')}" type="String"
    shortDescription="Tooltip text displayed when hovering over the preview icon. Type: String. Default value: 'Preview'. Required: false."/>
  <cc:attribute name="previewIcon" default="si si-view-1" type="String"
    shortDescription="Icon class for the preview link. Type: String. Default value: 'si si-view-1'. Required: false."/>
  <cc:attribute name="previewStyleClass" type="String"
    shortDescription="Custom CSS style class to apply to the preview link. Type: String. Required: false."/>
  <cc:attribute name="previewDialogStyleClass" type="String"
    shortDescription="Custom CSS style class to apply to the preview dialog. Type: String. Required: false."/>
  <cc:attribute name="previewPDFStyleClass" type="String"
    shortDescription="Custom CSS style class to apply to PDF preview media element. Type: String. Required: false."/>
  <cc:attribute name="previewImageStyleClass" type="String"
    shortDescription="Custom CSS style class to apply to image preview element. Type: String. Required: false."/>

  <cc:attribute name="downloadTitle" default="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Download')}" type="String"
    shortDescription="Tooltip text displayed when hovering over the download icon. Type: String. Default value: 'Download'. Required: false."/>
  <cc:attribute name="downloadIcon" default="si si-download-bottom" type="String"
    shortDescription="Icon class for the download link. Type: String. Default value: 'si si-download-bottom'. Required: false."/>
  <cc:attribute name="downloadStyleClass" type="String"
    shortDescription="Custom CSS style class to apply to the download link. Type: String. Required: false."/>

  <cc:attribute name="deleteTitle" default="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Delete')}" type="String"
    shortDescription="Tooltip text displayed when hovering over the delete icon. Type: String. Default value: 'Delete'. Required: false."/>
  <cc:attribute name="deleteIcon" default="si si-bin-1" type="String"
    shortDescription="Icon class for the delete link. Type: String. Default value: 'si si-bin-1'. Required: false."/>
  <cc:attribute name="deleteStyleClass" type="String"
    shortDescription="Custom CSS style class to apply to the delete link. Type: String. Required: false."/>
  <cc:attribute name="updatedComponentAfterDeleted" type="String"
    shortDescription="Comma-separated clientIds (or EL expressions) of components to update after a successful deletion. Example: 'document-table document-messages'. Required: false."/>

  <cc:attribute name="renameText" default="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/RenamingDocument')}" type="String"
    shortDescription="Tooltip text displayed when hovering over the rename icon. Type: String. Default value: 'Rename document'. Required: false."/>
  <cc:attribute name="renameTitle" default="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/RenamingDocument')}" type="String"
    shortDescription="Title text displayed in the rename dialog header. Type: String. Default value: 'Rename document'. Required: false."/>
  <cc:attribute name="renameStyleClass" type="String"
    shortDescription="Custom CSS style class to apply to the rename link. Type: String. Required: false."/>
  <cc:attribute name="updatedComponentAfterRenamed" type="String"
    shortDescription="Comma-separated clientIds (or EL expressions) of components to update after a successful rename. Example: 'document-table document-messages'. Required: false."/>

  <cc:attribute name="selectedType" type="com.axonivy.portal.components.enums.DocumentType"
    shortDescription="Default document type to be selected. If not provided, the first item of typeSelectionItems will be used. Type: com.axonivy.portal.components.enums.DocumentType. Required: false."/>
  <cc:attribute name="typeSelectionItems" type="com.axonivy.portal.components.enums.DocumentType[]"
    shortDescription="Array of DocumentType objects for the type selection dropdown. Default is #{documentUploadBean.documentTypes} which returns BasicDocumentType enum values (DOCUMENTATION, CONTRACT, INFORMATION, EMAIL, OTHERS). Type: com.axonivy.portal.components.enums.DocumentType[]. Required: false."/>
  
  <cc:attribute name="enableScriptCheckingForUploadedDocument" type="Boolean" default="#{documentUploadBean.getPortalScriptCheckingSettingOrDefault(false)}"
    shortDescription="Boolean value to specify script checking. The setting will detect Portal setting Portal.Document.EnableScriptChecking as its default value. If the Portal setting is not available, defaults to false. Type: Boolean. Required: false." />
  <cc:attribute name="enableVirusScannerForUploadedDocument" type="Boolean" default="#{documentUploadBean.getPortalVirusScannerSettingOrDefault(false)}"
    shortDescription="Boolean value to specify virus scanner checking. The setting will detect Portal setting Portal.Document.EnableVirusScanner as its default value. If the Portal setting is not available, defaults to false. Type: Boolean. Required: false." />
  <cc:attribute name="allowedUploadFileTypes" type="String" default="#{documentUploadBean.getPortalAllowedUploadFileTypesSettingOrDefault('doc,docx,xls,xlsx,xlsm,csv,pdf,ppt,pptx,txt,zip,jpg,jpeg,bmp,png')}" type="java.lang.String"
    shortDescription="List of file extension that can be uploaded separated by comma. The setting will detect Portal setting Portal.Document.WhitelistExtension as its default value. If Portal setting is not available, default value is doc,docx,xls,xlsx,xlsm,csv,pdf,ppt,pptx,txt,zip,jpg,jpeg,bmp,png. Type: String. Required: false."/>
</cc:interface>

<cc:implementation>
  <h:outputStylesheet library="css" name="document-table-component.css" />
  
  <ui:param name="messageComponentId" value="#{cc.clientId.concat(':document-messages')}" />
  <ui:param name="typeSelectionItems" value="#{not empty cc.attrs.typeSelectionItems ? cc.attrs.typeSelectionItems : documentUploadBean.documentTypes}" />
  <ui:param name="selectedType" value="#{not empty cc.attrs.selectedType ? cc.attrs.selectedType : typeSelectionItems[0]}" />
  <f:event type="preRenderComponent" listener="#{logic.renderComponent(messageComponentId, cc.attrs.typeColumnRendered, selectedType, cc.attrs.enableScriptCheckingForUploadedDocument, cc.attrs.enableVirusScannerForUploadedDocument, cc.attrs.allowedUploadFileTypes, cc.attrs.sizeLimit)}" />

  <div id="#{cc.clientId}" class="document-table-component">

    <cc:renderFacet name="componentHeader" />

    <p:messages id="document-messages" for="document-messages" rendered="#{cc.attrs.messageRendered}" />
    <p:dataTable id="document-table" value="#{data.documents}" var="document"
      emptyMessage="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/NoFile')}" styleClass="margin-top-5"
      widgetVar="fileTableVar" lazy="#{cc.attrs.lazy}"
      paginator="#{cc.attrs.lazy}" rows="#{cc.attrs.lazy ? 5 : 0}"
      paginatorPosition="#{cc.attrs.lazy ? 'bottom' : ''}" paginatorAlwaysVisible="#{cc.attrs.lazy ? 'true' : ''}"
      paginatorTemplate="#{cc.attrs.lazy ? '{PreviousPageLink} {PageLinks} {NextPageLink} {RowsPerPageDropdown}' : ''}"
      pageLinks="#{cc.attrs.lazy ? '5' : ''}" rowsPerPageTemplate="#{cc.attrs.lazy ? '5,10,20,50' : ''}">
      <f:event type="preRenderComponent" listener="#{logic.renderTable()}" />

      <p:column headerText="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Name')}"
        rendered="#{cc.attrs.nameColumnRendered}" styleClass="document-name-column">
        <h:outputText id="name" value="#{document.name}" title="#{document.relativePath}" />
      </p:column>
      <p:column headerText="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Size')}"
        rendered="#{cc.attrs.sizeColumnRendered}" styleClass="document-size-column">
        <h:outputText id="size" value="#{document.userFriendlySize}" title="#{document.userFriendlySize}" />
      </p:column>
      <p:column headerText="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Type')}" rendered="#{cc.attrs.typeColumnRendered}"
        styleClass="document-type-column">
        <h:outputText id="type" value="#{document.type.toString()}" />
      </p:column>
      <cc:insertChildren />
      <p:column styleClass="align-center-column document-action-column" rendered="#{cc.attrs.functionColumnRendered}"
        headerText="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/FileFunction')}">
        <div class="flex align-items-center justify-content-around col-12">
        <p:commandLink id="document-preview" ariaLabel="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Preview')}" 
          process="@this"
          styleClass="#{cc.attrs.previewStyleClass}"
          actionListener="#{logic.preview(document)}"
          rendered="#{documentUploadBean.canPreviewDocument(document,cc.attrs.previewRendered)}"
          update="#{cc.clientId}:preview-document-dialog"
          oncomplete="PF('preview-document-dialog').show()">
          <i class="fa #{cc.attrs.previewIcon}" />
          <p:tooltip for="document-preview" trackMouse="true" hideEvent="mouseleave click"
            value="#{cc.attrs.previewTitle}" />
        </p:commandLink>
        <p:commandLink id="edit-filename" ariaLabel="#{cc.attrs.renameText}"
          rendered="#{cc.attrs.renameRendered}" styleClass="#{cc.attrs.renameStyleClass}" immediate="true"
          actionListener="#{data.setSelectedDocument(document)}"
          update="#{cc.clientId}:document-renaming-dialog"
          oncomplete="PF('document-renaming-dialog').show()">
          <i class="fa si si-graphic-tablet-drawing-pen " />
          <p:tooltip for="edit-filename" trackMouse="true" hideEvent="mouseleave click" value="#{cc.attrs.renameText}" />
        </p:commandLink>
        <p:commandLink id="document-download" styleClass="#{cc.attrs.downloadStyleClass}"
          ariaLabel="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Download')}"
          immediate="true" ajax="false" process="@none"
          rendered="#{cc.attrs.downloadRendered}">
          <i class="fa #{cc.attrs.downloadIcon}" />
          <p:fileDownload value="#{logic.download(document)}" />
          <p:tooltip for="document-download" trackMouse="true" hideEvent="mouseleave click" value="#{cc.attrs.downloadTitle}" />
        </p:commandLink>
        <p:commandLink id="document-delete" styleClass="#{cc.attrs.deleteStyleClass}"
          ariaLabel="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Delete')}"
          actionListener="#{data.setSelectedDocument(document)}" rendered="#{cc.attrs.deleteRendered}"
          update="#{cc.attrs.updatedComponentAfterDeleted}" immediate="true"
          oncomplete="PF('document-delete-dialog').show()">
          <i class="fa #{cc.attrs.deleteIcon}" />
          <p:tooltip for="document-delete" trackMouse="true" hideEvent="mouseleave click" value="#{cc.attrs.deleteTitle}" />
        </p:commandLink>
        </div>
      </p:column>
    </p:dataTable>
    <div class="ui-g">
      <h:panelGroup layout="block" rendered="#{cc.attrs.typeColumnRendered or cc.attrs.uploadRendered}" styleClass="upload-container ui-g-12">
        <p:fileUpload id="document-upload" mode="advanced" auto="true" dragDropSupport="true"
          chooseIcon="#{cc.attrs.renderChooseUploadIcon? 'si si-add-small' : '' }"
          listener="#{logic.upload}"
          rendered="#{cc.attrs.uploadRendered}"
          update="document-table document-messages #{cc.attrs.updatedComponentAfterUploaded}"
          invalidSizeMessage="#{documentUploadBean.getFileUploadInvalidSizeMessage(documentUploadBean.fileUploadSizeLimit)}" 
          label="#{not empty cc.attrs.uploadText ? cc.attrs.uploadText : ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Upload')}"
          cancelLabel="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/Cancel')}"
          onstart="#{logic.setFileLimit(cc.attrs.fileLimit)}" sizeLimit="#{documentUploadBean.fileUploadSizeLimit}"
          styleClass="upload-button" value="#{data.uploadedFile}">
        </p:fileUpload>
        <p:selectOneMenu id="type-selection" value="#{data.typeSelection}" rendered="#{cc.attrs.typeColumnRendered}" converter="pojoConverter" styleClass="type-selection">
          <p:ajax global="false" />
          <f:selectItems value="#{typeSelectionItems}" var="type" itemLabel="#{type.toString()}"
            itemValue="#{type}" />
        </p:selectOneMenu>
        <p:outputLabel for="type-selection" value="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Type')}: " styleClass="type-selection-label" rendered="#{cc.attrs.typeColumnRendered}" />
      </h:panelGroup>
    </div>

    <cc:renderFacet name="componentFooter" />
    
    <!-- set closable to true to force to close stream by clicking Close button -->
    <p:dialog widgetVar="preview-document-dialog" id="preview-document-dialog" appendTo="@(body)" maximizable="true"
        header="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Preview')}" closable="false" resizable="false"
        modal="true" width="70vw" styleClass="#{cc.attrs.previewDialogStyleClass}" showEffect="fade" hideEffect="fade"
        dynamic="true" fitViewport="true" responsive="true">
      <div class="ui-g-12">
        <p:media value="#{data.streamedContent}" width="100%" height="450" styleClass="#{cc.attrs.previewPDFStyleClass}" cache="false" id="media-content" player="pdf" rendered="#{!data.isImage}"/>
        <p:graphicImage alt="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/Preview')}" 
          value="#{data.streamedContent}" width="100%" height="450" stream="true" rendered="#{data.isImage}" styleClass="preview-image #{cc.attrs.previewImageStyleClass}" cache="false"/>
      </div>
      <f:facet name="footer">
        <div class="u-dialog-footer-actions-group">
          <p:commandButton value="#{ivy.cms.co('/Labels/Close')}" 
            ariaLabel="#{ivy.cms.co('/Labels/Close')}"
            id="preview-document-close-button" actionListener="#{logic.closeStream}"
            icon="#{visibilityBean.generateButtonIcon('si si-remove')}" onclick="PF('preview-document-dialog').hide();" />
        </div>
      </f:facet>
    </p:dialog>

    <p:dialog id="document-delete-dialog" widgetVar="document-delete-dialog" appendTo="@(body)" closable="true"
      closeOnEscape="true" modal="true" draggable="false" rendered="#{cc.attrs.deleteRendered}"
      header="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/Confirmation')}" resizable="false"
      responsive="true">
      #{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/ConfirmForDelete')}
      <f:facet name="footer">
        <p:commandButton id="document-deletion-yes"
          ariaLabel="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/Yes')}"
          value="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/Yes')}" process="@this"
          update="document-table document-messages #{cc.attrs.updatedComponentAfterDeleted}"
          actionListener="#{logic.delete}" oncomplete="PF('document-delete-dialog').hide();" />
        <p:commandButton id="document-deletion-no" styleClass="portal-cancel-button"
          ariaLabel="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/No')}"
          value="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/No')}" type="button"
          onclick="PF('document-delete-dialog').hide()" />
      </f:facet>
    </p:dialog>

    <p:dialog id="document-renaming-dialog" widgetVar="document-renaming-dialog" appendTo="@(body)"
      header="#{cc.attrs.renameTitle}"  modal="true" resizable="false" showEffect="fade" hideEffect="fade"
      width="50vw" dynamic="true" fitViewport="true" responsive="true">
      <h:form id="document-renaming-form">
        <p:messages id="renaming-file-messages" escape="false" />
        <p:inputText id="new-filename" value="#{data.selectedDocument.name}" converter="filenameConverter"
          onfocus="this.select()" maxlength="#{portalComponentUtilsBean.filenameMaxLength}" styleClass="w-full"
          required="true" requiredMessage="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/DocumentTable/FilenameEmpty')}"/>
        <h:panelGroup layout="block" styleClass="mt-4 flex gap-3 align-items-center justify-content-end">
          <p:commandLink id="document-rename-cancel-button"
            value="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/Cancel')}"
            ariaLabel="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/Cancel')}"
            onclick="PF('document-renaming-dialog').hide(); return false;" />
          <p:commandButton id="document-rename-save-button"
            value="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/Save')}"
            ariaLabel="#{ivy.cms.co('/Dialogs/com/axonivy/portal/components/Common/Save')}" 
            icon="si si-floppy-disk"
            process="@form"
            actionListener="#{logic.renameDocument}"
            update="#{cc.clientId}:document-table document-renaming-form:renaming-file-messages #{cc.attrs.updatedComponentAfterRenamed}"
            oncomplete="if (document.getElementById('#{cc.clientId}:document-renaming-form:renaming-file-messages').querySelector('.ui-messages-info')) PF('document-renaming-dialog').hide()"
          />
        </h:panelGroup>
      </h:form>
    </p:dialog>
  </div>
</cc:implementation>
</html>