<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:c="http://java.sun.com/jsp/jstl/core"
  xmlns:pe="http://primefaces.org/ui/extensions">
<h:body>
  <ui:composition template="/layouts/BasicTemplate.xhtml">
    <ui:param name="isWorkingOnATask" value="true" />
    <ui:param name="announcementInvisible" value="true" />

    <ui:define name="head">
      <h:outputScript name="case-widget.js" library="js" />
    </ui:define>

    <ui:define name="simplePageContent">
    <p:growl id="task-template-growl" />

      <c:set var="case" value="#{caseWidgetBean.findCase(caseId)}" scope="request" />
      <ui:insert name="breadCrumb" />

      <div class="#{processChainDirection eq 'VERTICAL' ? '' : 'task-template-title-horizontal-container'}">
        <h:panelGroup layout="block" styleClass="task-template-title #{processChainDirection eq 'VERTICAL' ? 'task-name-vertical-process-chain' : ''}" rendered="#{task ne null}">
          <ui:insert name="taskName">
            <span class=" fa fa-check-square-o task-template-title-icon"></span>
            <h:outputText id="title" title="#{task.name}" value="#{task.name}" />
          </ui:insert>
        </h:panelGroup>

        <h:panelGroup layout="block" styleClass="process-chain-container #{processChainDirection eq 'VERTICAL' ? 'vertical-process-chain-container' : ''}" >
          <ui:insert name="process_chain_area">
            <ic:ch.ivy.addon.portalkit.singleapp.process.ProcessChain id="process-chain-component" startMethod="start" componentId="process-chain-component-id"
              shape="#{processChainShape eq 'LINE' ? 'LINE' : 'CIRCLE'}"
              direction="#{processChainDirection eq 'VERTICAL' ? 'VERTICAL' : 'HORIZONTAL'}"
              isShowAllSteps="false"
              actualStepIndex="#{actualStepIndex}" steps="#{steps}"
              currentIndex="#{taskTemplateBean.getIndexOfCurrentStage(caseId)}" stages="#{taskTemplateBean.getStagesBaseOnCurrentStage(caseId)}" />
          </ui:insert>
        </h:panelGroup>
      </div>

      <ui:insert name="errorsZone" />
      <ui:insert name="infoZone" />
      <h:panelGroup layout="block" styleClass="task-template-content #{processChainDirection eq 'VERTICAL' ? 'vertical-process-chain' : ''}">

        <div class="task-template-tasks-command">
          <p:commandLink id="show-adhoc-history" rendered="#{taskTemplateBean.hasAdhocTasks()}"
            title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/adhocHistoryTooltip')}" styleClass="case-action-link"
            oncomplete="PF('adhoc-task-history-dialog').show()" >
            <i class="fa fa-history fa-2x" />
          </p:commandLink>
          <p:spacer width="7"/>
          <p:commandLink id="start-adhoc" rendered="#{empty isShowStartAdhocButton? taskTemplateBean.hasExpressAdhocWF(): isShowStartAdhocButton}"
            title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/startAdHocTooltip')}" styleClass="case-action-link"
            oncomplete="PF('adhoc-task-reset-confirmation-dialog').show()" >
            <i class="fa fa-random fa-2x" />
          </p:commandLink>
          <p:spacer width="7"/>
          <p:commandLink id="chat-group" global="false" styleClass="case-action-link"
            actionListener="#{chatAssigneeBean.createGroupChatForConfiguredRoleList}"
            rendered="#{chatRendererBean.isGroupChatRendered and !(ivy.task.state eq 'CREATED')}" title="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/createProcessChat')}"
            update="chat-assignee-dialog">
            <span class="fa fa-comments fa-2x" />
          </p:commandLink>
          <p:spacer width="7" />
          <c:set var="isSideStepDisabled" value="#{!taskTemplateBean.checkSideStepsEnabled(caseId)}" />
          <p:commandLink id="side-steps-menu"
            styleClass="case-action-link" global="false"
            disabled="#{isSideStepDisabled}">
            <span class="action-icon tmi-ellipsis-h side-step-icon" 
              title="#{ivy.cms.co(isSideStepDisabled ? '/ch.ivy.addon.portalkit.ui.jsf/caseDetails/noSideSteps' : '/ch.ivy.addon.portalkit.ui.jsf/caseDetails/sideSteps' )}" />
          </p:commandLink>
        </div>

      <p:overlayPanel id="side-steps-panel" widgetVar="side-steps-panel" for="side-steps-menu" my="left top" at="left bottom"
        appendTo="@(body)" styleClass="side-steps-container" dynamic="false" rendered="#{taskTemplateBean.checkSideStepsEnabled(caseId)}">
        <ui:repeat var="sidestep" value="#{taskTemplateBean.sideStepList}">
          <p:commandLink id="side-step-item" styleClass="side-step-item" value="#{sidestep.getName()}"
            global="false"
            actionListener="#{taskTemplateBean.setSelectedSideStep(sidestep)}"
            oncomplete="PF('sidestep-task-reset-confirmation-dialog').show()" />
        </ui:repeat>
      </p:overlayPanel>

        <p:tabView id="task-template-tabview" prependId="false" onTabShow="onTabShow(); onStatusTabShow();">
          <ui:insert name="dynamicTabs">
            <!-- You can add one or many tabs here -->
          </ui:insert>

          <p:tab id="request-tab"
            title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/CaseDetailsTemplate/requestTabTitle')}"
            rendered="#{showTaskFormTab == null ? true : showTaskFormTab}">
            <ui:insert name="taskForm">
              <!--                Task Form -->
            </ui:insert>
          </p:tab>
          <p:tab id="status-tab"
            title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/CaseDetailsTemplate/statusTabTitle')}"
            rendered="#{showCaseStatusInfoTab == null ? true : showCaseStatusInfoTab}">
            <ui:insert name="caseStatusTab">
              <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/CaseDetailsTemplate/noCaseId')}" rendered="#{case ne null and caseWidgetBean.isHiddenCase(case)}" />
                <h:panelGroup id="case-details-panel" layout="block" rendered="#{case ne null and !caseWidgetBean.isHiddenCase(case)}"
                  styleClass="js-case-default-widget-container case-default-widget-container js-simple-container js-for-search-result case-details">
                  <!-- HEADER -->
                  <h:panelGroup id="widget-column-header" class="widget-column-header js-case-widget-column-header">
                    <h:panelGroup styleClass="case-list-unsortable-header-cell case-list-name-desc-header-cell js-unsortable-header-cell">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/defaultColumns/NAME')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell TexAlCenter js-unsortable-header-cell">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/defaultColumns/ID')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell js-unsortable-header-cell">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/defaultColumns/CREATOR')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell TexAlCenter js-unsortable-header-cell">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/defaultColumns/CREATION_TIME')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell TexAlCenter js-unsortable-header-cell">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/defaultColumns/FINISHED_TIME')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell TexAlCenter js-unsortable-header-cell">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/defaultColumns/STATE')}" />
                    </h:panelGroup>
                  </h:panelGroup>

                  <ic:ch.ivy.addon.portalkit.component.CaseItem 
                  	case="#{case}" 
                  	id="case-item" 
                    initialActive="true"
                    itemStyleClass="case-even-row"
                    alwaysShowDetails="true"
                    canDestroyCase="false">

                    <!-- CASE HEADER -->
                    <f:facet name="caseHeader">
                      <ic:ch.ivy.addon.portalkit.component.CaseHeader id="case-header" case="#{case}" />
                    </f:facet>

                    <!-- CASE BODY -->
                    <f:facet name="caseBody">
                      <ic:ch.ivy.addon.portalkit.component.CaseItemGeneralInformation id="general-information" case="#{case}" />
                      <ic:ch.ivy.addon.portalkit.component.CaseItemRelatedTask id="related-tasks" case="#{case}" />
                      <ic:ch.ivy.addon.portalkit.component.CaseItemHistory id="history" case="#{case}" />
                      <ic:ch.ivy.addon.portalkit.component.CaseItemDocument id="document" case="#{case}" componentToUpdate="#{p:component('history')}" />
                      <ic:ch.ivy.addon.portalkit.component.CaseItemDescription id="description" case="#{case}" />
                      <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleContainer styleClass="hidden-lg">
                        <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleButton
                          icon="fa fa-share-alt js-related-task-column-responsive-button" displayedSelectors="['.js-related-task-column']"
                          hiddenSelectorsInLargeScreen="['.case-details .replaced']"
                          hiddenSelectorsInMediumScreen="['.case-details .replaced']"
                          hiddenSelectorsInSmallScreen="['.case-details .replaced']" />
                        <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleButton
                          icon="fa fa-align-left js-history-column-responsive-button" displayedSelectors="['.js-history-column']"
                          hiddenSelectorsInLargeScreen="['.case-details .replaced']"
                          hiddenSelectorsInMediumScreen="['.case-details .replaced']"
                          hiddenSelectorsInSmallScreen="['.case-details .replaced']" />
                        <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleButton
                          icon="fa fa-file js-document-column-responsive-button" displayedSelectors="['.js-document-column']"
                          hiddenSelectorsInLargeScreen="['.case-details .replaced']"
                          hiddenSelectorsInMediumScreen="['.case-details .replaced']"
                          hiddenSelectorsInSmallScreen="['.case-details .replaced']" />
                        <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleButton
                          icon="fa fa-clipboard js-description-column-responsive-button" displayedSelectors="['.js-description-column']"
                          hiddenSelectorsInLargeScreen="['.case-details .replaced']"
                          hiddenSelectorsInMediumScreen="['.case-details .replaced']"
                          hiddenSelectorsInSmallScreen="['.case-details .replaced']" />
                      </ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleContainer>
                    </f:facet>
                  </ic:ch.ivy.addon.portalkit.component.CaseItem>
                </h:panelGroup>
            </ui:insert>
          </p:tab>
        </p:tabView>
      </h:panelGroup>

      <div>
        <div class="Fleft">
          <ui:insert name="leftButtons">
            <!-- Left Buttons -->
          </ui:insert>
        </div>

        <div class="Fright">
          <ui:insert name="rightButtons">
            <!-- Right Buttons -->
          </ui:insert>
        </div>
      </div>

    <p:dialog id="adhoc-task-reset-confirmation-dialog" resizable="false"
      header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}"
      widgetVar="adhoc-task-reset-confirmation-dialog" appendTo="@(body)"
      modal="true" dynamic="true">
      <h:outputText escape="false" styleClass="ui-confirm-dialog-message" id="adhoc-creation-message"
        value="#{taskTemplateBean.getAdhocCreationMessage()}" />
      <f:facet name="footer">
        <h:form prependId="false">
          <h:panelGroup styleClass="Fs14 ui-dialog-buttonpane">
            <p:commandButton actionListener="#{taskTemplateBean.startAdhoc()}" process="@this" update="@none" id="start-adhoc-ok-button"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" />
            <p:commandButton onclick="PF('adhoc-task-reset-confirmation-dialog').hide()" id="start-adhoc-cancel-button"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}" type="button"
              styleClass="portal-cancel-button" />
          </h:panelGroup>
        </h:form>
      </f:facet>
    </p:dialog>

    <p:dialog id="sidestep-task-reset-confirmation-dialog" resizable="false"
      header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}"
      widgetVar="sidestep-task-reset-confirmation-dialog" appendTo="@(body)"
      modal="true" dynamic="true">
      <h:outputText escape="false" styleClass="ui-confirm-dialog-message"
        value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/goToSidestepWarning')}" />
      <f:facet name="footer">
        <h:form prependId="false">
          <h:panelGroup styleClass="Fs14 ui-dialog-buttonpane">
            <p:commandButton actionListener="#{taskTemplateBean.startSideStep()}" process="@this" update="@none"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" />
            <p:commandButton onclick="PF('sidestep-task-reset-confirmation-dialog').hide()"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}" type="button"
              styleClass="portal-cancel-button" />
          </h:panelGroup>
        </h:form>
      </f:facet>
    </p:dialog>
    
     <p:dialog id="adhoc-task-history-dialog" resizable="false" visible="#{taskTemplateBean.isFirstTimeOpenOriginalAdhocTask}"
      styleClass="adhoc-task-history-dialog"
      header="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/resultFromAdhocProcess')}"
      widgetVar="adhoc-task-history-dialog" appendTo="@(body)"
      modal="true" dynamic="true">
      <p:ajax event="close" listener="#{taskTemplateBean.onCloseAdhocTaskHistoryDialog()}" />
      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/noteOfResultFromAdhocProcess')}" />
      <br/>
      <p:spacer height="20"></p:spacer>
      <p:dataTable id="adhoc-task-history-table" value="#{taskTemplateBean.allAdhocHistories}" var="history">
        <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/timestamp')}">
          <h:outputText value="#{history.timestamp}" >
            <f:convertDateTime pattern="#{ivy.cms.co('/patterns/dateTimePattern')}" />
          </h:outputText>
        </p:column>
        <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/taskName')}">
          <h:outputText value="#{history.taskName}" />
        </p:column>
        <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/comment')}">
          <h:outputText value="#{history.content}" />
        </p:column>
     </p:dataTable>
      <f:facet name="footer">
        <h:form prependId="false">
          <h:panelGroup styleClass="Fs14 ui-dialog-buttonpane">
            <p:commandButton onclick="PF('adhoc-task-history-dialog').hide()" id="close-adhoc-dialog-button"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/close')}" type="button"
              styleClass="portal-cancel-button" />
          </h:panelGroup>
        </h:form>
      </f:facet>
    </p:dialog>
    
    <p:dialog id="chat-assignee-dialog" resizable="false"
        header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/chatAssigneeDialogHeader')}" width="600"
        rendered="#{chatRendererBean.isGroupChatRendered}" widgetVar="chat-assignee-dialog" appendTo="@(body)" modal="true"
        dynamic="true">
        <h:panelGroup id="chat-group-join-container" rendered="#{chatAssigneeBean.doesGroupChatExist()}">
          <h:outputText value="#{chatAssigneeBean.groupChatExistMessage}" />
          <br />
          <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/joinGroupQuestion')}" />
        </h:panelGroup>
        <f:facet name="footer">
          <h:form id="chat-group-join-form" rendered="#{chatAssigneeBean.doesGroupChatExist()}">
            <h:panelGroup styleClass="Fs14 ui-dialog-buttonpane">
              <p:commandButton id="chat-group-join-button" actionListener="#{chatAssigneeBean.joinGroupChat()}"
                value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/joinProcessChat')}" process="@this" update="@none" />
              <p:commandButton id="chat-group-cancel-button" type="button"
                value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
                styleClass="portal-cancel-button" onclick="PF('chat-assignee-dialog').hide()" />
            </h:panelGroup>
          </h:form>
        </f:facet>
        <h:form id="chat-assignee-selection-form" rendered="#{!chatAssigneeBean.doesGroupChatExist()}">
          <ui:include src="/layouts/includes/chatAssigneeSelection.xhtml">
            <ui:param name="chatBean" value="#{chatAssigneeBean}" />
            <ui:param name="createGroupChat" value="createGroupChat" />
          </ui:include>
        </h:form>
      </p:dialog>

      <ic:ch.ivy.addon.portalkit.feature.WarnOnClosingBrowserTab
        confirmMessage="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/browserTabClosingWarning')}" />

      <h:outputScript library="js" name="document-truncation.js" />
      <script type="text/javascript">
        function onTabShow() {
          var caseWidget = new CaseWidget("main-area-panel");
          var $selectedTab = $("#task-template-tabview").find(".ui-tabs-panel").filter(function() {return $(this).css('display') == 'block'});
          var isSelectCaseDetailsTab = $selectedTab.find('.js-case-default-widget-container').length != 0;

          if (isSelectCaseDetailsTab) {
            var caseListLargeScreen = new CaseListLargeScreenHandler();
            var caseListMediumScreen = new CaseListMediumScreenHandler();
            var caseListSmallScreen = new CaseListSmallScreenHandler();
            var responsiveToolkit = ResponsiveToolkit(caseListLargeScreen, caseListMediumScreen, caseListSmallScreen);

            Portal.init(responsiveToolkit, true);
            caseWidget.setupHeader();
            return;
          }

          var simpleLargeScreen = new SimpleLargeScreen();
          var simpleMediumScreen = new SimpleMediumScreen();
          var simpleSmallScreen = new SimpleSmallScreen();
          var responsiveToolkit = ResponsiveToolkit(simpleLargeScreen, simpleMediumScreen, simpleSmallScreen);
          Portal.init(responsiveToolkit, true);
        }

        function onStatusTabShow() {
          documentTruncation.truncate();
        }
      </script>
    </ui:define>
  </ui:composition>
</h:body>
</html>