<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:c="http://java.sun.com/jsp/jstl/core"
  xmlns:pe="http://primefaces.org/ui/extensions" xmlns:pm="http://primefaces.org/mobile">
<h:body>
  <ui:composition template="/layouts/BasicTemplate.xhtml">
    <ui:param name="isWorkingOnATask" value="true" />

    <ui:define name="head">
      <h:outputScript name="case-widget.js" library="js" />
    </ui:define>

    <ui:define name="simplePageContent">

      <c:set var="case" value="#{caseWidgetBean.findRemoteCaseByCaseId(caseId)}" scope="request" />
      <ui:insert name="breadCrumb" />

      <div>
        <div class="Fleft Wid100 Fs14 foreground-text-color MarTop10">
          <ui:insert name="taskName">
            <span class=" fa fa-check-square-o task-template-title-icon"></span>
            <h:outputText styleClass="task-template-title" id="title" title="#{task.name} (##{task.id})" value="#{task.name} (##{task.id})" />
          </ui:insert>
        </div>
        <div class="Fright Wid70 MarBot20" >
          <ui:insert name="process_chain_area">
            <ic:ch.ivy.addon.portalkit.singleapp.process.ProcessChain startMethod="start"
              actualStepIndex="#{actualStepIndex}" steps="#{steps}" 
              currentIndex="#{taskTemplateBean.getIndexOfCurrentStage(caseId)}" stages="#{taskTemplateBean.getStagesBaseOnCurrentStage(caseId)}" />
          </ui:insert>
        </div>
      </div>

      <div class="ClearBoth" />

      <ui:insert name="errorsZone" />
      <ui:insert name="infoZone" />
      <div class="task-template-content">

        <div class="task-template-tasks-command">
          <p:commandLink id="start-adhoc" rendered="#{empty isShowStartAdhocButton? taskTemplateBean.hasSelfService(): isShowStartAdhocButton}"
            title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/startAdHocTooltip')}" styleClass="case-action-link"
            oncomplete="PF('adhoc-task-reset-confirmation-dialog').show()" >
            <i class="fa fa-random fa-2x" />
          </p:commandLink>
          <p:spacer width="7"/>
          <c:set var="isSideStepDisabled" value="#{!taskTemplateBean.checkSideStepsEnabled(caseId)}" />
          <p:commandLink id="side-steps-menu"
            styleClass="case-action-link" global="false"
            disabled="#{isSideStepDisabled}">
            <span class="action-icon tmi-ellipsis-h side-step-icon" 
              title="#{isSideStepDisabled ? ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskInformation/noSideSteps') : ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/sideSteps')}" />
          </p:commandLink>
        </div>

      <p:overlayPanel id="side-steps-panel" widgetVar="side-steps-panel" for="side-steps-menu" my="left top" at="left bottom"
        appendToBody="true" styleClass="side-steps-container" dynamic="false" rendered="#{taskTemplateBean.checkSideStepsEnabled(caseId)}">
        <ui:repeat var="sidestep" value="#{taskTemplateBean.sideStepList}">
          <p:commandLink id="side-step-item" styleClass="side-step-item" value="#{sidestep.getName()}"
            global="false"
            actionListener="#{taskTemplateBean.setSelectedSideStep(sidestep)}"
            oncomplete="PF('sidestep-task-reset-confirmation-dialog').show()" />
        </ui:repeat>
      </p:overlayPanel>

        <p:tabView id="task-template-tabview" prependId="false" onTabShow="onTabShow()">
          <ui:insert name="dynamicTabs">
            <!-- You can add one or many tabs here -->
          </ui:insert>

          <p:tab id="request-tab"
            title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/CaseDetailsTemplate/requestTabTitle')}"
            rendered="#{showTaskFormTab == null ? true : showTaskFormTab}">
            <ui:insert name="taskForm">
              <!--                Task Form -->
            </ui:insert>
          </p:tab>
          <p:tab id="status-tab"
            title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/CaseDetailsTemplate/statusTabTitle')}"
            rendered="#{showCaseStatusInfoTab == null ? true : showCaseStatusInfoTab}">
            <ui:insert name="caseStatusTab">
              <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/CaseDetailsTemplate/noCaseId')}" rendered="#{caseWidgetBean.isHiddenCase(case)}" />
                <h:panelGroup id="case-details-panel" layout="block" rendered="#{!caseWidgetBean.isHiddenCase(case)}"
                  styleClass="js-case-default-widget-container case-default-widget-container js-simple-container js-for-search-result case-details">
                  <!-- HEADER -->
                  <h:panelGroup id="widget-column-header" class="widget-column-header js-case-widget-column-header">
                    <h:panelGroup styleClass="case-list-unsortable-header-cell case-list-name-desc-header-cell">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/NAME')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell TexAlCenter">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/caseId')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseList/creator')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell TexAlCenter">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/create')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell TexAlCenter">
                      <h:outputText value="#{ivy.cms.co('/Dialogs/ch/ivy/addon/portalkit/component/CaseWidget/Finished')}" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="case-list-unsortable-header-cell TexAlCenter">
                      <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/STATE')}" />
                    </h:panelGroup>
                  </h:panelGroup>

                  <ic:ch.ivy.addon.portalkit.component.CaseItem caseItem="#{case}" id="case-item"
                    initialActive="#{true}"
                    itemStyleClass="case-even-row"
                    alwaysShowDetails="true"
                    canDestroyCase="#{false}">

                    <!-- CASE HEADER -->
                    <f:facet name="caseHeader">
                      <ic:ch.ivy.addon.portalkit.component.CaseHeader id="case-header" case="#{case}" />
                    </f:facet>

                    <!-- CASE BODY -->
                    <f:facet name="caseBody">
                      <ic:ch.ivy.addon.portalkit.component.CaseItemGeneralInformation id="general-information" case="#{case}" />
                      <ic:ch.ivy.addon.portalkit.component.CaseItemRelatedTask id="related-tasks" case="#{case}" />
                      <ic:ch.ivy.addon.portalkit.component.CaseItemHistory id="history" case="#{case}" />
                      <ic:ch.ivy.addon.portalkit.component.CaseItemDocument id="document" case="#{case}" componentToUpdate="#{p:component('history')}" />
                      <ic:ch.ivy.addon.portalkit.component.CaseItemDescription id="description" case="#{case}" />
                      <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleContainer styleClass="hidden-lg">
                        <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleButton
                          icon="fa fa-share-alt js-related-task-column-responsive-button" displayedSelectors="['.js-related-task-column']"
                          hiddenSelectorsInLargeScreen="['.case-details .replaced']"
                          hiddenSelectorsInMediumScreen="['.case-details .replaced']"
                          hiddenSelectorsInSmallScreen="['.case-details .replaced']" />
                        <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleButton
                          icon="fa fa-align-left js-history-column-responsive-button" displayedSelectors="['.js-history-column']"
                          hiddenSelectorsInLargeScreen="['.case-details .replaced']"
                          hiddenSelectorsInMediumScreen="['.case-details .replaced']"
                          hiddenSelectorsInSmallScreen="['.case-details .replaced']" />
                        <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleButton
                          icon="fa fa-file js-document-column-responsive-button" displayedSelectors="['.js-document-column']"
                          hiddenSelectorsInLargeScreen="['.case-details .replaced']"
                          hiddenSelectorsInMediumScreen="['.case-details .replaced']"
                          hiddenSelectorsInSmallScreen="['.case-details .replaced']" />
                        <ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleButton
                          icon="fa fa-clipboard js-description-column-responsive-button" displayedSelectors="['.js-description-column']"
                          hiddenSelectorsInLargeScreen="['.case-details .replaced']"
                          hiddenSelectorsInMediumScreen="['.case-details .replaced']"
                          hiddenSelectorsInSmallScreen="['.case-details .replaced']" />
                      </ic:ch.ivy.addon.portalkit.component.ResponsivenessHandleContainer>
                    </f:facet>
                  </ic:ch.ivy.addon.portalkit.component.CaseItem>
                </h:panelGroup>
            </ui:insert>
          </p:tab>
        </p:tabView>
      </div>

      <div>
        <div class="Fleft">
          <ui:insert name="leftButtons">
            <!-- Left Buttons -->
          </ui:insert>
        </div>

        <div class="Fright">
          <ui:insert name="rightButtons">
            <!-- Right Buttons -->
          </ui:insert>
        </div>
      </div>

    <p:dialog id="adhoc-task-reset-confirmation-dialog" resizable="false"
      header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}"
      widgetVar="adhoc-task-reset-confirmation-dialog" appendTo="@(body)"
      modal="true" dynamic="true">
      <h:outputText escape="false" styleClass="ui-confirm-dialog-message"
        value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/goToAdhocWarning')}" />
      <f:facet name="footer">
        <h:form prependId="false">
          <h:panelGroup styleClass="Fs14 ui-dialog-buttonpane">
            <p:commandButton actionListener="#{taskTemplateBean.startAdhoc()}" process="@this" update="@none"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" />
            <p:commandButton onclick="PF('adhoc-task-reset-confirmation-dialog').hide()"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}" type="button"
              styleClass="portal-cancel-button" />
          </h:panelGroup>
        </h:form>
      </f:facet>
    </p:dialog>

    <p:dialog id="sidestep-task-reset-confirmation-dialog" resizable="false"
      header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}"
      widgetVar="sidestep-task-reset-confirmation-dialog" appendTo="@(body)"
      modal="true" dynamic="true">
      <h:outputText escape="false" styleClass="ui-confirm-dialog-message"
        value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/goToSidestepWarning')}" />
      <f:facet name="footer">
        <h:form prependId="false">
          <h:panelGroup styleClass="Fs14 ui-dialog-buttonpane">
            <p:commandButton actionListener="#{taskTemplateBean.startSideStep()}" process="@this" update="@none"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" />
            <p:commandButton onclick="PF('sidestep-task-reset-confirmation-dialog').hide()"
              value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}" type="button"
              styleClass="portal-cancel-button" />
          </h:panelGroup>
        </h:form>
      </f:facet>
    </p:dialog>

      <ic:ch.ivy.addon.portalkit.feature.WarnOnClosingBrowserTab
        confirmMessage="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/browserTabClosingWarning')}" />

      <script type="text/javascript">
        function onTabShow() {
          var caseWidget = new CaseWidget("main-area-panel");
          var $selectedTab = $("#task-template-tabview").find(".ui-tabs-panel").filter(function() {return $(this).css('display') == 'block'});
          var isSelectCaseDetailsTab = $selectedTab.find('.js-case-default-widget-container').length != 0;

          if (isSelectCaseDetailsTab) {
            var caseListLargeScreen = new CaseListLargeScreenHandler();
            var caseListMediumScreen = new CaseListMediumScreenHandler();
            var caseListSmallScreen = new CaseListSmallScreenHandler();
            var responsiveToolkit = ResponsiveToolkit(caseListLargeScreen, caseListMediumScreen, caseListSmallScreen);

            Portal.init(responsiveToolkit, true);
            caseWidget.setupHeader();
            return;
          }

          var simpleLargeScreen = new SimpleLargeScreen();
          var simpleMediumScreen = new SimpleMediumScreen();
          var simpleSmallScreen = new SimpleSmallScreen();
          var responsiveToolkit = ResponsiveToolkit(simpleLargeScreen, simpleMediumScreen, simpleSmallScreen);
          Portal.init(responsiveToolkit, true);
        }

        </script>
    </ui:define>
  </ui:composition>
</h:body>
</html>