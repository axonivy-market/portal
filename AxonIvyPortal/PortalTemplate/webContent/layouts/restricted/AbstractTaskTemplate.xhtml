<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:c="http://java.sun.com/jsp/jstl/core"
  xmlns:pe="http://primefaces.org/ui/extensions">
<h:body>
  <ui:composition template="/layouts/BasicTemplate.xhtml">
    <!-- THIS TEMPLATE IS ONLY USED BY PORTAL. DON'T USE IT -->
    <ui:param name="isWorkingOnATask" value="true" />
    <ui:param name="currentTask" value="#{not empty abstractTaskTemplateBean.task ? abstractTaskTemplateBean.task : task}" />
    <ui:define name="simplePageContent">
      <p:growl id="task-template-growl" />

      <div class="task-template-container ui-g-12 #{taskTemplateContainerStyleClass}">

        <c:set var="case" value="#{caseId ne null ? caseWidgetBean.findCase(caseId) : currentTask.getCase().getBusinessCase()}" />
        <c:set var="isSideStepDisabled" value="#{!abstractTaskTemplateBean.checkSideStepsEnabled(case)}" scope="request" />
        <ui:insert name="breadCrumb" />

        <h:panelGroup id="header-container" layout="block" styleClass="js-task-header-container task-header-container #{processChainDirection eq 'VERTICAL' ? '' : 'task-template-title-horizontal-container'}">
          <h:panelGroup id="task-template-title" layout="block" rendered="#{currentTask ne null}"
            styleClass="task-template-title #{processChainDirection eq 'VERTICAL' ? 'task-name-vertical-process-chain' : ''} #{processChainShape eq 'LINE' ? 'vertical-chain-shape-line' : ''}">
            <ui:insert name="taskName">
              <ui:fragment rendered="#{!isHideTaskName}">
                <span class=" fa fa-check-square-o task-template-title-icon" />
                <h:outputText id="title" title="#{currentTask.name}" value="#{currentTask.name}" styleClass="task-title" />
              </ui:fragment>
            </ui:insert>

            <h:panelGroup id="vertical-task-template-tasks-command" class="task-template-tasks-command" rendered="#{!(isHideCaseInfo and isHideTaskAction) and processChainDirection eq 'VERTICAL'}">
              <p:commandButton id="vertical-case-info" process="@none" update="case-info-dialog"
                title="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/caseInformation')}" icon="fa fa-info"
                oncomplete="PF('case-info-dialog').show()" rendered="#{!isHideCaseInfo}" />
              <p:spacer width="10" />
              <p:commandButton id="vertical-task-actions" type="button" rendered="#{!isHideTaskAction}"
                title="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/action')}" icon="ui-icon-menu" />
            </h:panelGroup>

            <h:form id="vertical-task-action-form" rendered="#{processChainDirection eq 'VERTICAL'}">
              <p:menu id="vertical-task-action-menu" overlay="true" trigger="vertical-task-actions" my="right top" at="right bottom"
                styleClass="action-steps-panel task-actions-menu">
                <p:menuitem id="show-adhoc-history" rendered="#{abstractTaskTemplateBean.hasAdhocTasks(currentTask)}"
                  icon="fa fa-history fa-2x" oncomplete="PF('adhoc-task-history-dialog').show()"
                  value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/adhocHistory')}"
                  title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/adhocHistoryTooltip')}" />

                <p:menuitem id="start-adhoc"
                  rendered="#{empty isShowStartAdhocButton? (abstractTaskTemplateBean.hasExpressAdhocWF() and currentTask.isPersistent()) : isShowStartAdhocButton}"
                  value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/startAdHoc')}"
                  title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/startAdHocTooltip')}"
                  icon="fa fa-random fa-2x" oncomplete="PF('adhoc-task-reset-confirmation-dialog').show()" />

                <p:separator
                  rendered="#{abstractTaskTemplateBean.hasAdhocTasks(currentTask) or (empty isShowStartAdhocButton? (abstractTaskTemplateBean.hasExpressAdhocWF() and currentTask.isPersistent()) : isShowStartAdhocButton)}" />

                <p:menuitem id="side-steps-menu" styleClass="empty-side-steps" global="false"
                  disabled="#{empty abstractTaskTemplateBean.sideStepList}" rendered="#{isSideStepDisabled}"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/noSideSteps')}" />

                <p:menuitem id="no-adhoc" styleClass="empty-side-steps" global="false"
                  rendered="#{!abstractTaskTemplateBean.hasExpressAdhocWF() or !currentTask.isPersistent()}" disabled="true" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDetails/noAdhoc')}" />

                <c:forEach var="sidestep" items="#{abstractTaskTemplateBean.sideStepList}" varStatus="taskStatus">
                  <p:menuitem id="side-step-item-#{taskStatus.index}" styleClass="side-step-item"
                    value="#{sidestep.getName()}" global="false"
                    actionListener="#{abstractTaskTemplateBean.setSelectedSideStep(sidestep)}"
                    oncomplete="PF('sidestep-task-reset-confirmation-dialog').show()" />
                </c:forEach>
              </p:menu>
            </h:form>
          </h:panelGroup>

          <h:panelGroup layout="block"
            styleClass="process-chain-container #{processChainDirection eq 'VERTICAL' ? 'vertical-process-chain-container' : 'horizontal-process-chain-container'} #{processChainShape eq 'LINE' ? 'vertical-chain-shape-line' : ''}">
            <ui:insert name="processChainArea">
              <ic:ch.ivy.addon.portalkit.singleapp.process.ProcessChain id="process-chain-component"
                startMethod="start" componentId="process-chain-component-id"
                shape="#{processChainShape eq 'LINE' ? 'LINE' : 'CIRCLE'}"
                direction="#{processChainDirection eq 'VERTICAL' ? 'VERTICAL' : 'HORIZONTAL'}" 
                isShowAllSteps="#{isShowAllSteps}"
                actualStepIndex="#{actualStepIndex}" steps="#{steps}"
                currentIndex="#{abstractTaskTemplateBean.getIndexOfCurrentStage(case)}"
                stages="#{abstractTaskTemplateBean.getStagesBaseOnCurrentStage(case, steps)}" />
            </ui:insert>
          </h:panelGroup>

          <h:panelGroup id="horizontal-task-template-tasks-command" styleClass="task-template-tasks-command" rendered="#{!(isHideCaseInfo and isHideTaskAction) and processChainDirection ne 'VERTICAL'}">
            <p:commandButton id="horizontal-case-info" process="@none" update="case-info-dialog"
              title="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/caseInformation')}" icon="fa fa-info"
              oncomplete="PF('case-info-dialog').show()" rendered="#{!isHideCaseInfo}" />
            <p:spacer width="10" />
            <p:commandButton id="horizontal-task-actions" type="button" rendered="#{!isHideTaskAction}" 
              title="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/action')}" icon="ui-icon-menu" />

            <h:form id="horizontal-task-action-form">
              <p:menu id="horizontal-task-action-menu" overlay="true" trigger="horizontal-task-actions" my="right top" at="right bottom" 
                styleClass="action-steps-panel task-actions-menu" rendered="#{!isHideTaskAction}">
                <p:menuitem id="show-adhoc-history" rendered="#{abstractTaskTemplateBean.hasAdhocTasks(currentTask)}"
                  icon="fa fa-history fa-2x" oncomplete="PF('adhoc-task-history-dialog').show()"
                  value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/adhocHistory')}"
                  title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/adhocHistoryTooltip')}" />
                <p:menuitem id="start-adhoc"
                  rendered="#{empty isShowStartAdhocButton? (abstractTaskTemplateBean.hasExpressAdhocWF() and currentTask.isPersistent()) : isShowStartAdhocButton}"
                  value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/startAdHoc')}"
                  title="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/startAdHocTooltip')}"
                  icon="fa fa-random fa-2x" oncomplete="PF('adhoc-task-reset-confirmation-dialog').show()" />

                <p:menuitem id="chat-group" icon="fa fa-comments fa-2x" action="#{chatAssigneeBean.createGroupChatForConfiguredRoleList(currentTask)}"
                  rendered="#{chatRendererBean.isGroupChatRendered and !(currentTask.state eq 'CREATED') and !chatRendererBean.isExpressCreationTask()}"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/createProcessChat')}" update="chat-assignee-dialog" />

                <p:separator
                    rendered="#{abstractTaskTemplateBean.hasAdhocTasks(currentTask) or (empty isShowStartAdhocButton? (abstractTaskTemplateBean.hasExpressAdhocWF() and currentTask.isPersistent()) : isShowStartAdhocButton)}" />

                <p:menuitem id="side-steps-menu" styleClass="empty-side-steps" global="false"
                  disabled="#{empty abstractTaskTemplateBean.sideStepList}" rendered="#{isSideStepDisabled}"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/caseDetails/noSideSteps')}" />

                <p:menuitem id="no-adhoc" styleClass="empty-side-steps" global="false"
                  rendered="#{!abstractTaskTemplateBean.hasExpressAdhocWF() or !currentTask.isPersistent()}" disabled="true" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskDetails/noAdhoc')}" />

                <c:forEach var="sidestep" items="#{abstractTaskTemplateBean.sideStepList}" varStatus="taskStatus">
                  <p:menuitem id="side-step-item-#{taskStatus.index}" styleClass="side-step-item"
                    value="#{sidestep.getName()}" global="false"
                    actionListener="#{abstractTaskTemplateBean.setSelectedSideStep(sidestep)}"
                    oncomplete="PF('sidestep-task-reset-confirmation-dialog').show()" />
                </c:forEach>
              </p:menu>
            </h:form>
          </h:panelGroup>
        </h:panelGroup>

        <h:panelGroup id="content-container" layout="block" 
          styleClass="task-template-content #{contentContainerStyleClass} #{processChainDirection eq 'VERTICAL' ? 'vertical-process-chain' : ''} #{processChainShape eq 'LINE' ? 'vertical-chain-shape-line' : ''}">
          <ui:insert name="content">
            <ui:insert name="taskForm" /> <!-- DEPRECATED -->
          </ui:insert>
        </h:panelGroup>

        <p:dialog id="case-info-dialog" resizable="false" fitViewport="true"
          header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/caseInformation')}" width="95vw" closeOnEscape="true" draggable="false" responsive="true"
          widgetVar="case-info-dialog" appendTo="@(body)" modal="true" dynamic="true"
          styleClass="case-info-dialog">
          <ui:insert name="caseDetails">
            <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/CaseDetailsTemplate/noCaseId')}"
              rendered="#{caseWidgetBean.isHiddenCase(case)}" />
            <h:panelGroup id="case-details-panel" layout="block" rendered="#{!caseWidgetBean.isHiddenCase(case)}"
              styleClass="case-default-widget-container case-details">
              <div class="ui-g">
                <div class="ui-g-12 u-padding-0">
                  <ic:ch.ivy.addon.portalkit.component.CaseItemDetails case="#{case}" showItemBackButton="false" isWorkingOnTask="true"/>
                </div>
              </div>
            </h:panelGroup>
          </ui:insert>
        </p:dialog>

        <p:dialog id="chat-assignee-dialog" resizable="false"
          header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/chatAssigneeDialogHeader')}" styleClass="chat-assignee-dialog"
          rendered="#{chatRendererBean.isGroupChatRendered}" widgetVar="chat-assignee-dialog" appendTo="@(body)" modal="true"
          dynamic="true" responsive="true">
          <h:panelGroup id="chat-group-join-container" rendered="#{chatAssigneeBean.doesGroupChatExist()}">
            <h:outputText value="#{chatAssigneeBean.groupChatExistMessage}" />
            <br />
            <h:outputText value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/joinGroupQuestion')}" />
          </h:panelGroup>
          <f:facet name="footer">
            <h:form id="chat-group-join-form" rendered="#{chatAssigneeBean.doesGroupChatExist()}">
              <h:panelGroup styleClass="Fs14 ui-dialog-buttonpane">
                <p:commandButton id="chat-group-join-button" actionListener="#{chatAssigneeBean.joinGroupChat()}"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/chat/joinProcessChat')}" process="@this" update="@none" />
                <p:commandButton id="chat-group-cancel-button" type="button"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
                  styleClass="portal-cancel-button" onclick="PF('chat-assignee-dialog').hide()" />
              </h:panelGroup>
            </h:form>
          </f:facet>
          <h:form id="chat-assignee-selection-form" rendered="#{!chatAssigneeBean.doesGroupChatExist()}">
            <ui:include src="/layouts/includes/chatAssigneeSelection.xhtml">
              <ui:param name="chatBean" value="#{chatAssigneeBean}" />
              <ui:param name="createGroupChat" value="createGroupChat" />
            </ui:include>
          </h:form>
        </p:dialog>

        <p:dialog id="adhoc-task-reset-confirmation-dialog" resizable="false"
          header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}"
          widgetVar="adhoc-task-reset-confirmation-dialog" appendTo="@(body)" modal="true" dynamic="true"
          responsive="true">
          <h:outputText escape="false" styleClass="ui-confirm-dialog-message" id="adhoc-creation-message"
            value="#{abstractTaskTemplateBean.getAdhocCreationMessage(currentTask.id)}" />
          <f:facet name="footer">
            <h:form prependId="false">
              <h:panelGroup styleClass="ui-dialog-buttonpane">
                <p:commandButton actionListener="#{abstractTaskTemplateBean.startAdhoc(currentTask.id)}" process="@this" update="@none"
                  id="start-adhoc-ok-button" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" />
                <p:commandButton onclick="PF('adhoc-task-reset-confirmation-dialog').hide()"
                  id="start-adhoc-cancel-button" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
                  type="button" styleClass="portal-cancel-button" />
              </h:panelGroup>
            </h:form>
          </f:facet>
        </p:dialog>

        <p:dialog id="sidestep-task-reset-confirmation-dialog" resizable="false"
          header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/confirmation')}"
          widgetVar="sidestep-task-reset-confirmation-dialog" appendTo="@(body)" modal="true" dynamic="true"
          responsive="true">
          <h:outputText escape="false" styleClass="ui-confirm-dialog-message"
            value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/goToSidestepWarning')}" />
          <f:facet name="footer">
            <h:form prependId="false">
              <h:panelGroup styleClass="ui-dialog-buttonpane">
                <p:commandButton id="side-step-start-ok" actionListener="#{abstractTaskTemplateBean.startSideStep(currentTask)}" process="@this" update="@none"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/ok')}" />
                <p:commandButton id="side-step-start-cancel" onclick="PF('sidestep-task-reset-confirmation-dialog').hide()"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}" type="button"
                  styleClass="portal-cancel-button" />
              </h:panelGroup>
            </h:form>
          </f:facet>
        </p:dialog>

        <p:dialog id="adhoc-task-history-dialog" resizable="false"
          styleClass="adhoc-task-history-dialog"
          header="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/resultFromAdhocProcess')}"
          widgetVar="adhoc-task-history-dialog" appendTo="@(body)" modal="true" dynamic="true"
          responsive="true">
          <p:ajax event="close" listener="#{abstractTaskTemplateBean.onCloseAdhocTaskHistoryDialog(currentTask)}" />
          <h:outputText
            value="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/noteOfResultFromAdhocProcess')}" />
          <br />
          <p:spacer height="20"></p:spacer>
          <p:dataTable id="adhoc-task-history-table" value="#{abstractTaskTemplateBean.getAllAdhocHistories(currentTask)}" var="history">
            <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/author')}">
              <h:outputText value="#{abstractTaskTemplateBean.getUserByUsername(history.authorUsername)}" />
            </p:column>
            <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/timestamp')}">
              <h:outputText value="#{history.timestamp}">
                <f:convertDateTime pattern="#{ivy.cms.co('/patterns/dateTimePattern')}" />
              </h:outputText>
            </p:column>
            <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/taskName')}">
              <h:outputText value="#{history.taskName}" />
            </p:column>
            <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/comment')}">
              <h:outputText value="#{history.content}" />
            </p:column>
          </p:dataTable>
          <f:facet name="footer">
            <h:form prependId="false">
              <h:panelGroup styleClass="ui-dialog-buttonpane">
                <p:commandButton onclick="PF('adhoc-task-history-dialog').hide()" id="close-adhoc-dialog-button"
                  value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/close')}" type="button"
                  styleClass="portal-cancel-button" />
              </h:panelGroup>
            </h:form>
          </f:facet>
        </p:dialog>

        <p:remoteCommand name="keepSession" global="false" process="@this" update="@this"
          oncomplete="PortalSessionWarning.resetCounterAndTimeout(); PortalSessionWarning.resetInteractedTaskTemplate();" />

        <ic:ch.ivy.addon.portalkit.feature.WarnOnClosingBrowserTab
          confirmMessage="#{ivy.cms.co('/ch.ivy.addon.portal.generic/OpenTaskTemplate/browserTabClosingWarning')}" />
      </div>

      <ui:insert name="javascript" />
    </ui:define>
  </ui:composition>
</h:body>
</html>