<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:p="http://primefaces.org/ui" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
  xmlns:ic="http://ivyteam.ch/jsf/component">
<h:head>
  <f:facet name="first">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
  </f:facet>
  
  <f:attribute name="primefaces.THEME" value="serenity-ivy" />
  
  <title><ui:insert name="pageTitle">Axon.Ivy Portal</ui:insert></title>
  <ui:fragment rendered="#{resource['ivy-webcontent:layouts/images/favicon.png'] != null}">
    <link rel="shortcut icon" href="#{resource['ivy-webcontent:layouts/images/favicon.png']}" type="image/png" />
  </ui:fragment>

  <h:outputStylesheet library="css" name="base.css" />
  <h:outputStylesheet library="css" name="state.css" />
  <h:outputStylesheet library="css" name="layout.css" />
  <h:outputStylesheet library="css" name="utility.css" />

  <h:outputStylesheet name="css/nanoscroller.css" library="serenity-layout" />
  <h:outputStylesheet name="css/ripple.css" library="serenity-layout" />
  <h:outputStylesheet name="css/layout-lime.css" library="serenity-layout" />

  <h:outputStylesheet library="css" name="template.css" />
  <h:outputStylesheet library="css" name="module.css" />

  <h:outputScript name="js/nanoscroller.js" library="serenity-layout" />
<!--   <h:outputScript name="js/layout.js" library="serenity-layout" /> -->
  <h:outputScript name="js/ripple.js" library="serenity-layout" />

  <h:outputScript name="viewport.js" library="js"  />
  <h:outputScript name="responsive-toolkit.js" library="js" />
  <h:outputScript name="main.js" library="js" />
  <h:outputScript name="portal-components.js" library="js" />
  <h:outputScript name="portal.js" library="js" />

  <script src="#{resource['ivy-webcontent:layouts/js/cookie-helper.js']}" />
  <script src="#{resource['ivy-webcontent:layouts/js/primefaces-calendar-en-us.js']}" />
  <script src="#{resource['ivy-webcontent:resources/serenity-layout/js/layout.js']}" />
  <ui:insert name="head" />
</h:head>

<h:body>
  <f:facet name="last">
    <h:outputStylesheet library="primefaces-serenity-ivy" name="theme.css" />
  </f:facet>
  
  <c:set var="isNotRequiredLogin" value="#{isNotRequiredLogin == null ? false : isNotRequiredLogin}" />
  <c:choose>
    <c:when test="#{ivy.wf.securityContext.currentSession.sessionUserUnknown and !isNotRequiredLogin}">
      <ui:insert name="login">
        <ic:ch.ivy.addon.portalkit.singleapp.general.Login id="login" />
      </ui:insert>
    </c:when>
    <c:otherwise>
      <!-- CALL THIS METHOD TO INITIALIZE THE APPLICATION BEAN TO SET HIDE PROPERTY FOR ROLE -->
      <f:event type="preRenderView" listener="#{dataInitializationBean.run()}" />

      <f:event type="preRenderView"
        listener="#{facesContext.externalContext.response.setHeader('Cache-Control', 'no-cache, no-store')}" />

      <div class="layout-wrapper #{guestPreferences.orientationRTL ? 'layout-rtl' : ''}">
        <ui:fragment rendered="#{deviceBean.mobile}">
          <div class="topbar-container #{currentPage}">
            <ui:include src="/layouts/includes/mobileTopbar.xhtml" />
          </div>
        </ui:fragment>

        <ui:fragment rendered="#{not deviceBean.mobile}">
           <div class="layout-sidebar #{guestPreferences.darkMenu ? 'layout-sidebar-dark' : ''} #{currentPage} left-sidebar-color js-left-sidebar" id="left-menu">
              <c:choose>
                <c:when test="#{isNotRequiredLogin}">
                  <ic:ch.ivy.addon.portal.generic.ApplicationSelectionMenu startMethod="StartNotRequiredLogin" id="user-menu-without-login" />
                </c:when>
                <c:otherwise>
                  <ic:ch.ivy.addon.portal.generic.ApplicationSelectionMenu id="user-menu-required-login" isWorkingOnATask="#{isWorkingOnATask}" />
                </c:otherwise>
              </c:choose>
          </div>
        </ui:fragment>

        <div class="layout-main">
          <ui:fragment rendered="#{not deviceBean.mobile}">
            <div class="layout-topbar">
              <a class="menu-btn">
                <i class="material-icons fa fa-bars left-sidebar-menu-icon left-sidebar-menu-icon-font-size" />
              </a>
              <div class="layout-topbar-menu-wrapper">
                <ui:include src="/layouts/includes/topbar.xhtml">
                  <ui:param name="isWorkingOnATask" value="#{isWorkingOnATask}" />
                  <ui:param name="isNotRequiredLogin" value="#{isNotRequiredLogin}" />
                  <ui:param name="hasMainMenu" value="#{empty hasMainMenu ? true : hasMainMenu}" />
                  <ui:param name="showGlobalSearch" value="#{empty portalValidationBean.errorMessages}" />
                  <ui:param name="enablesChat" value="#{enablesChat}" />
                </ui:include>
                <div class="color-header">
                  <div class="first-header-bar" />
                  <div class="second-header-bar" />
                  <div class="third-header-bar" />
                </div>
              </div>
            </div>
          </ui:fragment>
          <ui:fragment rendered="#{empty portalValidationBean.errorMessages}">
            <div class="layout-content container #{showMainArea ne false or deviceBean.mobile ? '' : 'u-invisibility'} #{deviceBean.mobile ? 'mobile-container' : ''}" id="main-area-panel">
              <h:panelGroup layout="block" rendered="#{userMenuBean.isAnnouncementActivated() and announcementInvisible ne 'true'}" styleClass="announcement-message-container #{announcementContainerStyleClass}">
                <h:panelGroup layout="block" styleClass="js-announcement-message announcement-message announcement-message-customizable">
                  <h:outputText value="#{userMenuBean.getAnnouncement()}" />
                </h:panelGroup>
              </h:panelGroup>
              <ui:insert name="pageContent">
                <div class="simple-container #{simpleContainerClass}">
                  <div class="js-simple-main-col #{simpleMainColClass}">
                    <ui:insert name="simplePageContent" />
                  </div>
                </div>
              </ui:insert>
            </div>
          </ui:fragment>
          <ui:fragment rendered="#{not empty portalValidationBean.errorMessages}">
            <div class="error-container">
              <ui:repeat var="error" value="#{portalValidationBean.errorMessages}">
                <div class="message">
                  <div class="message-container">#{error}</div>
                </div>
              </ui:repeat>
            </div>
          </ui:fragment>
          <ui:fragment rendered="#{not deviceBean.mobile and empty portalValidationBean.errorMessages}">
            <div class="layout-main-mask" />
          </ui:fragment>
        </div>

        <ic:ch.ivy.addon.portalkit.component.WarningBeforeLostSession id="warning-before-lost-session"
          clientSideTimeOut="#{userMenuBean.clientSideTimeout}" />
      </div>
    </c:otherwise>
  </c:choose>

  <ui:insert name="exception">
    <ui:include src="/layouts/includes/portalException.xhtml" />
  </ui:insert>

  <ic:ch.ivy.addon.portalkit.component.GlobalAjaxStatus id="ajax-indicator" />

  <ui:insert name="css" />
  
  <ui:fragment rendered="#{not deviceBean.mobile}">
    <ui:insert name="footer">
      <script type="text/javascript">
        $(function() {
          //restores menu states stores in cookies
          PF('main-menu').restoreMenuState();
          var simpleScreen = new SimpleScreen();
          var responsiveToolkit = ResponsiveToolkit(simpleScreen, simpleScreen, simpleScreen);
          Portal.init(responsiveToolkit);
        });
      </script>
    </ui:insert>
  </ui:fragment>
  
  <ui:fragment rendered="#{deviceBean.mobile and !ivy.wf.securityContext.currentSession.sessionUserUnknown}">
    <div class="mobile-footer ui-g-12 u-padding-0">
      <p:commandLink actionListener="#{userMenuBean.switchDesktopOrMobileVersion(false)}">
        #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/switchToDesktopVersion')}
      </p:commandLink>
    </div>
  </ui:fragment>

  <ic:ch.ivy.addon.portalkit.multiapp.general.ErrorDisplayDialog id="application-error-dialog-component" />
  
  <p:growl id="portal-global-growl" widgetVar="portal-global-growl" />
</h:body>
</html>