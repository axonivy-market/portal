<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core" xmlns:jsf="http://xmlns.jcp.org/jsf">
<h:body>
  <ui:composition template="/layouts/BasicTemplate.xhtml">
    <ui:define name="title">#{ivy.cms.co('/Dialogs/ExpressManagement/expressManagement')}</ui:define>
    <ui:define name="pageContent">

      <h:form id="express-helper-form">
        <div class="ui-g">
          <div class="ui-g-12">
            <p:commandButton id="import-express-btn" value="#{ivy.cms.co('/Dialogs/ExpressManagement/importExpress')}" partialSubmit="true" oncomplete="PF('import-express-dialog').show()"
              update="#{p:component('import-express-dialog')}" />
            <p:spacer width="10px" />
            <p:commandButton id="export-express-btn" value="#{ivy.cms.co('/Dialogs/ExpressManagement/exportExpress')}" process="express-workflow-summary-table" partialSubmit="true"
              oncomplete="PF('export-express-dialog').show()" update="#{p:component('export-express-dialog')}" disabled="#{empty data.selectedExpresses}"/>
          </div>

          <div class="ui-g-12">
            <p:dataTable id="express-workflow-summary-table" var="express" value="#{expressManagementBean.expressProcessLazyDataModel}" 
              selection="#{data.selectedExpresses}"
              styleClass="express-workflow-summary-table" rowKey="#{express.processName}"
              rows="20" paginator="true" paginatorPosition="top"
              paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
              lazy="true">
              
              <p:ajax event="toggleSelect" update="#{p:component('export-express-btn')}" />
              <p:ajax event="rowSelectCheckbox" update="#{p:component('export-express-btn')}" global="false" />
              <p:ajax event="rowUnselectCheckbox" update="#{p:component('export-express-btn')}" global="false" />

              <p:column selectionMode="multiple" styleClass="express-selection-column" />

              <p:column headerText="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/processwidget/processName')}">
                <h:outputText value="#{express.processName}" />
              </p:column>

              <p:column headerText="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/Processdescription')}">
                <h:outputText value="#{express.processDescription}" />
              </p:column>

              <p:column headerText="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/Processtype')}" width="200" styleClass="u-hidden-md-down">
                <h:outputText value="#{expressManagementBean.getProcessTypeDescription(express.processType)}" />
              </p:column>

              <p:column headerText="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/ProcessOwner')}" width="200" styleClass="u-hidden-md-down">
                <h:outputText value="#{expressHelperBean.getUserDisplayName(express.processOwner)}" />
              </p:column>
            </p:dataTable>
          </div>
        </div>
      </h:form>

      <p:dialog id="export-express-dialog" widgetVar="export-express-dialog" modal="true" draggable="false" closable="false" resizable="false"
        header="#{ivy.cms.co('/Dialogs/ExpressManagement/exportExpressProcessTitle')}" appendTo="@(body)" width="40vw" styleClass="export-express-dialog"
        fitViewport="true" position="center center" onShow="PF('export-express-dialog').initPosition();" closeOnEscape="false">
        <h:form id="express-export-form">
          <h:panelGroup layout="block" class="ui-g">
            <div class="ui-g-12">
              <h4 class="import-header-title">#{ivy.cms.co('/Dialogs/ExpressManagement/importHeaderTitle')} #{data.selectedExpresses.size()} #{ivy.cms.co('/Dialogs/ExpressManagement/processCount')}</h4>
            </div>

            <div id="express-helper-loading-container" class="ui-g-12 express-helper-loading-container">
              <div class="express-helper-loading">
                <i class="fa fa-circle-o-notch fa-spin ajax-loader MarRight10" /> <span>#{ivy.cms.co('/Dialogs/ExpressManagement/waitingMessage')}</span>
              </div>
            </div>

            <div jsf:id="express-export-selected" class="ui-g-12 express-export-selected">
              <ui:repeat var="process" value="#{data.selectedExpresses}">
                <li class="MarTop5"><span>#{process.processName} - #{process.processType}</span></li>
              </ui:repeat>
            </div>
          </h:panelGroup>
        </h:form>

        <f:facet name="footer">
          <h:form id="export-express-dowload-form" styleClass="ui-g">
            <div class="ui-g-12">
              <p:commandButton id="export-express-dowload" rendered="#{not empty data.selectedExpresses}"
                value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/documentFiles/download')}" icon="fa fa-download"
                ajax="false" onclick="PrimeFaces.monitorDownload(showLoadingIndicator, hideLoadingIndicator); PF('export-express-dialog').initPosition();">
                <p:fileDownload value="#{logic.exportExpress()}" />
              </p:commandButton>
              <p:spacer width="10px" />
              <p:commandButton value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/close')}" onclick="PF('export-express-dialog').hide()" global="false" />
            </div>
          </h:form>
        </f:facet>
      </p:dialog>

      <p:dialog id="import-express-dialog" modal="true" widgetVar="import-express-dialog" draggable="false" closable="false" resizable="false"
        onShow="PF('import-express-dialog').initPosition();cleanExportMessage();" position="center center" appendTo="@(body)"
        header="#{ivy.cms.co('/Dialogs/ExpressManagement/importExpressProcessTitle')}" width="40vw" fitViewport="true" closeOnEscape="false" styleClass="import-express-dialog">
        <h:form id="import-express-form">
          <h:panelGroup id="express-process-upload-panel" layout="block" styleClass="ui-g">
            <div class="ui-g-12">
              <h4 class="import-header-title">#{ivy.cms.co('/Dialogs/ExpressManagement/importDialogHeaderTitle')}</h4>
            </div>
            
            <div class="ui-g-12">
              <p:messages id="import-express-dialog-message" />
            </div>

            <div class="ui-g-12">
              <p:fileUpload id="express-process-upload" mode="advanced" chooseIcon="fa fa-upload" dragDropSupport="true"
                update="import-express-form impress-export-output import-express-dialog-message" 
                label="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/select')}" uploadLabel="#{ivy.cms.co('/Dialogs/ExpressManagement/deployButton')}" uploadIcon="fa fa-cogs" cancelLabel="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}"
                fileUploadListener="#{logic.importExpress}" value="#{data.importExpressFile}" fileLimit="1" 
                onstart="showLoadingIndicator(); cleanExportMessage(); PF('close-import-express').disable();"
                oncomplete="hideLoadingIndicator(); PF('import-express-dialog').initPosition(); refreshExpressTable(); PF('close-import-express').enable();"
                styleClass="express-process-upload">
              </p:fileUpload>
            </div>

            <div id="express-helper-loading-container" class="ui-g-12 express-helper-loading-container">
              <div class="express-helper-loading">
                <i class="fa fa-circle-o-notch fa-spin ajax-loader MarRight10" /> <span>#{ivy.cms.co('/Dialogs/ExpressManagement/deployMessage')}</span>
              </div>
            </div>

            <div jsf:id="impress-export-output" class="ui-g-12">
              <div jsf:id="import-status" class="import-status #{data.importStatus}">#{data.importStatus}</div>

              <pre class="express-import-result">#{data.importOutput}</pre>
            </div>
          </h:panelGroup>
        </h:form>

        <f:facet name="footer">
          <p:commandButton id="close-import-express" widgetVar="close-import-express" value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/close')}" onclick="PF('import-express-dialog').hide()"
            global="false" />
        </f:facet>
      </p:dialog>

      <h:form>
        <p:remoteCommand name="refreshExpressTable" immediate="true" partialSubmit="true" process="@this"
          update="#{p:component('express-workflow-summary-table')}" global="false" />
      </h:form>

      <script type="text/javascript">
         function showLoadingIndicator() {
           $('.express-helper-loading-container').show();
         }

         function hideLoadingIndicator() {
           $('.express-helper-loading-container').hide();
         }
         
         function cleanExportMessage() {
           $('[id$=":impress-export-output"]').empty();
         }
       </script>
    </ui:define>

    <ui:define name="css">
      <h:outputStylesheet library="css" name="portal_express.css" />
    </ui:define>
  </ui:composition>
</h:body>
</html>