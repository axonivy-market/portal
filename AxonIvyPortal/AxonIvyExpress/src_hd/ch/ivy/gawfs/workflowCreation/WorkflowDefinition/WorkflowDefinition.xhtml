
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions" xmlns:pm="http://primefaces.org/mobile">
<h:body>
  <ui:composition template="/layouts/TaskTemplate.xhtml">
    <ui:param name="caseId" value="#{ivy.case.id}" />
    <ui:param name="task" value="#{ivy.task}" />
    <ui:param name="steps" value="#{data.data.steps}" />
    <ui:param name="actualStepIndex" value="1" />
    <ui:param name="isShowStartAdhocButton" value="false" />
    <ui:param name="isNotRequiredLogin" value="false" />

    <ui:define name="title">#{ivy.cms.co('/Dialogs/workflowCreation/FormDefinition/PageTitle')} #{ivy.case.name}</ui:define>
    <ui:define name="errorsZone">
      <p:messages id="error-messages" showDetail="false" closable="true" />
    </ui:define>
    <ui:define name="taskForm">
      <h:form id="form">
        <br />
        <p:fieldset id="process-setting-fieldset"
          legend="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/Processdetails')}" toggleable="true">
          <h:panelGroup id="process-setting-grid" styleClass="process-property-container">
            <!-- PROCESS TYPE -->
            <div class="ui-fluid">
              <div class="ui-g alignLabelTop">
                <div class="ui-g-12 ui-md-12 ui-lg-2">
                  <p:outputLabel value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/Processtype')}:"
                    for="process-type" />
                </div>
                <div class="ui-g-12 ui-md-6 ui-lg-4">

                  <p:selectOneRadio id="process-type" layout="grid" columns="1"
                    disabled="#{not empty data.data.processID or data.data.isAdhocProcess}"
                    value="#{data.data.processType}" required="true"
                    requiredMessage="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/Processtype')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}">
                    <f:selectItems value="#{workflowDefinitionBean.processTypes}" var="processType"
                      itemValue="#{processType}" itemLabel="#{processType.label}" />
                    <p:ajax event="change" update="process-type" global="false" />
                  </p:selectOneRadio>

                </div>


                <!-- UI SETTING -->

                <div class="ui-g-12 ui-md-12 ui-lg-2">
                  <p:outputLabel
                    value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UserInterface/UserInterface')}:"
                    for="user-interface" />
                </div>
                <div class="ui-g-12 ui-md-12 ui-lg-3">
                  <p:selectOneRadio id="user-interface" styleClass="radio-group" value="#{data.data.isUseDefaultUI}"
                    required="true" layout="custom" disabled="#{data.data.isAdhocProcess}"
                    requiredMessage="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UserInterface/UserInterface')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}">
                    <f:selectItem itemValue="false" />
                    <f:selectItem itemValue="true" />
                    <p:ajax onstart="PF('deleteAllDefinedTasksWarning').show();" />
                  </p:selectOneRadio>
                  <p:panelGrid id="user-interface-panel" styleClass="user-interface-panel" columns="1">
                    <p:row>
                      <p:radioButton id="own-option" for="user-interface" itemIndex="0" />
                      <h:outputLabel id="own-option-label" for="own-option"
                        value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UserInterface/CreateOwn')}" />
                    </p:row>

                    <p:row>
                      <p:radioButton id="default-option" for="user-interface" itemIndex="1" />
                      <h:panelGroup layout="block">
                        <h:outputLabel id="default-option-label" for="default-option"
                          value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UserInterface/UseDefault')}" />
                        <p:commandLink id="show-default-ui-icon" styleClass="show-default-ui-icon fa fa-info-circle"
                          oncomplete="PF('default-template-dialog').show();" />
                      </h:panelGroup>
                    </p:row>
                  </p:panelGrid>
                </div>
                <div class="ui-g-12 ui-md-12 ui-lg-1"></div>
              </div>

              <!-- PROCESS NAME -->
              <div class="ui-g">
                <div class="ui-g-12 ui-md-12 ui-lg-2">
                  <p:outputLabel value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/processwidget/processName')}:"
                    for="process-name" />
                </div>
                <div class="ui-g-12 ui-md-12 ui-lg-10">
                  <p:inputText id="process-name" value="#{data.data.processName}" required="true" maxlength="50"
                    disabled="#{data.data.isAdhocProcess}" styleClass="express-process-name"
                    requiredMessage="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/processwidget/processName')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}">
                    <p:ajax event="blur" partialSubmit="true" process="@this" global="false" immediate="true" />
                  </p:inputText>
                </div>
              </div>

              <!-- PROCESS DESCRIPTION -->
              <div class="ui-g">
                <div class="ui-g-12 ui-md-12 ui-lg-2">
                  <p:outputLabel
                    value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/Processdescription')}:"
                    for="processdescription" />
                </div>
                <div class="ui-g-12 ui-md-12 ui-lg-10">
                  <p:inputTextarea id="processdescription" value="#{data.data.processDescription}" maxlength="60"
                    requiredMessage="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/Processdescription')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}">
                    <p:ajax event="blur" partialSubmit="true" process="@this" global="false" />
                  </p:inputTextarea>
                </div>

              </div>

            </div>
          </h:panelGroup>
        </p:fieldset>

        <br />
        <ui:repeat id="defined-tasks-list" value="#{data.data.definedTasks}" var="gtask" varStatus="status">
          <p:fieldset id="process-flow-field" toggleable="true" styleClass="process-flow-field"
            legend="#{ivy.cms.co('/Dialogs/workflowCreation/processStep')} #{gtask.position}">

            <!-- FOR SELF CREATE TEMPLATE -->
            <p:panel id="task-panel-container" styleClass="task-panel-container">
              <h:panelGroup id="dynamic-task-panel-grid" styleClass="dynamic-task-panel-grid"
                rendered="#{!data.data.isUseDefaultUI}">
                <div class="ui-fluid">

                  <div class="ui-g">

                    <!-- TASK TYPE -->
                    <div class="ui-g-12 ui-md-12 ui-lg-2">
                      <p:outputLabel id="task-type-label" for="task-type"
                        value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/TaskType')}:" />
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-3">
                      <p:selectOneMenu id="task-type" required="true" value="#{gtask.taskType}"
                        disabled="#{data.data.isUseDefaultUI}"
                        requiredMessage="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/TaskType')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}">
                        <f:selectItems
                          value="#{status.index == 0 ? workflowDefinitionBean.taskTypesForFirstWorkflowTask : workflowDefinitionBean.getTaskTypes(data.data.definedTasks, status.index)}"
                          var="taskType" itemLabel="#{taskType.label}" itemValue="#{taskType}" />
                        <p:ajax event="change" update="form" />
                      </p:selectOneMenu>
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-1"></div>
                    <h:panelGroup layout="block" styleClass="ui-g-12 ui-md-12 ui-lg-2" rendered="#{gtask.taskType ne 'EMAIL'}">
                      <!-- TASK DESCRIPTION -->

                      <p:outputLabel id="task-description-label" for="task-description"
                        value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AllTasks/taskDescription')}:" />
                    </h:panelGroup>
                    <h:panelGroup styleClass="ui-g-12 ui-md-12 ui-lg-3" rendered="#{gtask.taskType ne 'EMAIL'}">
                      <p:inputText id="task-description" value="#{gtask.description}"
                        requiredMessage="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/AllTasks/taskDescription')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}">
                        <p:ajax event="blur" partialSubmit="true" process="@this" global="false" />
                      </p:inputText>
                    </h:panelGroup>
                    <div class="ui-g-12 ui-md-12 ui-lg-2"></div>
                  </div>
                  
                  <div class="ui-g">
                    <h:panelGroup layout="block" styleClass="ui-g-12 ui-md-12 ui-lg-2" rendered="#{gtask.taskType ne 'EMAIL'}">
                      <!-- TASK NAME -->

                      <p:outputLabel id="task-name-label" for="task-name"
                        value="#{ivy.cms.co('/Dialogs/agileBPM/define_WF/TaskSubject')}:" />
                    </h:panelGroup>
                    <h:panelGroup layout="block" styleClass="ui-g-12 ui-md-12 ui-lg-3" rendered="#{gtask.taskType ne 'EMAIL'}">
                      <p:inputText id="task-name" value="#{gtask.subject}" maxlength="30" required="true"
                        requiredMessage="#{ivy.cms.co('/Dialogs/agileBPM/define_WF/TaskSubject')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}">
                        <p:ajax event="blur" partialSubmit="true" process="@this" global="false" />
                      </p:inputText>
                    </h:panelGroup>
                    <div class="ui-g-12 ui-md-12 ui-lg-1"></div>
                    <h:panelGroup layout="block" styleClass="ui-g-12 ui-md-12 ui-lg-2" rendered="#{gtask.taskType ne 'EMAIL'}">
                      <!-- RESPONSIBLE -->
                      <p:outputLabel for="task-responsible"
                        value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/ACTIVATOR')}:" />
                    </h:panelGroup>
                    <h:panelGroup layout="block" id="task-responsible-input-container" styleClass="ui-g-12 ui-md-12 ui-lg-3" rendered="#{gtask.taskType ne 'EMAIL'}">
                      <h:inputHidden id="task-responsible" value="#{gtask.responsibleDisplayName}" required="true"
                        requiredMessage="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/ACTIVATOR')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}" />
                      <p:commandLink id="task-responsible-link" immediate="true" styleClass="task-responsible-link"
                        value="#{not empty gtask.responsibleDisplayName ? gtask.responsibleDisplayName : ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/NoSelection')}"
                        actionListener="#{logic.initAssginement(gtask)}" oncomplete="PF('choose-responsible-dialog').show();"
                        update="assignee-selection-form:assignee-selection-panel" global="false" />
                    </h:panelGroup>
                    <div class="ui-g-12 ui-md-12 ui-lg-2"></div>
                  </div>
                  <div class="ui-g">

                    <h:panelGroup layout="block" styleClass="ui-g-12 ui-md-12 ui-lg-2" rendered="#{gtask.taskType ne 'EMAIL'}">
                      <!-- NUMBER OF VALID DAYS -->
                      <p:outputLabel id="valid-days-label" for="valid-days" rendered="#{gtask.position gt 1}"
                        value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/DueTimeInDays')}:" />
                      <p:tooltip for="valid-days-label" id="valid-days-label-tooltip"
                        value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UntilDaysTooltip')}" />
                    </h:panelGroup>
                    <h:panelGroup layout="block" styleClass="ui-g-12 ui-md-12 ui-lg-1" rendered="#{gtask.taskType ne 'EMAIL'}">
                      <p:spinner id="valid-days" value="#{gtask.untilDays}" min="1" rendered="#{gtask.position gt 1}" />
                      <p:tooltip for="valid-days" id="valid-days-tooltip"
                        value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UntilDaysTooltip')}" />
                    </h:panelGroup>
                    <div class="ui-g-12 ui-md-12 ui-lg-9"></div>
                  </div>
                </div>
              </h:panelGroup>

              <!-- FOR DEFAULT UI TEMPLATE -->

              <h:panelGroup id="default-dynamic-task-panel-grid"
                styleClass="dynamic-task-panel-grid default-dynamic-task-panel-grid"
                rendered="#{data.data.isUseDefaultUI}">
                <div class="ui-fluid">

                  <div class="ui-g">

                    <!-- RESPONSIBLE -->
                    <div class="ui-g-12 ui-md-12 ui-lg-2">
                      <p:outputLabel rendered="#{gtask.position gt 1}" for="default-task-responsible"
                        value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/ACTIVATOR')}:" />
                      <p:outputLabel rendered="#{gtask.position == 1}" for="default-task-responsible"
                        value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/ACTIVATOR')}:" />
                    </div>
                    <h:panelGroup layout="block" id="default-task-responsible-input-container" styleClass="ui-g-12 ui-md-12 ui-lg-3">
                      <h:inputHidden id="default-task-responsible" value="#{gtask.responsibleDisplayName}" required="true"
                        requiredMessage="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/taskList/defaultColumns/ACTIVATOR')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}" />
                      <p:commandLink id="default-task-responsible-link" immediate="true" styleClass="task-responsible-link"
                        value="#{not empty gtask.responsibleDisplayName ? gtask.responsibleDisplayName : ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/NoSelection')}"
                        actionListener="#{logic.initAssginement(gtask)}" oncomplete="PF('choose-responsible-dialog').show();"
                        update="assignee-selection-form:assignee-selection-panel" global="false" />
                    </h:panelGroup>
                    <div class="ui-g-12 ui-md-12 ui-lg-1"></div>

                    <div class="ui-g-12 ui-md-12 ui-lg-2">
                      <!-- TASK NAME -->

                      <p:outputLabel id="default-task-name-label" for="default-task-name"
                        rendered="#{status.index == 0}"
                        value="#{ivy.cms.co('/Dialogs/agileBPM/define_WF/TaskSubject')}:" />
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-3">
                      <p:inputText id="default-task-name" value="#{gtask.subject}" maxlength="30"
                        rendered="#{status.index == 0}" required="true"
                        requiredMessage="#{ivy.cms.co('/Labels/Task')} #{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/requiredFieldMessage')}">
                        <p:ajax event="blur" partialSubmit="true" process="@this" global="false" />
                      </p:inputText>

                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-2"></div>

                  </div>
                  <div class="ui-g">

                    <div class="ui-g-12 ui-md-12 ui-lg-2">
                      <!-- NUMBER OF VALID DAYS -->

                      <p:outputLabel id="default-valid-days-label" for="default-valid-days"
                        rendered="#{gtask.position gt 1}"
                        value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/DueTimeInDays')}:" />
                      <p:tooltip for="default-valid-days-label" id="default-valid-days-label-tooltip"
                        value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UntilDaysTooltip')}" />
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-1">
                      <p:spinner id="default-valid-days" value="#{gtask.untilDays}" min="1"
                        rendered="#{gtask.position gt 1}" />
                      <p:tooltip for="valid-days" id="default-valid-days-tooltip"
                        value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UntilDaysTooltip')}" />
                    </div>

                  </div>

                </div>
              </h:panelGroup>
            </p:panel>

            <p:panelGrid id="dynamic-task-action-container-#{gtask.position}" styleClass="dynamic-task-action-container"
              rendered="#{data.data.definedTasks.size() == gtask.position}">
              <p:row>
                <p:column styleClass="dynamic-task-left-action">
                  <p:commandButton id="add-step-button" icon="fa fa-plus" immediate="true"
                    value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/AddProcessStep')}"
                    actionListener="#{logic.addProcessStep}" process="form" update="form error-messages">
                  </p:commandButton>
                </p:column>

                <p:column styleClass="dynamic-task-right-action">
                  <p:commandButton id="remove-step-button" icon="fa fa-minus" immediate="true"
                    rendered="#{data.data.definedTasks.size()>1}"
                    value="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/DeleteProcessStep')}"
                    actionListener="#{logic.deleteProcessStep}" process="form" update="form error-messages">
                  </p:commandButton>

                </p:column>
              </p:row>
            </p:panelGrid>
          </p:fieldset>
        </ui:repeat>

        <br />

        <p:outputPanel styleClass="TexAlRight">
          <p:commandButton id="save" actionListener="#{logic.close}" update="form error-messages"
            icon="fa #{data.data.isUseDefaultUI ? 'fa-check' : 'fa-arrow-right'}"
            value="#{data.data.isUseDefaultUI ? 
                          (data.data.processType eq 'AD_HOC' ? ivy.cms.co('/Dialogs/workflowCreation/FormDefinition/ExecuteWorkflow') : ivy.cms.co('/Dialogs/workflowCreation/FormDefinition/SaveWorkflow')) : 
                          ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/next')}">
            <ui:param name="save-workflow" value="true" />
          </p:commandButton>
          <p:spacer width="5" />

          <p:commandButton id="cancel-workflow-button" actionListener="#{logic.cancel}"
            styleClass="portal-cancel-button" immediate="true"
            value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/cancel')}" icon="fa fa-times" />
        </p:outputPanel>

      </h:form>

      <p:dialog id="choose-responsible-dialog" styleClass="choose-responsible-dialog"
        header="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/ChooseAssignee/AddUserOrRole')}"
        widgetVar="choose-responsible-dialog" modal="true" appendTo="@(body)" width="600" resizable="false">
        <p:ajax event="close" listener="#{logic.closeDialog}" global="false" immediate="true" />
        <ui:include src="ChooseAssignee.xhtml" />
      </p:dialog>

      <p:dialog id="default-template-dialog" styleClass="default-template-dialog"
        header="#{ivy.cms.co('/Dialogs/workflowCreation/DefaultTemplateDialogHeader')}"
        widgetVar="default-template-dialog" modal="true" appendTo="@(body)" width="700" resizable="false">
        <ui:include src="DefaultTemplate.xhtml" />

        <h:panelGroup layout="block" styleClass="u-dialog-footer ui-dialog-footer">
          <p:commandButton type="button" id="close-default-templat-dialog-button"
            value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/close')}"
            onclick="PF('default-template-dialog').hide();" />
        </h:panelGroup>
      </p:dialog>

      <p:confirmDialog id="delete-all-defined-tasks-warning" widgetVar="deleteAllDefinedTasksWarning"
        message="#{ivy.cms.co('/Dialogs/workflowCreation/WorkflowDefinition/UserInterface/ChangeSettingWarning')}"
        appendTo="@(body)" header="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/warning')}" severity="alert"
        closable="false">
        <div class="delete-server-warning-buttons">
          <p:commandButton id="delete-all-defined-tasks-warning-ok"
            value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/yes')}"
            actionListener="#{logic.changeUISetting(true)}" oncomplete="PF('deleteAllDefinedTasksWarning').hide()"
            update="form" global="false" />
          <p:commandButton id="delete-all-defined-tasks-warning-cancel" styleClass="portal-cancel-button"
            value="#{ivy.cms.co('/ch.ivy.addon.portalkit.ui.jsf/common/no')}"
            actionListener="#{logic.changeUISetting(false)}" oncomplete="PF('deleteAllDefinedTasksWarning').hide()"
            update="form" global="false" />
        </div>
      </p:confirmDialog>
    </ui:define>

    <ui:define name="css">
      <h:outputStylesheet library="css" name="portal_express.css" />
    </ui:define>
    <script>
          
        </script>
  </ui:composition>
</h:body>
</html>
