pipeline {
  agent none
  
  options {
    buildDiscarder(logRotator(numToKeepStr: '60', artifactNumToKeepStr: '5'))
  }
  
  tools { 
      maven '3.6' 
      jdk '11' 
  }

  parameters {
      choice(name: 'engine', choices: ['singleAppEngine', 'multiAppsEngine', 'peformanceTestEngine'], description: 'Which engine to be upgraded?')
      string(name: 'engineDownloadURL', defaultValue: '-Divy.engine.download.url=https://developer.axonivy.com/permalink/sprint/axonivy-engine-windows.zip', description: 'Where to download engine?')

  }

  environment {
    portalApplicationName = 'Portal'

  }

  stages {
    stage('backupDatabase') {
      agent {label 'master'}
      steps {
        script {
          today = new Date().format('dd-MM-yyyy_HH-mm')

          config = [singleAppEngine: [engineParentDir: 'D:\\tools\\ivy-server\\', engineName: 'trunk', databaseBackupDir: 'D:\\backup\\database', databaseName: 'ivy-trunk', serviceName: 'Axon.ivy-trunk']
          ,multiAppsEngine: [engineParentDir: 'D:\\tools\\ivy-server\\', engineName: 'trunk-1', databaseBackupDir: 'D:\\backup\\database', databaseName: 'ivy-trunk-1', serviceName: 'Axon.ivy-trunk-1']
          ,peformanceTestEngine: [engineParentDir: 'C:\\tools\\ivy-server\\', engineName: 'trunk', databaseBackupDir: 'D:\\backup\\database', databaseName: 'ivy-performance-trunk', serviceName: 'Axon.ivyEngineTrunk']]

          engineParentDir = config[params.engine]['engineParentDir']
          engineName = config[params.engine]['engineName']
          databaseBackupDir = config[params.engine]['databaseBackupDir']
          databaseName = config[params.engine]['databaseName']
          serviceName = config[params.engine]['serviceName']
          engineDir = engineParentDir  + engineName
          renamedEngineDir = engineDir + '-bk'
          engineBackupDir = engineParentDir + 'upgrade-backup'
          dbBackupFileName = engineName + '-' + today

          bat """
            echo ====================Backup database====================
            pg_dump -U postgres -f ${databaseBackupDir}\\${databaseName}-${today}.backup -F Custom -b ${databaseName}
          """

          nodeToExecute = (params.engine == 'peformanceTestEngine') ? 'portal-slave' : 'master'
        }
      }
    }
    stage('replaceEngine') {
      agent {label nodeToExecute}
      steps {
        script {
          bat """
            echo ====================Backup data to restore in case build fails====================
            xcopy /s/y/h/e/k/i/q ${engineDir} ${engineBackupDir}\\${engineName}-${today}
            echo ====================Stop engine====================
            sc query "${serviceName}" | find /i "RUNNING"
            if not "%ERRORLEVEL%"=="1" ( net stop "${serviceName}" )
            echo ====================Rename current engine folder====================
            if exist ${renamedEngineDir} rmdir /s /q ${renamedEngineDir}
            :repeat
            ren "${engineDir}" "${engineName}-bk" || goto :repeat
            echo ====================Extract engine====================
            mvn clean compile -f AxonIvyPortal/PortalTest/pom.xml -Divy.engine.directory=${engineDir} %engineDownloadURL%
            echo ====================Copy license, configuration files====================
            copy /D/Y ${renamedEngineDir}\\configuration\\*.lic ${engineDir}\\configuration
            copy /D/Y ${renamedEngineDir}\\configuration\\*.yaml ${engineDir}\\configuration
          """
          powershell """
            echo "====================Copy applications, misc/iis (for SSO)===================="
            if (Test-Path ${renamedEngineDir}\\applications) {
              copy -path ${renamedEngineDir}\\applications -recurse -force -destination ${engineDir}
            }
            copy -path ${renamedEngineDir}\\misc\\iis -recurse -force -destination ${engineDir}\\misc
          """
          bat """
            echo ====================Start engine====================
            net start "${serviceName}"

            @echo off
            echo %time%
            for /l %%i IN (1,1,150) do (
              sc query "${serviceName}" | findstr STATE | findstr RUNNING
              if errorlevel 1 (
                ping 1.1.1.1 -n 1 -w 1000 > nul
              ) else (
                echo ${serviceName} started
              goto :endwaiting
              )
            )
            :endwaiting
            echo %time%

            echo on
          """
        }
      }
    }
  }
}
