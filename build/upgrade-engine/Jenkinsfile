pipeline {
  agent none
  
  options {
    buildDiscarder(logRotator(numToKeepStr: '60', artifactNumToKeepStr: '5'))
  }
  
  tools { 
      maven '3.6' 
      jdk '11' 
  }

  parameters {
      choice(name: 'engine', choices: ['singleAppEngine', 'multiAppsEngine', 'performanceTestEngine'], description: 'Which engine to be upgraded?')
      string(name: 'engineDownloadURL', defaultValue: '-Divy.engine.list.url=https://jenkins.ivyteam.io/job/ivy-core_product/job/release%%252F9.3/lastSuccessfulBuild/artifact/workspace/ch.ivyteam.ivy.server.product/target/products/ -Divy.engine.os.arch=Windows_x64', description: '''Where to download engine? e.g.
        -Divy.engine.download.url=https://developer.axonivy.com/permalink/nightly/axonivy-engine-windows.zip for nightly master
        -Divy.engine.download.url=-Divy.engine.download.url=https://developer.axonivy.com/permalink/dev/axonivy-engine-windows.zip for dev master
        -Divy.engine.download.url=file:///C:/wawa/engine/AxonIvyEngineX.X.X.X_Windows_x64.zip for downloaded engine
      ''')
  }

  environment {
    portalApplicationName = 'Portal'

  }

  stages {
    stage('backupDatabase') {
      agent {label 'master'}
      steps {
        script {
          today = new Date().format('dd-MM-yyyy_HH-mm')

          config = [singleAppEngine: [engineParentDir: 'D:\\tools\\ivy-server\\', engineName: 'trunk', databaseBackupDir: 'D:\\backup\\database', databaseName: 'ivy-trunk', serviceName: 'Axon.ivy-trunk']
          ,multiAppsEngine: [engineParentDir: 'D:\\tools\\ivy-server\\', engineName: 'trunk-1', databaseBackupDir: 'D:\\backup\\database', databaseName: 'ivy-trunk-1', serviceName: 'Axon.ivy-trunk-1']
          ,performanceTestEngine: [engineParentDir: 'C:\\tools\\ivy-server\\', engineName: 'trunk', databaseBackupDir: 'D:\\backup\\database', databaseName: 'ivy-performance-trunk', serviceName: 'Axon.ivyEngineTrunk']]

          engineParentDir = config[params.engine]['engineParentDir']
          engineName = config[params.engine]['engineName']
          databaseBackupDir = config[params.engine]['databaseBackupDir']
          databaseName = config[params.engine]['databaseName']
          serviceName = config[params.engine]['serviceName']
          engineDir = engineParentDir  + engineName
          renamedEngineDir = engineDir + '-bk'
          engineBackupDir = engineParentDir + 'upgrade-backup'
          dbBackupFileName = engineName + '-' + today

          bat """
            echo ====================Backup database====================
            pg_dump -U postgres -f ${databaseBackupDir}\\${databaseName}-${today}.backup -F Custom -b ${databaseName}
          """

          nodeToExecute = (params.engine == 'performanceTestEngine') ? 'portal-slave' : 'master'
        }
      }
    }
    stage('replaceEngine') {
      agent {label nodeToExecute}
      steps {
        script {
          def utils = load 'build/common/utils.groovy'
          utils.stopWindowsService(serviceName)
          bat """
            echo ====================Backup data to restore in case build fails====================
            xcopy /s/y/h/e/k/i/q ${engineDir} ${engineBackupDir}\\${engineName}-${today}
            echo ====================Rename current engine folder====================
            if exist ${renamedEngineDir} rmdir /s /q ${renamedEngineDir}
            :repeat
            ren "${engineDir}" "${engineName}-bk" || goto :repeat
          """
          utils.extractEngine(engineDir, params.engineDownloadURL)
          bat """
            echo ====================Copy license, configuration files====================
            copy /D/Y ${renamedEngineDir}\\configuration\\*.lic ${engineDir}\\configuration
            copy /D/Y ${renamedEngineDir}\\configuration\\*.yaml ${engineDir}\\configuration
            xcopy /D/S/Y/I ${renamedEngineDir}\\configuration ${engineDir}\\configuration
          """
          powershell """
            echo "====================Copy applications, misc/iis (for SSO)===================="
            if (Test-Path ${renamedEngineDir}\\applications) {
              copy -path ${renamedEngineDir}\\applications -recurse -force -destination ${engineDir}
            }
            copy -path ${renamedEngineDir}\\misc\\iis -recurse -force -destination ${engineDir}\\misc
          """
          utils.startWindowsService(serviceName)
        }
      }
    }
  }
}
