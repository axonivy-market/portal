pipeline {
  agent { label 'linux' }

  options {
    buildDiscarder(logRotator(numToKeepStr: '200', artifactNumToKeepStr: '5'))
  }

  // cron job triggers removed

  environment {
    // Jmeter DSL source directory is in Portal source -> prefer to Performance test
    jmeterDslSourceDir = '"${WORKSPACE}/AxonIvyPortal/portal-performance-test'
    ivyDir = '/var/tools/ivy'
    //could be master/12/10
    resultDir = '/var/tools/jmeter-javadsl-performance-result/master'
  }

  stages {
    stage('Setup Credentials') {
      steps {
        script {
          withCredentials([
              file(credentialsId: 'users-server-csv', variable: 'USERS_SERVER_CSV'),
              file(credentialsId: 'admin-user-server-csv', variable: 'ADMIN_USER_CSV'),
              file(credentialsId: 'normal-user-server-csv', variable: 'NORMAL_USER_CSV'),
          ]) {
            sh '''
              # Copy files into the running container
              docker cp "$USERS_SERVER_CSV" ivy-performance-master:AxonIvyPortal/portal-performance-test/jmeter/data/users_server.csv
              docker cp "$ADMIN_USER_CSV" ivy-performance-master:AxonIvyPortal/portal-performance-test/jmeter/data/admin_user.csv
              docker cp "$NORMAL_USER_CSV" ivy-performance-master:AxonIvyPortal/portal-performance-test/jmeter/data/normal_user.csv
            '''
          }
        }
      }
    }
    stage('Run JMeter-JavaDSL Tests') {
      steps {
        script {
          dir("${jmeterDslSourceDir}") {
            sh 'mvn clean test'
          }
        }
      }
    }
  }

  post {
    always {
      script {
        sh '''
          cp -r ${jmeterDslSourceDir}/target/jtls/* ${resultDir}
        '''
        perfReport sourceDataFiles: "${jmeterDslSourceDir}/target/jtls/**/*.jtl", compareBuildPrevious: true, ignoreFailedBuilds: true, ignoreUnstableBuilds: true, errorFailedThreshold: 1
      }
    }
  }
}
