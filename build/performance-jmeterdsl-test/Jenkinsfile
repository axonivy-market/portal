pipeline {
  agent { label 'linux' }

  options {
    buildDiscarder(logRotator(numToKeepStr: '200', artifactNumToKeepStr: '5'))
  }

  // cron job triggers removed

  environment {
    // Jmeter DSL source directory is in Portal source -> prefer to Performance test
    jmeterDslSourceDir = '"${WORKSPACE}/AxonIvyPortal/portal-performance-test'
    ivyDir = '/var/tools/ivy'
    //could be master/12/10
    resultDir = '/var/tools/jmeter-javadsl-performance-result/master'
  }

  stages {
    stage('deploy') {
      steps {
        script {
          engineNames = ['master', '12', '10', '8', 'performance-master', 'performance-12', 'performance-10', 'performance-8']
          currentBuild.description = "On ${env.NODE_NAME}"
          for (engineName in engineNames) {
            sh "docker compose -f ${ivyDir}/${engineName}/docker-compose.yml down"
          }
          sh """
            docker compose -f ${ivyDir}/${engineNames[4]}/docker-compose.yml up -d
            sleep 100
          """
        }
      }
    }

    stage('Setup Credentials') {
      steps {
        script {
          withCredentials([
              file(credentialsId: 'users-server-csv', variable: 'USERS_SERVER_CSV'),
              file(credentialsId: 'admin-user-server-csv', variable: 'ADMIN_USER_CSV'),
              file(credentialsId: 'normal-user-server-csv', variable: 'NORMAL_USER_CSV'),
          ]) {
            // Copy credential files to expected locations
            sh '''
              cp "$USERS_SERVER_CSV" "jmeter/data/users_server.csv"
              cp "$ADMIN_USER_CSV" "jmeter/data/single_admin_user_server.csv"
              cp "$NORMAL_USER_CSV" "jmeter/data/single_normal_user_server.csv"
              
              # Verify files were created
              echo "Credential files created:"
              ls -la jmeter/data/*.csv
            '''
          }
        }
      }
    }
    stage('Run JMeter-JavaDSL Tests') {
      steps {
        script {
          dir("${jmeterDslSourceDir}") {
            sh 'mvn clean test'
          }
        }
      }
    }
  }

  post {
    always {
      script {
        for (engineName in engineNames) {
          sh "docker compose -f ${ivyDir}/${engineName}/docker-compose.yml down"
        }

        sh '''
          docker compose -f ${ivyDir}/${engineNames[0]}/docker-compose.yml up -d
          docker compose -f ${ivyDir}/${engineNames[1]}/docker-compose.yml up -d

          cp -r ${jmeterDslSourceDir}/target/jtls/* ${resultDir}
        '''
        perfReport sourceDataFiles: "${jmeterDslSourceDir}/target/jtls/**/*.jtl", compareBuildPrevious: true, ignoreFailedBuilds: true, ignoreUnstableBuilds: true, errorFailedThreshold: 1
      }
    }
  }
}
