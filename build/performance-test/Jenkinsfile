pipeline {
  agent { label 'linux' }

  options {
    buildDiscarder(logRotator(numToKeepStr: '200', artifactNumToKeepStr: '5'))
  }

  triggers {
    cron('0 13 * * *')
  }

  environment {
    engineVersion = 'master'
    devEngineDir = "/var/tools/ivy/${env.engineVersion}"
    performanceEngineDir = "/var/tools/ivy/performance-${env.engineVersion}"
    portalApplicationName = 'Portal'
  }

  stages {
    stage('deploy') {
      steps {
        script {
          utils = load 'build/common/utils.groovy'
          sh """
            docker compose -f ${devEngineDir}/docker-compose.yml down
            docker compose -f ${performanceEngineDir}/docker-compose.yml down
            docker compose -f ${performanceEngineDir}/docker-compose.yml up -d
          """

          docker.build('build-portal-modules', '-f build/Dockerfile .').inside('-v /var/tools/maven-cache:/home/build/') {
            def modules = ['AxonIvyPortal/portal-components', 'AxonIvyPortal/portal']
            def buildPluginVersion = readMavenPom(file: 'AxonIvyPortal/portal-components/pom.xml').getProperties().getProperty('build.plugin.version')
            def engineUrl = 'http://10.123.1.216:9000'
            for (module in modules) {
              maven cmd: "clean install -f ${module}/pom.xml"
              maven cmd: "com.axonivy.ivy.ci:project-build-plugin:${buildPluginVersion}:deploy-to-engine -f ${module}/pom.xml -Divy.deploy.server.id=engine-cockpit -Divy.deploy.engine.app=Portal -Divy.deploy.method=HTTP -Divy.deploy.engine.url=${engineUrl} -Divy.test.engine=MODIFY_EXISTING"
            }
          }
        }
      }
    }
    stage('test') {
      steps {
        script {
          today = new Date().format('dd-MM-yyyy_HH-mm')
          resultDir = "/var/tools/performance-result/${env.engineVersion}/${today}"
          fileOperations([folderCreateOperation(folderPath: "${resultDir}")])

          echo '====================Test one admin user===================='
          updateConfigFile('data/single_admin_user_server.csv', '1')
          // First executing takes more time, so not record the result of first time
          executeJMeter('../tmp.jtl')

          executeJMeter('result_1_admin_user.jtl')

          echo '====================Test for one normal user===================='
          updateConfigFile('data/single_normal_user_server.csv', '1')
          executeJMeter('result_1_normal_user.jtl')

          echo '====================Test ten users===================='
          updateConfigFile('data/users_server.csv', '10')
          executeJMeter('result_10_users.jtl')
        }
      }
    }
  }

  post {
    always {
      script {
        sh """
          docker compose -f ${performanceEngineDir}/docker-compose.yml down
          docker compose -f ${devEngineDir}/docker-compose.yml up -d
        """
      }
      script {
        if (binding.hasVariable('today')) {
          perfReport sourceDataFiles: "${resultDir}/*.jtl", compareBuildPrevious :true, ignoreFailedBuilds: true, ignoreUnstableBuilds: true, errorFailedThreshold: 1
        }
      }
    }
  }
}

def updateConfigFile(acccountFilePath, numberOfUser) {
  sh """
    awk -F'=' -v OFS='=' -v newval='${acccountFilePath}' '/^file.csv/{\$2=newval;print;next}1' AxonIvyPortal/PortalTest/jmeter/test.properties > AxonIvyPortal/PortalTest/jmeter/tmp.properties
    awk -F'=' -v OFS='=' -v newval='${numberOfUser}' '/^portal.thread.numberOfUser/{\$2=newval;print;next}1' AxonIvyPortal/PortalTest/jmeter/tmp.properties > AxonIvyPortal/PortalTest/jmeter/test.properties
  """
}

def executeJMeter(resultFileName) {
  docker.build('jmeter-performance-test', '-f build/performance-test/Dockerfile .').inside("""
        -v /var/tools/jenkins-linux/workspace/of-Master-Branch-to-new-Server_3/AxonIvyPortal/PortalTest/jmeter:/opt/apache-jmeter-5.5/bin/portal-jmeter
        -v ${resultDir}:/opt/apache-jmeter-5.5/bin/result
      """) {
    sh "/opt/apache-jmeter-5.5/bin/jmeter -n -t /opt/apache-jmeter-5.5/bin/portal-jmeter/portal_walkthrough_testplan.jmx -l /opt/apache-jmeter-5.5/bin/result/${resultFileName}"
  }
}
