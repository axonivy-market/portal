pipeline {
  agent {label 'master'}
  
  options {
    buildDiscarder(logRotator(numToKeepStr: '200', artifactNumToKeepStr: '5'))
  }
  
  triggers {
    cron('H 15 * * *')
  }

  tools { 
      maven '3.6' 
      jdk '8' 
  }

  environment {
    engineVersion = 'LTS'
    engineDir = "C:/tools/ivy-server/${env.engineVersion}"
    portalApplicationName = 'Portal'
  }

  stages {
    stage('deploy') {
      agent {label 'portal-slave'}
      steps {
        script {
          engines = ['Axon.ivy Engine - LTS', 'Axon.ivyEngine8.0', 'Axon.ivyEngineTrunk']
          for (engine in engines) {
            bat """
              net stop \"${engine}\"
              exit 0
            """
          }
          bat """
            net start "${engines[0]}"
            exit 0
          """

          def modules = ['AxonIvyPortal/PortalStyle', 'AxonIvyPortal/PortalKit', 'AxonIvyPortal/PortalTemplate', 'AxonIvyPortal/AxonIvyExpress']
          for (module in modules) {
            bat "mvn clean install -f ${module}/pom.xml"
            bat "mvn com.axonivy.ivy.ci:project-build-plugin:7.0.4:deploy-iar -f ${module}/pom.xml -Divy.deploy.engine.app=%portalApplicationName% -Divy.deploy.engine.dir=%engineDir%"
          }
        }
      }
    }
    stage('test') {
      tools { 
        jdk '8' 
      }
      steps {
        script {
          today = new Date().format('dd-MM-yyyy_HH-mm')
          fileOperations([folderCreateOperation(folderPath: "D:/PerformanceResult/${today}/${env.engineVersion}")])

          echo "====================Test one admin user===================="
          updateConfigFile('data/single_admin_user_server.csv', '1')
          bat '''
            jmeter.bat -n -t AxonIvyPortal/PortalTest/jmeter/portal_walkthrough_testplan.jmx -l temp.jtl
          '''
          executeJMeter('result_1_admin_user.jtl')

          echo "====================Test for one normal user===================="
          updateConfigFile('data/single_normal_user_server.csv', '1')
          executeJMeter('result_1_normal_user.jtl')

          echo "====================Test ten users===================="
          updateConfigFile('data/users_server.csv', '10')
          executeJMeter('result_10_users.jtl')
        }
      }
    }
  }

  post {
    always {
      node('portal-slave') {
        bat """
          net stop "${engines[1]}"
          exit 0
        """
      }
      archiveArtifacts artifacts: "D:/PerformanceResult/${today}/*/*.jtl", allowEmptyArchive: true, fingerprint: true
      perfReport sourceDataFiles: "D:/PerformanceResult/${today}/*/*.jtl", compareBuildPrevious :true, ignoreFailedBuilds: true, ignoreUnstableBuilds: true
    }
  }
}

def updateConfigFile(acccountFilePath, numberOfUser) {
  powershell """
    get-content AxonIvyPortal/PortalTest/jmeter/test.properties | select-string -pattern 'portal.thread.numberOfUser' -notmatch | select-string -pattern 'file.csv' -notmatch | Out-File AxonIvyPortal/PortalTest/jmeter/out.properties -encoding ASCII
    Add-Content AxonIvyPortal/PortalTest/jmeter/out.properties \"file.csv=${acccountFilePath}\"
    Add-Content AxonIvyPortal/PortalTest/jmeter/out.properties \"portal.thread.numberOfUser=${numberOfUser}\"
    move AxonIvyPortal/PortalTest/jmeter/out.properties AxonIvyPortal/PortalTest/jmeter/test.properties -Force
  """
}

def executeJMeter(resultFileName) {
  bat """
    jmeter.bat -n -t AxonIvyPortal/PortalTest/jmeter/portal_walkthrough_testplan.jmx -l D:/PerformanceResult/${today}/${env.engineVersion}/${resultFileName}
  """
}