pipeline {
    agent any

    stages {
        stage("build") {
            steps {
                script {
                    builtModules = ['AxonIvyPortal/portal-components']
                    docker.withRegistry('', 'docker.io') {
                        docker.build("portal", "-f build/Dockerfile .").inside() {
                            for (module in builtModules) {
                                maven cmd: "clean install -f ${module}/pom.xml"
                            }
                        }
                    }
                    archiveArtifacts artifacts: "*/*/target/*.iar", allowEmptyArchive: true
                  
                }
            }
        }

        stage("deploy") {
            steps {
                script {
                    docker.withRegistry('', 'docker.io') {
                        docker.build("portal", "-f build/Dockerfile .").inside() {
                            for (module in builtModules) {
                                maven cmd: "com.axonivy.ivy.ci:project-build-plugin:10.0.1:deploy-to-engine -f ${module}/pom.xml -Divy.deploy.server.id=NightlyPortal -Divy.deploy.engine.app=Portal -Divy.deploy.method=HTTP -Divy.deploy.engine.url=http://10.123.1.216/:8011 -Divy.test.engine=MODIFY_EXISTING"
                            }
                        }
                    }
                }
            }
        }
    }
}