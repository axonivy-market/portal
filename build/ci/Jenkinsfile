pipeline {
  agent any

  environment {
    imgSimilarity = 98
    dockerfileParams = '--shm-size 1g --hostname=ivy'
  }

  stages {
    stage('build') {
      steps {
        script {
          def random = (new Random()).nextInt(10000000)
          def networkName = "build-" + random
          def ivyName = "ivy-" + random
          sh "docker network create ${networkName}"
          try {
            docker.image("selenium/standalone-firefox:4").withRun("-e START_XVFB=false --shm-size=2g --name --network ${networkName}") {
              docker.build('maven').inside("--name ${ivyName} --network ${networkName}") {
                maven cmd: 'clean install -f AxonIvyPortal/portal-components/pom.xml'
              }
            }
            archiveArtifacts artifacts: "*/*/target/*.iar", allowEmptyArchive: true
          } finally {
            sh "docker network rm ${networkName}"
          }
        }      
      }
    }
  }
}