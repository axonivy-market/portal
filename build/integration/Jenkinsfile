pipeline {
  agent {label 'portal-slave-linux'}
  
  options {
    buildDiscarder(logRotator(numToKeepStr: '60', artifactNumToKeepStr: '5'))
  }

  parameters {
      string(name: 'testPatternToRun', defaultValue: 'com.axonivy.portal.selenium.test.**.*Test', description: 'Test pattern to run')
      string(name: 'engineDownloadURL', defaultValue: '-Divy.engine.download.url=https://developer.axonivy.com/permalink/nightly/axonivy-engine.zip', description: '''Where to download engine? e.g.
        -Divy.engine.download.url=https://developer.axonivy.com/permalink/nightly/axonivy-engine.zip for nightly master
        -Divy.engine.download.url=https://developer.axonivy.com/permalink/dev/axonivy-engine.zip for dev master
        -Divy.engine.download.url=file:///home/build/engine/AxonIvyEngineX.X.X.X_Linux_x64.zip for downloaded engine
        -Divy.engine.list.url=https://jenkins.ivyteam.io/job/core_product/job/release%252F9.4/lastSuccessfulBuild/artifact/workspace/ch.ivyteam.ivy.server.product/target/products/ -Divy.engine.os.arch=Linux_x64 for last successful build 9.4
      ''')
      booleanParam(name: 'skipReplacePortal', defaultValue: false, description: 'Should skip replace Portal artifacts in the engine? TRUE: keep built-in Portal of the engine, FALSE: replace built-in Portal of the engine by the latest successful release.')
  }

  environment {
    releaseDir = 'archive'
    engineDir = "${env.WORKSPACE}/AxonIvyPortal/portal-selenium-test/engine"
    MAVEN_OPTS = "-Xmx3000m -XX:+HeapDumpOnOutOfMemoryError"
  }
  stages {
    stage('build') {
      steps {
        script {
          currentBuild.description = "On ${env.NODE_NAME}"
          downloadPortalRelease()

          def random = (new Random()).nextInt(10000000)
          env.networkName = "build-" + random
          env.seleniumName = "selenium-" + random
          env.wawaName = "wawa-" + random
          sh "docker network create ${env.networkName}"
          try {
            docker.image("selenium/standalone-firefox:4").withRun("--shm-size=2g --name ${env.seleniumName} --network ${env.networkName} --hostname=wawa") {
              docker.build('gui-test-portal', '-f build/Dockerfile .').inside("--name ${env.wawaName} --network ${env.networkName} -v /var/tools/maven-cache:/home/build/") {
                echo '====================Check out tag of Portal latest successful release===================='
                sh '''#!/bin/bash
                  artifactPattern="${releaseDir}/AxonIvyPortal/portal/target/*.iar"
                  artifactName=$(basename $artifactPattern .iar)
                  versionLastestReleasedPortal=${artifactName:7}
                  git fetch --tags
                  git checkout tags/$versionLastestReleasedPortal
                  git reset --hard HEAD
                  git clean -fd
                '''

                echo '====================Copy patch to workspace if any. Note: this is in a tag and we cannot change code in git repo===================='
                sh '''
                  if [ -d ../patch/master ]; then
                    cp -rf ../patch/master/* .
                  fi
                '''

                downloadPortalRelease()
                installPortalToLocalRepo()

                echo '====================Extract engine===================='
                maven cmd: "clean compile -ntp -f AxonIvyPortal/portal-components/pom.xml -Divy.engine.directory=${env.engineDir} ${params.engineDownloadURL}"

                echo '====================Build PortalKitTestHelper and InternalSupport===================='
                def extraModules = ['AxonIvyPortal/PortalKitTestHelper', 'Showcase/InternalSupport']
                for (module in extraModules) {
                  maven cmd: "clean install -ntp -f ${module}/pom.xml -Divy.engine.directory=${env.engineDir} -Divy.compiler.engine.start.timeout=120"
                }

                echo '====================Update portal-demo-app with helper modules===================='
                sh '''
                  DEPLOYMENT="${engineDir}/system/demo-applications/demo-portal"
                  tempDir="/tmp/portal-deployment-$$"
                  mkdir -p "$tempDir"

                  cp ${releaseDir}/Showcase/portal-developer-examples/target/*.iar ${releaseDir}/Showcase/portal-components-examples/target/*.iar AxonIvyPortal/PortalKitTestHelper/target/*.iar Showcase/InternalSupport/target/*.iar "$tempDir/"

                  if [ "${skipReplacePortal}" = "false" ]; then
                    rm -rf ${DEPLOYMENT}/*
                    portalZip=$(ls ${releaseDir}/Showcase/portal-demo-app/target/*.zip | head -n 1)
                    cp "$portalZip" "$DEPLOYMENT/"
                    zipPath="$DEPLOYMENT/$(basename $portalZip)"
                  else
                    zipPath=$(ls $DEPLOYMENT/*.zip | head -n 1)
                  fi

                  cd "$tempDir"
                  for iar in *.iar; do
                    zip -u "$zipPath" "$iar"
                  done
                  rm -rf "$tempDir"
                '''

                echo '====================Test Portal===================='
                echo "DEBUG: networkName=${env.networkName}"
                echo "DEBUG: seleniumName=${env.seleniumName}"
                echo "DEBUG: wawaName=${env.wawaName}"
                echo "DEBUG: selenide.remote=http://${env.seleniumName}:4444/wd/hub"
                echo "DEBUG: selenide.baseUrl=http://${env.wawaName}:8080"
                echo "DEBUG: test.engine.url=http://${env.wawaName}:8080"
                maven cmd: "clean test -ntp -f AxonIvyPortal/portal-selenium-test/customized_pom.xml -Dtest=${params.testPatternToRun} -DbrowserType=FIREFOX -Dcapabilities.unhandledPromptBehavior=accept -DtrimStackTrace=false -Divy.engine.directory=${env.engineDir} -Divy.deploy.timeout.seconds=60 -Divy.engine.start.timeout.seconds=500 -Dsurefire.rerunFailingTestsCount=2 -Dselenide.remote=http://${env.seleniumName}:4444/wd/hub -Dselenide.baseUrl=http://${env.wawaName}:8080 -Dtest.engine.url=http://${env.wawaName}:8080"
              }
            }
          } finally {
            sh "docker network rm ${env.networkName}"
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'AxonIvyPortal/portal-selenium-test/target/selenide/reports/**/*.*, AxonIvyPortal/portal-selenium-test/target/testEngineOut.log', allowEmptyArchive: true
      junit allowEmptyResults: true, testResults: '**/surefire-reports/TEST-*.xml'
    }
  }
}

def downloadPortalRelease() {
  echo '====================Download Portal latest successful release===================='
  def branchName = env.BRANCH_NAME.replaceAll("/", "%%2F")
  withCredentials([usernameColonPassword(credentialsId: 'wawa-jenkins', variable: 'credentials')]) {
    sh "curl --user ${credentials} --output archive.zip ${env.JENKINS_URL}job/portal-release/job/${branchName}/lastSuccessfulBuild/artifact/*zip*/archive.zip"
  } // TODO: please change master to ${branchName} after testing
  unzip zipFile: 'archive.zip', quiet: true
}

def installPortalToLocalRepo() {
  def modules = ['AxonIvyPortal/portal', 'AxonIvyPortal/portal-components', 'Showcase/portal-user-examples', 'Showcase/portal-developer-examples']
  for (module in modules) {
    def iarFile = findFiles(glob: "${env.releaseDir}/${module}/target/*.iar")[0].path
    def pomFile = "${env.releaseDir}/${module}/pom.xml"
    maven cmd: "install:install-file -ntp -Dfile=${iarFile} -DpomFile=${pomFile}"
  }
}
