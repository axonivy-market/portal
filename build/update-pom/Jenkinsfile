pipeline {
  agent {
    label 'linux'
  }
  
  options {
    buildDiscarder(logRotator(numToKeepStr: '60', artifactNumToKeepStr: '5'))
  }

  parameters {
    string(name: 'buildPluginVersion', defaultValue: '', description: 'Axon Ivy build plugin version of all pom will be updated to. If empty value, no changes. If buildPluginVersion, ivyEngineVersion, portalVersion, parentVersion params all are empty, this build just updates cached engines, no GIT commits are created.')
    string(name: 'parentVersion', defaultValue: '', description: 'Parent (ivy-project-parent) version of all pom will be updated to. If empty value, no changes. If buildPluginVersion, ivyEngineVersion, portalVersion, parentVersion params all are empty, this build just updates cached engines, no GIT commits are created.')
    string(name: 'ivyEngineVersion', defaultValue: '', description: 'Axon Ivy engine version of all pom will be updated to. If empty value, no changes.')
    string(name: 'portalVersion', defaultValue: '', description: 'Portal version of all pom will be updated to. If empty value, no changes.')
    string(name: 'branchToPush', defaultValue: 'portal-update-pom/master', description: 'Branch name to push changes. It must not be protected branches. After this build, create a pull request to merge to master')
    string(name: 'engineDownloadURL', defaultValue: '-Divy.engine.download.url=https://developer.axonivy.com/permalink/nightly-13.2/axonivy-engine.zip', description: '''Where to download engine? e.g.
      -Divy.engine.download.url=https://developer.axonivy.com/permalink/nightly-13.2/axonivy-engine.zip for nightly master
      -Divy.engine.download.url=https://developer.axonivy.com/permalink/dev/axonivy-engine.zip for dev master
    ''')
  }

  stages {
    stage('build') {
      steps {
        script {
          currentBuild.description = "On ${env.NODE_NAME}"
          if (!params.buildPluginVersion?.trim().isEmpty() || !params.ivyEngineVersion?.trim().isEmpty()
            || !params.portalVersion?.trim().isEmpty() || !params.parentVersion?.trim().isEmpty()) {
            docker.build('update-pom', '-f build/Dockerfile.python .').inside('-v /var/tools/maven-cache:/home/build/') {
              withEnv(['GIT_SSH_COMMAND=ssh -o StrictHostKeyChecking=no']) {
                sshagent(credentials: ['github-axonivy']) {
                  sh """
                    git remote set-url origin git@github.com:axonivy-market/portal.git
                    git checkout ${BRANCH_NAME} || git checkout -b ${BRANCH_NAME}
                    git pull origin ${BRANCH_NAME}
                  """
                  echo '====================Update version===================='
                  updateVersion()

                  echo '====================Commit to GIT===================='
                  changeLog = sh(returnStdout: true, script: 'git status -s').trim()
                  if (changeLog) {
                    sh """
                      git commit -a -m "Updated all pom build.plugin.version=${params.buildPluginVersion}, ivy.engine.version=${params.ivyEngineVersion}, version=${params.portalVersion}, parentVersion=${params.parentVersion}"
                      git checkout -b ${params.branchToPush}
                      git push origin -u ${params.branchToPush}
                    """
                  } else {
                    echo 'Nothing to commit.'
                  }
                }
              }
            }
          }

          echo '====================Cache engine in local repository===================='
          
          docker.build('fetch-cache', '-f build/Dockerfile .').inside('-v /var/tools/maven-cache:/home/build/') {
            ivyEngineVersion = sh(script: "mvn help:evaluate -Dexpression=ivy.engine.version -f AxonIvyPortal/portal-components/pom.xml -q -DforceStdout", returnStdout: true).trim()
            sh """
              if [ -d /home/build/.m2/repository/.cache/ivy/${ivyEngineVersion} ]; then rm -Rf /home/build/.m2/repository/.cache/ivy/${ivyEngineVersion}; fi
            """
            maven cmd: 'clean install -f AxonIvyPortal/portal-components/pom.xml'
          }
        }
      }
    }
  }
}

def updateVersion() {
  def command = "python3 build/update-pom/update_versions.py"
  
  if (!params.portalVersion?.trim().isEmpty()) {
    command += " --portal-version ${params.portalVersion}"
  }
  if (!params.ivyEngineVersion?.trim().isEmpty()) {
    command += " --engine-version ${params.ivyEngineVersion}"
  }
  if (!params.parentVersion?.trim().isEmpty()) {
    command += " --parent-version ${params.parentVersion}"
  }
  if (!params.buildPluginVersion?.trim().isEmpty()) {
    command += " --build-plugin-version ${params.buildPluginVersion}"
  }
  
  sh """
    ${command}
  """
}
