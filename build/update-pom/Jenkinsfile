pipeline {
  agent {label 'master'}
  
  options {
    buildDiscarder(logRotator(numToKeepStr: '60', artifactNumToKeepStr: '5'))
  }

  tools { 
      maven '3.1' 
      jdk '8' 
  }

  parameters {
      string(name: 'buildPluginVersion', defaultValue: '7.0.4', description: 'Axon.ivy build plugin version of all pom will be updated to.')
      string(name: 'ivyEngineVersion', defaultValue: '7.0.17', description: 'Axon.ivy engine version of all pom will be updated to.')
      string(name: 'engineDownloadURL', defaultValue: '-Divy.engine.download.url=https://developer.axonivy.com/permalink/nightly-7/axonivy-engine-windows.zip', description: '''Where to download engine? e.g.
        -Divy.engine.download.url=https://developer.axonivy.com/permalink/nightly-7/axonivy-engine-windows.zip for nightly 7.0
        -Divy.engine.list.url=https://jenkins.ivyteam.io/job/ivy-core-70_product/job/7.0/lastSuccessfulBuild/artifact/workspace/ch.ivyteam.ivy.server.product/target/products/ -Divy.engine.os.arch=Windows_x64 for last successful build 7.0
        -Divy.engine.download.url=file:///C:/wawa/engine/AxonIvyEngineX.X.X.X_Windows_x64.zip for downloaded engine
      ''')
  }

  stages {
    stage('build') {
      steps {
        script {
          echo "====================Update properties build.plugin.version, ivy.engine.version of all pom===================="
          powershell '''
            $utf8WithoutBom = New-Object System.Text.UTF8Encoding($false)
            $files = get-childitem AxonIvyPortal/*/pom.xml,Showcase/*/pom.xml,AxonIvyPortal/PortalTest/customized_pom.xml
            foreach($file in $files) {
              $xml = new-object xml
              $xml.load($file)
              if ($xml.project.properties.'build.plugin.version') {
                $xml.project.properties.'build.plugin.version' = $env:buildPluginVersion
              }
              if ($xml.project.properties.'ivy.engine.version') {
                $xml.project.properties.'ivy.engine.version' = $env:ivyEngineVersion
              }
              $sw = New-Object System.IO.StreamWriter($file, $false, $utf8WithoutBom)
              $xml.Save($sw)
            }
          '''
          echo "====================Commit to GIT===================="
          bat """
            git commit -a -m "Updated all pom build.plugin.version=${buildPluginVersion}, ivy.engine.version=${ivyEngineVersion}"
            git push origin ${env.BRANCH_NAME}
          """
          echo "====================Cache engine in local repository===================="
          cacheEngine()
        }
      }
    }

    stage('cache-engine-on-performance-server') {
      agent {label 'portal-slave'}
      steps {
        script {
          cacheEngine()
        }
      }
    }
  }
}

def cacheEngine() {
  powershell '''
    rmdir C:/Users/wawa/.m2/repository/.cache/ivy/$env:ivyEngineVersion/* -recurse  
  '''
  bat '''
    mvn clean compile -f AxonIvyPortal/PortalStyle/pom.xml -Divy.engine.directory=C:/Users/wawa/.m2/repository/.cache/ivy/%ivyEngineVersion% %engineDownloadURL%
  '''
}