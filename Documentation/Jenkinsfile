pipeline {
  agent {label 'linux'}

  options {
    buildDiscarder(logRotator(numToKeepStr: '60', artifactNumToKeepStr: '2'))
  }

  triggers {
    cron '@midnight'
  }

  stages {
    stage('build') {
      steps {
        script {
          def version = 'dev'
          docker.withRegistry('', 'docker.io') {
            docker.image('maven:3.6.3-openjdk-17-slim').inside {
              version = getCurrentVersion()
              sh 'mvn clean process-resources -Divy.engine.version=[11.1.0,] -Divy.engine.list.url=https://jenkins.ivyteam.io/job/core_product/job/master/lastSuccessfulBuild/ -f Documentation/public-api/pom.xml'
              sh 'mvn clean generate-resources -f Documentation/pom.xml'
            }
            
            docker.image('axonivy/build-container:read-the-docs-2').inside {
              sh "make -C /doc-build html BASEDIR='${env.WORKSPACE}/Documentation/portal-guide' VERSION=${version}"
            }

            docker.image('maven:3.6.3-openjdk-17-slim').inside {
              def phase = env.BRANCH_NAME == 'master' ? 'deploy' : 'install'
              sh 'mvn clean ${phase} -f Documentation/pom.xml'
            }
          }
        }
        archiveArtifacts 'Documentation/*/build/html/**/*, Documentation/*/target/*.zip'
        recordIssues tools: [sphinxBuild()], unstableTotalAll: 1
      }
    }
  }
}

def getCurrentVersion() {
  def cmd = 'mvn help:evaluate -Dexpression=revision -q -DforceStdout -f Documentation/pom.xml'
  def value = sh (script: cmd, returnStdout: true)
  echo "version is $value"
  if (value == 'null object or invalid expression') {
    throw new Exception('could not evaluate maven revision property');
  }
  return value
}
